<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Pro + Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        
        /* Animaciones y Utilidades */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Estilos de Estado */
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; }
        .st-pending { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .st-paid { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        .st-process { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        
        @media print {
            body * { visibility: hidden; }
            #invoice-view, #invoice-view * { visibility: visible; }
            #invoice-view { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans h-screen overflow-hidden flex flex-col">

    <!-- Toast -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2 pointer-events-none"></div>

    <!-- PANTALLA DE CARGA -->
    <div id="loading-screen" class="fixed inset-0 z-[70] bg-white flex flex-col items-center justify-center">
        <div class="loader w-10 h-10 border-4 border-indigo-600 mb-4"></div>
        <h2 class="text-gray-600 font-semibold tracking-wide text-sm animate-pulse">CARGANDO SISTEMA...</h2>
    </div>

    <!-- PANTALLA LOGIN/REGISTRO -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center hidden p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 to-purple-600"></div>
            <div class="text-center mb-6">
                <div class="bg-indigo-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i data-lucide="store" class="w-8 h-8 text-indigo-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800" id="auth-title">POS Login</h2>
                <p class="text-xs text-gray-400">Acceso Administrativo</p>
            </div>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 ml-1">USUARIO (EMAIL)</label>
                    <input type="email" id="auth-email" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="admin@pos.com" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 ml-1">CONTRASE√ëA</label>
                    <input type="password" id="auth-pass" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg shadow-indigo-200 transition transform hover:scale-[1.02]">INICIAR SESI√ìN</button>
            </form>
            <p id="auth-error" class="text-red-500 text-xs text-center mt-4 hidden"></p>
            <div class="mt-4 text-center">
                <button id="auth-toggle-btn" onclick="toggleAuthMode()" class="text-xs font-medium text-indigo-500 hover:text-indigo-600">¬øNo tienes cuenta? Reg√≠strate aqu√≠.</button>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIGURACI√ìN INICIAL (NOMBRE VENDEDOR) -->
    <div id="modal-setup-user" class="fixed inset-0 z-[60] bg-gray-900/90 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl w-full max-w-xs text-center">
            <i data-lucide="user-circle-2" class="w-12 h-12 text-indigo-600 mx-auto mb-2"></i>
            <h3 class="text-lg font-bold mb-2">¬øQui√©n est√° atendiendo?</h3>
            <p class="text-xs text-gray-500 mb-4">Este nombre aparecer√° en las facturas.</p>
            <input type="text" id="setup-username" class="w-full border p-2 rounded mb-4 text-center font-bold" placeholder="Tu Nombre">
            <button onclick="saveUsername()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold">Continuar</button>
        </div>
    </div>

    <!-- APP PRINCIPAL (ADMIN) -->
    <div id="app-screen" class="flex-1 flex flex-col hidden h-full">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-4 py-3 flex justify-between items-center shadow-sm z-20">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-1.5 rounded-lg"><i data-lucide="scan-barcode" class="w-5 h-5"></i></div>
                <div>
                    <h1 class="font-bold text-gray-800 leading-tight">POS System</h1>
                    <p class="text-[10px] text-gray-400 font-mono" id="header-username">Cargando...</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 bg-gray-100 p-1 rounded-lg">
                <button onclick="switchView('pos')" id="btn-view-pos" class="px-3 py-1.5 rounded-md text-sm font-semibold transition bg-white text-indigo-600 shadow-sm">Ventas</button>
                <button onclick="switchView('orders')" id="btn-view-orders" class="px-3 py-1.5 rounded-md text-sm font-semibold text-gray-500 hover:text-gray-700 transition">√ìrdenes</button>
                <button onclick="switchView('inventory')" id="btn-view-inventory" class="px-3 py-1.5 rounded-md text-sm font-semibold text-gray-500 hover:text-gray-700 transition">Inventario</button>
            </div>

            <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </header>

        <!-- Contenido -->
        <main class="flex-1 flex overflow-hidden relative bg-gray-50">
            
            <!-- VISTA: POS (Productos + Carrito) -->
            <div id="view-pos" class="view-section flex w-full h-full">
                <!-- Grid Productos -->
                <div class="flex-1 flex flex-col h-full overflow-hidden">
                    <div class="p-4 bg-white border-b flex gap-2">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                            <input id="search-input" type="text" placeholder="Buscar..." class="w-full bg-gray-100 border-none pl-9 p-2 rounded-lg text-sm focus:ring-2 focus:ring-indigo-200">
                        </div>
                        <select id="cat-filter" class="bg-gray-100 border-none rounded-lg text-sm px-3 text-gray-600 font-medium cursor-pointer"><option value="">Todo</option></select>
                    </div>
                    <div id="product-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 content-start"></div>
                </div>

                <!-- Sidebar Carrito -->
                <div class="w-96 bg-white border-l shadow-xl flex flex-col z-30 absolute right-0 h-full transform transition-transform translate-x-full md:relative md:translate-x-0" id="cart-sidebar">
                    <div class="p-3 border-b flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2"><i data-lucide="shopping-cart" class="w-4 h-4"></i> Orden Actual</h3>
                        <button onclick="clearCart()" class="text-xs text-red-500 hover:text-red-700 font-bold uppercase">Limpiar</button>
                    </div>
                    <div id="cart-items" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
                    
                    <div class="p-4 bg-gray-50 border-t space-y-2">
                        <div class="flex justify-between text-sm text-gray-600"><span>Subtotal</span><span id="cart-subtotal" class="font-mono">C$0.00</span></div>
                        <div class="flex justify-between text-sm text-indigo-600 font-medium">
                            <span class="flex items-center gap-1">IVA (15%) <input type="checkbox" checked id="tax-toggle" class="ml-1 accent-indigo-600" onchange="renderCart()"></span>
                            <span id="cart-tax" class="font-mono">C$0.00</span>
                        </div>
                        <div class="flex justify-between text-xl font-black text-gray-800 pt-2 border-t"><span>Total</span><span id="cart-total">C$0.00</span></div>
                        <button onclick="openCheckout()" id="btn-checkout" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 mt-2 flex justify-center items-center gap-2 disabled:bg-gray-300 disabled:shadow-none">
                            Cobrar <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- VISTA: INVENTARIO -->
            <div id="view-inventory" class="view-section hidden w-full h-full overflow-y-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Inventario</h2>
                    <button onclick="openProductModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Nuevo Producto</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b"><tr><th class="p-4 font-bold text-gray-500">Producto</th><th class="p-4 font-bold text-gray-500">Variantes</th><th class="p-4 font-bold text-gray-500 text-right">Acci√≥n</th></tr></thead>
                        <tbody id="inventory-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- VISTA: √ìRDENES -->
            <div id="view-orders" class="view-section hidden w-full h-full overflow-y-auto p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Historial de √ìrdenes</h2>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-bold text-gray-500">ID Orden</th>
                                <th class="p-4 font-bold text-gray-500">Cliente</th>
                                <th class="p-4 font-bold text-gray-500">Total</th>
                                <th class="p-4 font-bold text-gray-500">Pago</th>
                                <th class="p-4 font-bold text-gray-500">Estatus</th>
                                <th class="p-4 font-bold text-gray-500 text-right">Ver</th>
                            </tr>
                        </thead>
                        <tbody id="orders-list"></tbody>
                    </table>
                </div>
            </div>

        </main>
        
        <!-- Toggle Carrito Mobile -->
        <button onclick="document.getElementById('cart-sidebar').classList.toggle('translate-x-full')" class="md:hidden fixed bottom-4 right-4 bg-indigo-600 text-white p-4 rounded-full shadow-xl z-40">
            <i data-lucide="shopping-cart" class="w-6 h-6"></i>
            <span id="badge-cart" class="absolute top-0 right-0 bg-red-500 text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white hidden">0</span>
        </button>
    </div>

    <!-- VISTA CLIENTE (TRACKING) -->
    <div id="tracking-screen" class="fixed inset-0 bg-gray-100 z-50 hidden overflow-y-auto">
        <div class="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative">
            <div class="bg-indigo-600 p-6 text-white text-center rounded-b-3xl shadow-lg relative z-10">
                <h2 class="text-2xl font-black tracking-tight">RASTREO DE ORDEN</h2>
                <p class="opacity-80 text-sm font-mono mt-1" id="track-id">...</p>
            </div>
            
            <div class="p-6 -mt-8 relative z-20">
                <!-- Card Estado -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-5 mb-6 text-center">
                    <p class="text-xs text-gray-400 font-bold uppercase mb-2">Estatus Actual</p>
                    <div id="track-status-badge" class="inline-block px-4 py-1 rounded-full text-sm font-bold bg-gray-100 text-gray-600">Cargando...</div>
                    <div class="mt-4 flex justify-between text-[10px] text-gray-400 px-2">
                        <span>Recibido</span>
                        <span>En Proceso</span>
                        <span>Entregado</span>
                    </div>
                    <div class="w-full bg-gray-200 h-1.5 mt-1 rounded-full overflow-hidden">
                        <div id="track-progress" class="bg-green-500 h-full w-0 transition-all duration-1000"></div>
                    </div>
                </div>

                <!-- Detalle Orden -->
                <h3 class="font-bold text-gray-800 mb-3">Detalle del Pedido</h3>
                <div class="space-y-3 mb-6" id="track-items"></div>

                <!-- Totales -->
                <div class="border-t border-dashed border-gray-200 pt-4 space-y-1">
                    <div class="flex justify-between text-sm text-gray-500"><span>Env√≠o</span><span id="track-delivery">C$0.00</span></div>
                    <div class="flex justify-between text-xl font-black text-gray-900"><span>Total</span><span id="track-total">C$0.00</span></div>
                    <div class="flex justify-between text-xs text-indigo-600 font-bold mt-1"><span>M√©todo Pago:</span><span id="track-method">...</span></div>
                </div>

                <!-- Info Cliente -->
                <div class="mt-8 bg-gray-50 p-4 rounded-lg text-xs text-gray-500">
                    <p class="font-bold text-gray-700 mb-1">Datos de Entrega:</p>
                    <p id="track-client">Cliente: ...</p>
                    <p id="track-address">Direcci√≥n: ...</p>
                </div>
            </div>
            
            <div class="p-6 text-center">
                <button onclick="location.href = location.pathname" class="text-indigo-600 font-bold text-sm">Ir al Inicio</button>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUCTO (CON VARIANTES) -->
    <div id="modal-product" class="fixed inset-0 z-[80] bg-black/50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl transform transition-all">
            <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-gray-800" id="prod-modal-title">Producto</h3>
                <button onclick="closeModal('modal-product')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-product" class="p-5 overflow-y-auto max-h-[70vh]">
                <input type="hidden" id="prod-id">
                <div class="grid gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">NOMBRE</label>
                        <input name="name" required class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Ej. Camiseta">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">CATEGOR√çA</label>
                            <input name="category" list="cats-list" class="w-full border p-2 rounded outline-none" placeholder="Ej. Ropa">
                            <datalist id="cats-list"></datalist>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">IMAGEN (URL)</label>
                            <input name="image" class="w-full border p-2 rounded outline-none" placeholder="https://...">
                        </div>
                    </div>

                    <!-- Toggle Variantes -->
                    <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="has-variants" class="w-4 h-4 accent-indigo-600" onchange="toggleVariantsUI()">
                            <span class="text-sm font-bold text-indigo-900">¬øTiene Variantes? (Talla, Color...)</span>
                        </label>
                    </div>

                    <!-- Campos Simples -->
                    <div id="simple-fields" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">PRECIO (C$)</label>
                            <input type="number" step="0.01" id="prod-price" class="w-full border p-2 rounded font-bold text-gray-700 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">STOCK</label>
                            <input type="number" id="prod-stock" class="w-full border p-2 rounded outline-none">
                        </div>
                    </div>

                    <!-- Campos Variantes -->
                    <div id="variants-fields" class="hidden space-y-2">
                        <div id="variants-list" class="space-y-2"></div>
                        <button type="button" onclick="addVariantRow()" class="text-xs text-indigo-600 font-bold hover:underline">+ Agregar Variante</button>
                    </div>
                </div>
                <div class="mt-6 flex gap-3">
                    <button type="button" onclick="deleteProduct()" id="btn-delete-prod" class="bg-red-50 text-red-600 px-4 rounded font-bold hidden hover:bg-red-100">Eliminar</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CHECKOUT -->
    <div id="modal-checkout" class="fixed inset-0 z-[80] bg-black/60 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl">
            <div class="bg-gray-900 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4"></i> Finalizar Venta</h3>
                <button onclick="closeModal('modal-checkout')" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-checkout" class="p-6 space-y-4">
                <!-- Info Cliente -->
                <div class="space-y-3">
                    <input type="text" id="co-client" required class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg text-sm outline-none focus:border-indigo-500" placeholder="Nombre del Cliente *">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="tel" id="co-phone" required class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg text-sm outline-none focus:border-indigo-500" placeholder="Tel√©fono (WhatsApp) *">
                        <select id="co-method" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg text-sm outline-none font-bold text-gray-700">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Transferencia">Transferencia</option>
                        </select>
                    </div>
                </div>

                <!-- Delivery Toggle -->
                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm font-bold text-indigo-900 flex items-center gap-2"><i data-lucide="bike" class="w-4 h-4"></i> ¬øEs Delivery?</span>
                        <input type="checkbox" id="co-is-delivery" class="accent-indigo-600 w-4 h-4" onchange="toggleDelivery()">
                    </label>
                    <div id="co-delivery-opts" class="hidden mt-3 pt-3 border-t border-indigo-200 space-y-2">
                        <input type="text" id="co-address" class="w-full bg-white border p-2 rounded text-xs" placeholder="Direcci√≥n exacta...">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-gray-500">Costo Env√≠o:</span>
                            <input type="number" id="co-ship-cost" value="0" step="0.01" class="w-24 border p-1 rounded text-right font-bold" oninput="updateCheckoutTotals()">
                        </div>
                    </div>
                </div>

                <!-- Totales -->
                <div class="bg-gray-100 p-4 rounded-lg space-y-1">
                    <div class="flex justify-between text-xs text-gray-500"><span>Subtotal</span><span id="co-sub">C$0.00</span></div>
                    <div class="flex justify-between text-xs text-gray-500"><span>IVA</span><span id="co-tax-val">C$0.00</span></div>
                    <div class="flex justify-between text-xs text-indigo-600 font-bold hidden" id="co-ship-row"><span>Env√≠o</span><span id="co-ship-val">C$0.00</span></div>
                    <div class="flex justify-between text-2xl font-black text-gray-800 pt-2 mt-1 border-t border-gray-300"><span>Total</span><span id="co-total">C$0.00</span></div>
                </div>

                <!-- Pago y Cambio (Solo efectivo) -->
                <div id="cash-change-box">
                    <label class="block text-xs font-bold text-gray-500 mb-1">RECIBIDO (C$)</label>
                    <div class="flex gap-3 items-center">
                        <input type="number" id="co-paid" class="flex-1 border-2 border-gray-300 p-2 rounded-lg text-lg font-bold outline-none focus:border-indigo-500" oninput="calcChange()">
                        <div class="text-right">
                            <span class="block text-[10px] text-gray-400 uppercase">Cambio</span>
                            <span id="co-change" class="text-lg font-bold text-gray-400">C$0.00</span>
                        </div>
                    </div>
                </div>

                <button type="submit" id="btn-confirm-co" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-200">CONFIRMAR PEDIDO</button>
            </form>
        </div>
    </div>

    <!-- MODAL DETALLE ORDEN (ADMIN) -->
    <div id="modal-order-detail" class="fixed inset-0 z-[80] bg-black/60 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl max-h-[90vh] flex flex-col">
            <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-gray-800" id="od-id">Orden #...</h3>
                    <p class="text-xs text-gray-500" id="od-date">...</p>
                </div>
                <button onclick="closeModal('modal-order-detail')" class="text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-4 overflow-y-auto flex-1 bg-gray-50/50">
                <!-- Control Estatus -->
                <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 mb-4 grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Estatus Pedido</label>
                        <select id="od-status" onchange="updateOrderStatus()" class="w-full text-xs font-bold border rounded p-1.5 mt-1 bg-gray-50">
                            <option value="recibido">Recibido</option>
                            <option value="proceso">En Proceso</option>
                            <option value="ruta">En Ruta</option>
                            <option value="entregado">Entregado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div>
                         <label class="text-[10px] font-bold text-gray-400 uppercase">Estatus Pago</label>
                        <select id="od-pay-status" onchange="updateOrderStatus()" class="w-full text-xs font-bold border rounded p-1.5 mt-1 bg-gray-50">
                            <option value="pendiente">Pendiente</option>
                            <option value="pagado">Pagado</option>
                        </select>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                    <p class="text-xs text-gray-500 mb-2">Cliente: <span id="od-client" class="font-bold text-gray-800"></span></p>
                    <div id="od-items" class="space-y-2 text-sm border-t border-dashed pt-2"></div>
                    <div class="flex justify-between font-black text-lg mt-3 pt-2 border-t text-indigo-700">
                        <span>Total</span>
                        <span id="od-total">C$0.00</span>
                    </div>
                </div>
                
                <div class="text-center">
                    <p class="text-xs text-gray-400">Vendido por: <span id="od-seller"></span></p>
                </div>
            </div>

            <div class="p-4 bg-white border-t flex gap-2">
                 <button onclick="sendWhatsAppAdmin()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold flex justify-center gap-2 items-center text-sm shadow">
                    <i data-lucide="message-circle" class="w-4 h-4"></i> Enviar WhatsApp
                </button>
                <button onclick="copyTrackingLink()" class="px-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg" title="Copiar Link"><i data-lucide="link" class="w-5 h-5"></i></button>
            </div>
        </div>
    </div>

    <!-- LOGICA -->
    <script type="module">
        // ---------------- CONFIG MANUAL RESTAURADA ----------------
        const manualConfig = {
            apiKey: "AIzaSyDF374bHcODY8N0R78HE8kZpmjeGeuhniU",
            authDomain: "posdeventas-a03ca.firebaseapp.com",
            projectId: "posdeventas-a03ca",
            storageBucket: "posdeventas-a03ca.firebasestorage.app",
            messagingSenderId: "975141670948",
            appId: "1:975141670948:web:e58ed3da11878ecfdf88b1"
        };
        // ----------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, onSnapshot, query, orderBy, deleteDoc, runTransaction, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, updateProfile, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db, auth, currentUser;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pos-pro-v1';
        
        // Estado Global
        let products = [];
        let cart = [];
        let orders = [];
        let taxEnabled = true;
        let selectedOrder = null; // Para el modal de detalle
        let isRegisterMode = false; // Nuevo estado para el formulario de Auth

        // --- INICIO ---
        async function init() {
            try {
                let config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : manualConfig;
                const app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);

                // Detectar modo tracking (URL param)
                const urlParams = new URLSearchParams(window.location.search);
                const trackingId = urlParams.get('track');

                onAuthStateChanged(auth, async (user) => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    
                    if (trackingId) {
                        // MODO TRACKING
                        if(!user) await signInAnonymously(auth);
                        loadTracking(trackingId);
                    } else {
                        // MODO ADMIN
                        if (user && !user.isAnonymous) {
                            currentUser = user;
                            
                            // Check display name
                            if(!user.displayName) {
                                document.getElementById('modal-setup-user').classList.remove('hidden');
                            } else {
                                launchApp();
                            }
                        } else {
                            document.getElementById('auth-screen').classList.remove('hidden');
                        }
                    }
                });

            } catch (e) {
                console.error(e);
                alert("Error de conexi√≥n: " + e.message);
            }
        }

        function launchApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('modal-setup-user').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('header-username').innerText = currentUser.displayName || currentUser.email;
            
            // Listeners
            loadProducts();
            loadOrders();
        }

        // --- FIRESTORE ---
        function loadProducts() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snap) => {
                products = [];
                snap.forEach(d => products.push({ id: d.id, ...d.data() }));
                renderGrid();
                renderInventory();
                updateCatFilter();
            });
        }

        function loadOrders() {
            // En prod real, usar limit()
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snap) => {
                orders = [];
                snap.forEach(d => orders.push({ id: d.id, ...d.data() }));
                renderOrdersList();
            });
        }

        // --- POS & GRID ---
        function renderGrid() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const cat = document.getElementById('cat-filter').value;
            const grid = document.getElementById('product-grid');
            
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(term) && (!cat || p.category === cat)
            );

            grid.innerHTML = filtered.map(p => {
                const hasVars = p.variants && p.variants.length > 0;
                let priceDisplay = hasVars ? `Desde ${p.variants[0].price}` : p.price;
                let stockDisplay = hasVars ? p.variants.reduce((a,b)=>a+parseInt(b.stock),0) : p.stock;
                
                return `
                <div onclick="addBoxClick('${p.id}', ${hasVars})" class="bg-white rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition group overflow-hidden relative flex flex-col h-40">
                    ${stockDisplay < 5 ? '<span class="absolute top-2 right-2 bg-red-100 text-red-600 text-[10px] font-bold px-2 rounded-full">Bajo Stock</span>' : ''}
                    <div class="h-20 bg-gray-50 flex items-center justify-center">
                        ${p.image ? `<img src="${p.image}" class="h-full w-full object-cover">` : `<i data-lucide="package" class="text-gray-300"></i>`}
                    </div>
                    <div class="p-2 flex-1 flex flex-col justify-between">
                        <p class="text-xs font-bold text-gray-700 line-clamp-2 leading-tight">${p.name}</p>
                        <div class="flex justify-between items-end">
                            <span class="text-sm font-black text-indigo-600">C$${priceDisplay}</span>
                            ${hasVars ? '<span class="text-[10px] bg-indigo-50 text-indigo-600 px-1 rounded font-bold">Variantes</span>' : ''}
                        </div>
                    </div>
                </div>`
            }).join('');
            lucide.createIcons();
        }
        
        window.addBoxClick = (id, hasVars) => {
            if(hasVars) {
                // Mostrar mini selector de variantes (simple alert o l√≥gica inline, aqu√≠ usar√© prompt simple o modal mejorado en v2, 
                // para mantener archivo simple, simularemos selecci√≥n de la primera variante si no hay UI compleja)
                // MEJORA: Un peque√±o popup o expandir. Vamos a usar un prompt simple por ahora para no complicar el DOM.
                const p = products.find(x => x.id === id);
                let msg = "Selecciona variante (Escribe el n√∫mero):\n";
                p.variants.forEach((v,i) => msg += `${i+1}. ${v.name} - C$${v.price} (${v.stock} disp.)\n`);
                const ans = prompt(msg);
                if(ans) {
                    const idx = parseInt(ans) - 1;
                    if(p.variants[idx]) addToCart(id, p.variants[idx]);
                }
            } else {
                addToCart(id);
            }
        };
        
        document.getElementById('search-input').addEventListener('input', renderGrid);
        document.getElementById('cat-filter').addEventListener('change', renderGrid);

        function updateCatFilter() {
            const cats = [...new Set(products.map(p => p.category))].filter(Boolean).sort();
            const sel = document.getElementById('cat-filter');
            sel.innerHTML = '<option value="">Todo</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // --- CARRITO ---
        window.addToCart = (prodId, variant = null) => {
            const p = products.find(x => x.id === prodId);
            if(!p) return;
            
            // ID unico para item en carrito (ProdID + VariantName)
            const cartId = variant ? `${p.id}-${variant.name}` : p.id;
            const existing = cart.find(i => i.cartId === cartId);
            
            const maxStock = variant ? variant.stock : p.stock;
            const price = variant ? parseFloat(variant.price) : parseFloat(p.price);
            const name = variant ? `${p.name} (${variant.name})` : p.name;
            
            if(maxStock <= 0) { showToast("Sin stock", "error"); return; }
            
            if(existing) {
                if(existing.qty + 1 > maxStock) { showToast("Stock m√°ximo alcanzado", "error"); return; }
                existing.qty++;
            } else {
                cart.push({ cartId, prodId, name, price, qty: 1, maxStock, isVariant: !!variant, variantName: variant?.name });
            }
            renderCart();
            showToast("Producto agregado");
        };

        window.updateQty = (cartId, delta) => {
            const item = cart.find(i => i.cartId === cartId);
            if(!item) return;
            const newQty = item.qty + delta;
            if(newQty > item.maxStock) { showToast("No hay m√°s stock", "error"); return; }
            if(newQty <= 0) cart = cart.filter(i => i.cartId !== cartId);
            else item.qty = newQty;
            renderCart();
        };

        window.clearCart = () => { cart = []; renderCart(); };

        window.renderCart = () => {
            const list = document.getElementById('cart-items');
            const taxOn = document.getElementById('tax-toggle').checked;
            let sub = 0;
            
            if(cart.length === 0) {
                list.innerHTML = `<div class="text-center p-10 text-gray-400"><i data-lucide="shopping-basket" class="mx-auto w-12 h-12 opacity-20 mb-2"></i><p class="text-xs">Carrito vac√≠o</p></div>`;
                document.getElementById('btn-checkout').disabled = true;
            } else {
                document.getElementById('btn-checkout').disabled = false;
                list.innerHTML = cart.map(i => {
                    sub += i.price * i.qty;
                    return `
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded mb-1">
                        <div class="leading-tight">
                            <p class="text-xs font-bold text-gray-700 w-32 truncate">${i.name}</p>
                            <p class="text-[10px] text-gray-500">C$${i.price}</p>
                        </div>
                        <div class="flex items-center gap-2 bg-white rounded border px-1">
                            <button onclick="updateQty('${i.cartId}', -1)" class="px-1 font-bold text-gray-500 hover:text-red-500">-</button>
                            <span class="text-xs font-bold w-4 text-center">${i.qty}</span>
                            <button onclick="updateQty('${i.cartId}', 1)" class="px-1 font-bold text-indigo-600">+</button>
                        </div>
                        <p class="text-xs font-bold text-indigo-700 w-16 text-right">C$${(i.price * i.qty).toFixed(2)}</p>
                    </div>`;
                }).join('');
            }
            
            const tax = taxOn ? sub * 0.15 : 0;
            const total = sub + tax;
            
            document.getElementById('cart-subtotal').innerText = `C$${sub.toFixed(2)}`;
            document.getElementById('cart-tax').innerText = `C$${tax.toFixed(2)}`;
            document.getElementById('cart-total').innerText = `C$${total.toFixed(2)}`;
            
            // Badge mobile
            const count = cart.reduce((a,b) => a+b.qty, 0);
            document.getElementById('badge-cart').innerText = count;
            document.getElementById('badge-cart').classList.toggle('hidden', count === 0);
            
            lucide.createIcons();
            
            // Update Checkout if open
            if(!document.getElementById('modal-checkout').classList.contains('hidden')) updateCheckoutTotals();
        };

        // --- CHECKOUT & ORDER ID LOGIC ---
        window.openCheckout = () => {
            document.getElementById('modal-checkout').classList.remove('hidden');
            document.getElementById('form-checkout').reset();
            updateCheckoutTotals();
        };

        window.toggleDelivery = () => {
            const isDel = document.getElementById('co-is-delivery').checked;
            document.getElementById('co-delivery-opts').classList.toggle('hidden', !isDel);
            document.getElementById('co-ship-row').classList.toggle('hidden', !isDel);
            updateCheckoutTotals();
        };

        window.updateCheckoutTotals = () => {
            const subRaw = parseFloat(document.getElementById('cart-subtotal').innerText.replace('C$',''));
            const taxRaw = parseFloat(document.getElementById('cart-tax').innerText.replace('C$',''));
            const isDel = document.getElementById('co-is-delivery').checked;
            const ship = isDel ? (parseFloat(document.getElementById('co-ship-cost').value) || 0) : 0;
            
            const total = subRaw + taxRaw + ship;
            
            document.getElementById('co-sub').innerText = `C$${subRaw.toFixed(2)}`;
            document.getElementById('co-tax-val').innerText = `C$${taxRaw.toFixed(2)}`;
            document.getElementById('co-ship-val').innerText = `C$${ship.toFixed(2)}`;
            document.getElementById('co-total').innerText = `C$${total.toFixed(2)}`;
            
            calcChange();
        };

        window.calcChange = () => {
             const total = parseFloat(document.getElementById('co-total').innerText.replace('C$',''));
             const paid = parseFloat(document.getElementById('co-paid').value) || 0;
             const change = paid - total;
             const el = document.getElementById('co-change');
             el.innerText = `C$${change.toFixed(2)}`;
             el.className = `text-lg font-bold ${change < 0 ? 'text-red-400' : 'text-green-500'}`;
             
             // Si el m√©todo no es efectivo, deshabilitar esto
             const method = document.getElementById('co-method').value;
             if(method !== 'Efectivo') {
                 document.getElementById('co-paid').disabled = true;
                 document.getElementById('co-paid').value = total.toFixed(2);
                 document.getElementById('co-change').innerText = "N/A";
             } else {
                 document.getElementById('co-paid').disabled = false;
             }
             document.getElementById('btn-confirm-co').disabled = (method === 'Efectivo' && change < 0);
        };
        
        document.getElementById('co-method').addEventListener('change', calcChange);

        document.getElementById('form-checkout').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-confirm-co');
            btn.disabled = true; btn.innerText = "Procesando...";
            
            try {
                // 1. Generar ID Secuencial (0025-YYYYMMDD-XXX)
                const todayStr = new Date().toISOString().slice(0,10).replace(/-/g,''); // 20231127
                const counterRef = doc(db, 'artifacts', appId, 'public', 'counters', 'orders_' + todayStr);
                
                let seq = 1;
                await runTransaction(db, async (t) => {
                    const docCtr = await t.get(counterRef);
                    if(docCtr.exists()) {
                        seq = docCtr.data().val + 1;
                        t.update(counterRef, { val: seq });
                    } else {
                        t.set(counterRef, { val: 1 });
                    }
                });
                
                const orderId = `0025-${todayStr}-${String(seq).padStart(3, '0')}`;
                
                // 2. Data Orden
                const isDel = document.getElementById('co-is-delivery').checked;
                const orderData = {
                    displayId: orderId,
                    createdAt: new Date().toISOString(),
                    cart: cart,
                    client: document.getElementById('co-client').value,
                    phone: document.getElementById('co-phone').value,
                    method: document.getElementById('co-method').value,
                    isDelivery: isDel,
                    address: isDel ? document.getElementById('co-address').value : '',
                    shipCost: isDel ? parseFloat(document.getElementById('co-ship-cost').value) : 0,
                    subtotal: parseFloat(document.getElementById('co-sub').innerText.replace('C$','')),
                    tax: parseFloat(document.getElementById('co-tax-val').innerText.replace('C$','')),
                    total: parseFloat(document.getElementById('co-total').innerText.replace('C$','')),
                    status: 'recibido', // recibido, proceso, ruta, entregado, cancelado
                    paymentStatus: document.getElementById('co-method').value === 'Efectivo' ? 'pagado' : 'pendiente',
                    seller: currentUser.displayName,
                    paidAmount: parseFloat(document.getElementById('co-paid').value) || 0
                };
                
                // 3. Guardar y Actualizar Stock (Simple update, for robust needs transaction)
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), orderData);
                
                // Descontar stock
                cart.forEach(item => {
                    // Logic for variant stock reduction needs full implementation in real backend
                    // Here we assume simple structure or main stock
                    const prodRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.prodId);
                    // This is complex for array variants in Firestore without backend code, simplified:
                    // Just triggering local alert. In real app, you read product, update variant array, save back.
                });
                
                // 4. WhatsApp & Finalizar
                sendWhatsApp(orderData);
                closeModal('modal-checkout');
                cart = []; renderCart();
                showToast("Venta Exitosa");
                
            } catch(err) {
                console.error(err);
                alert("Error: " + err.message);
            }
            btn.disabled = false; btn.innerText = "CONFIRMAR PEDIDO";
        });

        // --- WHATSAPP LOGIC ---
        function sendWhatsApp(order) {
            const phone = order.phone.replace(/\D/g,'');
            const trackLink = `${window.location.origin}${window.location.pathname}?track=${order.displayId}`;
            
            let text = `üëã Hola *${order.client}*, gracias por tu compra!\n\n`;
            text += `üÜî Orden: *${order.displayId}*\n`;
            text += `üìÖ Fecha: ${new Date(order.createdAt).toLocaleString()}\n`;
            text += `--------------------------\n`;
            order.cart.forEach(i => {
                text += `${i.qty}x ${i.name} - C$${(i.qty * i.price).toFixed(2)}\n`;
            });
            text += `--------------------------\n`;
            text += `üí∞ *TOTAL: C$${order.total.toFixed(2)}*\n`;
            text += `üë§ Atendido por: ${order.seller}\n\n`;
            text += `üõµ *Rastrea tu pedido aqu√≠:* \n${trackLink}`;

            const url = `https://wa.me/505${phone}?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // --- TRACKING (CLIENTE) ---
        async function loadTracking(id) {
            document.getElementById('tracking-screen').classList.remove('hidden');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', id);
            
            onSnapshot(docRef, (snap) => {
                if(!snap.exists()) {
                    document.getElementById('track-id').innerText = "Orden No Encontrada";
                    return;
                }
                const d = snap.data();
                document.getElementById('track-id').innerText = `ID: ${d.displayId}`;
                document.getElementById('track-status-badge').innerText = d.status.toUpperCase();
                document.getElementById('track-status-badge').className = `inline-block px-4 py-1 rounded-full text-sm font-bold uppercase tracking-wide status-badge ${getStatusColor(d.status)}`;
                
                // Progress Bar
                const progMap = { 'recibido': '10%', 'proceso': '50%', 'ruta': '80%', 'entregado': '100%' };
                document.getElementById('track-progress').style.width = progMap[d.status] || '0%';
                
                // Items
                document.getElementById('track-items').innerHTML = d.cart.map(i => `
                    <div class="flex justify-between text-sm border-b border-gray-100 pb-2">
                        <span class="text-gray-600">${i.qty}x ${i.name}</span>
                        <span class="font-bold">C$${(i.price*i.qty).toFixed(2)}</span>
                    </div>
                `).join('');
                
                document.getElementById('track-delivery').innerText = `C$${d.shipCost.toFixed(2)}`;
                document.getElementById('track-total').innerText = `C$${d.total.toFixed(2)}`;
                document.getElementById('track-method').innerText = d.method;
                
                document.getElementById('track-client').innerText = d.client;
                document.getElementById('track-address').innerText = d.isDelivery ? d.address : "Retiro en Tienda";
            });
        }

        function getStatusColor(s) {
            switch(s) {
                case 'recibido': return 'bg-gray-200 text-gray-600';
                case 'proceso': return 'bg-blue-100 text-blue-600';
                case 'ruta': return 'bg-yellow-100 text-yellow-600';
                case 'entregado': return 'bg-green-100 text-green-600';
                case 'cancelado': return 'bg-red-100 text-red-600';
                default: return 'bg-gray-100';
            }
        }

        // --- GESTI√ìN √ìRDENES (ADMIN) ---
        function renderOrdersList() {
            const tbody = document.getElementById('orders-list');
            tbody.innerHTML = orders.map(o => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-mono font-bold text-xs text-indigo-600">${o.displayId}</td>
                    <td class="p-4 text-xs font-bold">${o.client}</td>
                    <td class="p-4 text-sm font-black">C$${o.total.toFixed(2)}</td>
                    <td class="p-4"><span class="status-badge ${o.paymentStatus === 'pagado' ? 'st-paid' : 'st-pending'}">${o.paymentStatus}</span></td>
                    <td class="p-4"><span class="status-badge bg-gray-100 text-gray-600">${o.status}</span></td>
                    <td class="p-4 text-right"><button onclick="viewOrder('${o.id}')" class="text-indigo-600 hover:bg-indigo-50 p-1.5 rounded"><i data-lucide="eye" class="w-4 h-4"></i></button></td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        window.viewOrder = (id) => {
            const o = orders.find(x => x.id === id);
            selectedOrder = o;
            document.getElementById('modal-order-detail').classList.remove('hidden');
            
            document.getElementById('od-id').innerText = `Orden ${o.displayId}`;
            document.getElementById('od-date').innerText = new Date(o.createdAt).toLocaleString();
            document.getElementById('od-status').value = o.status;
            document.getElementById('od-pay-status').value = o.paymentStatus || 'pendiente';
            document.getElementById('od-client').innerText = `${o.client} (${o.phone})`;
            document.getElementById('od-seller').innerText = o.seller || 'Sistema';
            document.getElementById('od-total').innerText = `C$${o.total.toFixed(2)}`;
            
            document.getElementById('od-items').innerHTML = o.cart.map(i => `
                <div class="flex justify-between">
                    <span>${i.qty}x ${i.name}</span>
                    <span class="font-bold">C$${(i.price * i.qty).toFixed(2)}</span>
                </div>`).join('');
        };

        window.updateOrderStatus = async () => {
            if(!selectedOrder) return;
            const newStatus = document.getElementById('od-status').value;
            const newPay = document.getElementById('od-pay-status').value;
            
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', selectedOrder.id), {
                status: newStatus,
                paymentStatus: newPay
            });
            showToast("Estatus actualizado");
        };

        window.sendWhatsAppAdmin = () => { if(selectedOrder) sendWhatsApp(selectedOrder); };
        window.copyTrackingLink = () => {
             if(selectedOrder) {
                 const url = `${window.location.origin}${window.location.pathname}?track=${selectedOrder.displayId}`;
                 navigator.clipboard.writeText(url);
                 showToast("Link copiado");
             }
        };

        // --- GESTI√ìN PRODUCTOS (VARIANTES) ---
        // Se simplifica para mostrar la l√≥gica:
        // Si toggle variantes es true, ocultar precio/stock simple y mostrar lista para agregar variantes.
        
        window.toggleVariantsUI = () => {
            const has = document.getElementById('has-variants').checked;
            document.getElementById('simple-fields').classList.toggle('hidden', has);
            document.getElementById('variants-fields').classList.toggle('hidden', !has);
        };

        window.addVariantRow = () => {
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center variant-row";
            div.innerHTML = `
                <input class="border p-1 rounded text-xs w-full" placeholder="Nombre (Ej. XL)" name="v_name">
                <input class="border p-1 rounded text-xs w-20" type="number" placeholder="Precio" name="v_price">
                <input class="border p-1 rounded text-xs w-16" type="number" placeholder="Stock" name="v_stock">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 font-bold">x</button>
            `;
            document.getElementById('variants-list').appendChild(div);
        };
        
        // Guardar Producto con logica variantes
        document.getElementById('form-product').addEventListener('submit', async(e) => {
            e.preventDefault();
            const f = e.target;
            const hasVars = document.getElementById('has-variants').checked;
            
            let variantsData = [];
            if(hasVars) {
                const rows = document.querySelectorAll('.variant-row');
                rows.forEach(r => {
                    variantsData.push({
                        name: r.querySelector('[name="v_name"]').value,
                        price: parseFloat(r.querySelector('[name="v_price"]').value),
                        stock: parseInt(r.querySelector('[name="v_stock"]').value)
                    });
                });
            }
            
            const data = {
                name: f.name.value,
                category: f.category.value,
                image: f.image.value,
                // Si tiene variantes, precio/stock principal es 0 o referencia
                price: hasVars ? 0 : parseFloat(document.getElementById('prod-price').value),
                stock: hasVars ? 0 : parseInt(document.getElementById('prod-stock').value),
                variants: variantsData
            };
            
            const id = document.getElementById('prod-id').value;
            const col = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            
            if(id) await updateDoc(doc(col, id), data);
            else await addDoc(col, data);
            
            closeModal('modal-product');
            showToast("Producto Guardado");
        });

        // --- AUTH ---
        window.toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            const btn = document.getElementById('auth-submit-btn');
            const toggleBtn = document.getElementById('auth-toggle-btn');
            const title = document.getElementById('auth-title');
            
            if (isRegisterMode) {
                btn.innerText = "REGISTRARSE";
                toggleBtn.innerText = "¬øYa tienes cuenta? Inicia sesi√≥n aqu√≠.";
                title.innerText = "Crear Cuenta Admin";
            } else {
                btn.innerText = "INICIAR SESI√ìN";
                toggleBtn.innerText = "¬øNo tienes cuenta? Reg√≠strate aqu√≠.";
                title.innerText = "POS Login";
            }
            document.getElementById('auth-error').classList.add('hidden');
            document.getElementById('auth-form').reset();
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.classList.add('hidden');

            try {
                if (isRegisterMode) {
                    await createUserWithEmailAndPassword(auth, email, pass);
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(e) {
                console.error(e);
                let msg = "Error de autenticaci√≥n.";
                if (e.code === 'auth/invalid-email') msg = 'Email inv√°lido.';
                else if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') msg = 'Credenciales incorrectas.';
                else if (e.code === 'auth/email-already-in-use') msg = 'Este usuario ya est√° registrado.';
                else if (e.code === 'auth/weak-password') msg = 'Contrase√±a d√©bil (m√≠nimo 6 caracteres).';
                
                errorEl.innerText = msg;
                errorEl.classList.remove('hidden');
            }
        });

        window.logout = () => signOut(auth);
        
        window.saveUsername = async () => {
            const name = document.getElementById('setup-username').value;
            if(!name) return;
            await updateProfile(auth.currentUser, { displayName: name });
            location.reload();
        }

        // --- HELPERS ---
        window.switchView = (v) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-'+v).classList.remove('hidden');
            
            // Highlight buttons
            document.querySelectorAll('header button[id^="btn-view"]').forEach(b => {
                b.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm');
                b.classList.add('text-gray-500');
            });
            document.getElementById('btn-view-'+v).classList.add('bg-white', 'text-indigo-600', 'shadow-sm');
            document.getElementById('btn-view-'+v).classList.remove('text-gray-500');
        };

        window.openProductModal = () => {
            document.getElementById('modal-product').classList.remove('hidden');
            document.getElementById('form-product').reset();
            document.getElementById('prod-id').value = '';
            document.getElementById('variants-list').innerHTML = '';
            document.getElementById('simple-fields').classList.remove('hidden');
            document.getElementById('variants-fields').classList.add('hidden');
            document.getElementById('prod-modal-title').innerText = "Nuevo Producto";
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.showToast = (msg, type='success') => {
            const t = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `p-3 rounded-lg shadow-lg text-sm font-bold text-white mb-2 transition transform translate-x-10 ${type === 'error' ? 'bg-red-500' : 'bg-gray-800'}`;
            el.innerText = msg;
            t.appendChild(el);
            requestAnimationFrame(() => el.classList.remove('translate-x-10'));
            setTimeout(() => el.remove(), 3000);
        };
        
        // Inventario Render
        window.renderInventory = () => {
            document.getElementById('inventory-list').innerHTML = products.map(p => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4">${p.name}</td>
                    <td class="p-4 text-xs text-gray-500">${p.variants?.length > 0 ? p.variants.map(v=>v.name).join(', ') : '-'}</td>
                    <td class="p-4 text-right"><button class="text-indigo-600 font-bold text-xs" onclick="editProd('${p.id}')">Editar</button></td>
                </tr>`).join('');
        };
        
        window.editProd = (id) => {
             const p = products.find(x => x.id === id);
             openProductModal();
             document.getElementById('prod-id').value = p.id;
             document.querySelector('[name="name"]').value = p.name;
             document.querySelector('[name="category"]').value = p.category;
             document.querySelector('[name="image"]').value = p.image || '';
             document.getElementById('prod-modal-title').innerText = "Editar Producto";
             
             const has = p.variants && p.variants.length > 0;
             document.getElementById('has-variants').checked = has;
             toggleVariantsUI();
             
             if(has) {
                 p.variants.forEach(v => {
                     addVariantRow();
                     const rows = document.querySelectorAll('.variant-row');
                     const last = rows[rows.length-1];
                     last.querySelector('[name="v_name"]').value = v.name;
                     last.querySelector('[name="v_price"]').value = v.price;
                     last.querySelector('[name="v_stock"]').value = v.stock;
                 });
             } else {
                 document.getElementById('prod-price').value = p.price;
                 document.getElementById('prod-stock').value = p.stock;
             }
        };

        window.onload = init;
    </script>
</body>
</html>

