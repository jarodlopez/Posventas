<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Homemart PRO - Punto de Venta</title>
  <meta name="description" content="Sistema POS profesional para Homemart - Ferretería y Hogar"/>

  <!-- Tailwind + FontAwesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase v8 CDN (global namespace) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- ESC/POS for thermal printers -->
  <script src="https://unpkg.com/escpos-web@1.0.2/dist/escpos.min.js"></script>

  <style>
    body { font-family: 'Inter', system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // Firebase Config (v8 global)
    const firebaseConfig = {
      apiKey: "AIzaSyDF374bHcODY8N0R78HE8kZpmjeGeuhniU",
      authDomain: "posdeventas-a03ca.firebaseapp.com",
      projectId: "posdeventas-a03ca",
      storageBucket: "posdeventas-a03ca.firebasestorage.app",
      messagingSenderId: "975141670948",
      appId: "1:975141670948:web:e58ed3da11878ecfdf88b1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const { useState, useEffect, useMemo, useRef } = React;

    // ==== COMPONENTES REUTILIZABLES ====
    const Icon = ({ name, size = 20 }) => {
      const icons = {
        cart: "fa-cart-shopping", box: "fa-box", history: "fa-clock-rotate-left",
        chart: "fa-chart-line", lock: "fa-lock", unlock: "fa-lock-open", plus: "fa-plus",
        trash: "fa-trash", search: "fa-magnifying-glass", whatsapp: "fa-whatsapp",
        dollar: "fa-dollar-sign", truck: "fa-truck-fast", user: "fa-user", logout: "fa-right-from-bracket",
        receipt: "fa-receipt", tag: "fa-tag", print: "fa-print", filter: "fa-filter"
      };
      return <i className={`fa-solid \( {icons[name] || 'fa-circle'} text- \){size}px`}></i>;
    };

    const Button = ({ children, onClick, variant = "primary", icon, disabled, className = "" }) => {
      const variants = {
        primary: "bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white shadow-lg",
        success: "bg-green-600 hover:bg-green-700 text-white",
        danger: "bg-red-600 hover:bg-red-700 text-white",
        outline: "border-2 border-white/30 hover:bg-white/10 text-white backdrop-blur"
      };
      return (
        <button onClick={onClick} disabled={disabled}
          className={`px-5 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all \( {variants[variant]} disabled:opacity-50 \){className}`}>
          {icon && <Icon name={icon} />}
          {children}
        </button>
      );
    };

    const Input = ({ label, ...props }) => (
      <div className="flex flex-col gap-1">
        {label && <label className="text-sm font-medium text-gray-300">{label}</label>}
        <input className="px-4 py-3 rounded-xl bg-white/20 backdrop-blur text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white" {...props} />
      </div>
    );

    // ==== APP PRINCIPAL ====
    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [view, setView] = useState('pos');
      const [products, setProducts] = useState([]);
      const [sales, setSales] = useState([]);
      const [shift, setShift] = useState(null);
      const [customerOrder, setCustomerOrder] = useState(null);
      const [isCustomerView, setIsCustomerView] = useState(false);

      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('orderId');

        if (orderId) {
          setIsCustomerView(true);
          loadCustomerOrder(orderId);
        } else {
          const unsubscribe = auth.onAuthStateChanged(async (u) => {
            setUser(u);
            if (u) {
              loadData();
              checkShift(u.uid);
            }
            setLoading(false);
          });
          return unsubscribe;
        }
      }, []);

      const loadCustomerOrder = async (id) => {
        try {
          await auth.signInAnonymously();
          const docSnap = await db.collection("sales").doc(id).get();
          if (docSnap.exists) setCustomerOrder({ id: docSnap.id, ...docSnap.data(), date: docSnap.data().date?.toDate() });
          else Swal.fire("Error", "Orden no encontrada", "error");
        } catch (e) { console.error(e); }
        setLoading(false);
      };

      const loadData = () => {
        db.collection("products").onSnapshot(s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()}))));
        db.collection("sales").orderBy("date", "desc").onSnapshot(s => setSales(s.docs.map(d => ({id:d.id, ...d.data(), date: d.data().date?.toDate()}))));
      };

      const checkShift = async (uid) => {
        const snap = await db.collection("shifts").where("status","==","open").where("userId","==",uid).get();
        setShift(snap.empty ? null : { id: snap.docs[0].id, ...snap.docs[0].data() });
      };

      if (loading) return <div className="fixed inset-0 glass flex items-center justify-center text-white text-3xl font-bold">Cargando Homemart PRO...</div>;
      if (isCustomerView) return <CustomerView order={customerOrder} />;
      if (!user) return <Login />;

      return (
        <div className="min-h-screen flex">
          {/* Sidebar */}
          <aside className="w-20 lg:w-64 bg-gradient-to-b from-indigo-800 to-purple-900 text-white flex flex-col">
            <div className="p-6 text-center lg:text-left">
              <h1 className="text-2xl font-bold">Homemart</h1>
              <p className="text-xs opacity-80 hidden lg:block">Ferretería • Hogar • Construcción</p>
            </div>
            <nav className="flex-1 px-4">
              {[
                {v:'pos',i:'cart',l:'Venta'},
                {v:'products',i:'box',l:'Productos'},
                {v:'history',i:'history',l:'Historial'},
                {v:'dashboard',i:'chart',l:'Reportes'},
                {v:'shift',i:'lock',l:'Caja'}
              ].map(item => (
                <button key={item.v} onClick={()=>setView(item.v)}
                  className={`w-full flex items-center gap-4 p-4 rounded-xl mb-2 transition-all ${view===item.v ? 'bg-white/20 font-bold' : 'hover:bg-white/10'}`}>
                  <Icon name={item.i} size={24} />
                  <span className="hidden lg:block">{item.l}</span>
                </button>
              ))}
            </nav>
            <div className="p-4 border-t border-white/20">
              <p className="hidden lg:block text-sm opacity-90">{user.email}</p>
              <button onClick={()=>auth.signOut()} className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 text-sm">
                <Icon name="logout" /> <span className="hidden lg:block">Salir</span>
              </button>
            </div>
          </aside>

          {/* Main */}
          <main className="flex-1 p-6 overflow-y-auto">
            {view === 'pos' && !shift ? <OpenShift user={user} onOpen={checkShift} /> : (
              <div className="glass rounded-3xl p-8">
                {view === 'pos' && <POSModule products={products} shift={shift} user={user} />}
                {view === 'products' && <Inventory products={products} />}
                {view === 'history' && <HistoryView sales={sales} />}
                {view === 'dashboard' && <Dashboard sales={sales} products={products} />}
                {view === 'shift' && <ShiftControl shift={shift} onUpdate={()=>checkShift(user.uid)} />}
              </div>
            )}
          </main>
        </div>
      );
    }

    // ==== VISTA CLIENTE ====
    const CustomerView = ({ order }) => (
      <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center p-6">
        <div className="glass rounded-3xl shadow-2xl max-w-md w-full p-8 text-center text-white">
          <h1 className="text-4xl font-bold mb-2">Homemart</h1>
          <p className="text-white/80 mb-8">Detalle de tu orden</p>
          <p className="text-5xl font-bold mb-6">${order?.total.toFixed(2)}</p>
          <div className="space-y-4 text-left">
            {order?.items.map((i, idx) => (
              <div key={idx} className="flex justify-between border-b border-white/20 pb-2">
                <span>{i.qty}x {i.name} {i.variantName ? `(${i.variantName})` : ''}</span>
                <span>${(i.price * i.qty).toFixed(2)}</span>
              </div>
            ))}
            {order.deliveryFee > 0 && <div className="flex justify-between pt-2 border-t border-white/20">
              <span>Envío</span><span>${order.deliveryFee.toFixed(2)}</span>
            </div>}
            <div className="pt-4 text-right font-bold text-xl">Total: ${order.total.toFixed(2)}</div>
          </div>
          <p className="mt-8 text-sm opacity-80">Estado: {order.paymentStatus}</p>
        </div>
      </div>
    );

    // ==== LOGIN ====
    const Login = () => {
      const [email, setEmail] = useState("");
      const [pass, setPass] = useState("");
      const login = (e) => {
        e.preventDefault();
        auth.signInWithEmailAndPassword(email, pass).catch(() => Swal.fire("Error", "Credenciales incorrectas", "error"));
      };
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="glass rounded-3xl shadow-2xl p-10 max-w-md w-full text-white">
            <h1 className="text-4xl font-bold mb-2 text-center">Homemart PRO</h1>
            <p className="text-center mb-8 opacity-80">Sistema de Punto de Venta</p>
            <form onSubmit={login} className="space-y-6">
              <Input placeholder="Email" type="email" value={email} onChange={e=>setEmail(e.target.value)} />
              <Input placeholder="Contraseña" type="password" value={pass} onChange={e=>setPass(e.target.value)} />
              <Button type="submit" className="w-full">Iniciar Sesión</Button>
            </form>
          </div>
        </div>
      );
    };

    // ==== POS MODULE (con variantes, descuentos, delivery, impresión) ====
    function POSModule({ products, shift, user }) {
      const [cart, setCart] = useState([]);
      const [search, setSearch] = useState("");
      const [delivery, setDelivery] = useState(0);
      const [discount, setDiscount] = useState(0);
      const [selProd, setSelProd] = useState(null);
      const [loading, setLoading] = useState(false);

      const addToCart = (p, variant = null) => {
        const stock = variant ? variant.stock : p.stock;
        if (stock <= 0) return Swal.fire("Error", "Sin stock", "error");

        const cartId = variant ? `\( {p.id}- \){variant.name}` : p.id;
        const exists = cart.find(x => x.cartId === cartId);

        if (exists) {
          if (exists.qty + 1 > stock) return Swal.fire("Error", "Stock insuficiente", "error");
          setCart(cart.map(x => x.cartId === cartId ? {...x, qty: x.qty + 1} : x));
        } else {
          setCart([...cart, {
            cartId, id: p.id, name: p.name, variantName: variant?.name,
            price: variant?.price || p.price, cost: variant?.cost || p.cost,
            qty: 1
          }]);
        }
      };

      const subtotal = cart.reduce((acc, el) => acc + (el.price * el.qty), 0);
      const total = (subtotal * (1 - discount / 100)) + parseFloat(delivery || 0);

      const printTicket = (sale) => {
        try {
          const printer = new escpos.Printer();
          printer.align('ct').text('Homemart PRO');
          printer.text('-----------------------------');
          sale.items.forEach(i => {
            printer.text(`\( {i.qty}x \){i.name} ${i.variantName || ''} \[ {i.price.toFixed(2)}`);
          });
          printer.text('-----------------------------');
          printer.text(`Subtotal: \]{subtotal.toFixed(2)}`);
          if (discount > 0) printer.text(`Descuento: ${discount}%`);
          if (delivery > 0) printer.text(`Envío: \[ {delivery.toFixed(2)}`);
          printer.text(`TOTAL: \]{total.toFixed(2)}`);
          printer.cut().close();
        } catch (e) { Swal.fire("Error", "Impresora no conectada", "error"); }
      };

      const checkout = async (method) => {
        setLoading(true);
        try {
          const sale = {
            date: firebase.firestore.Timestamp.now(),
            shiftId: shift.id,
            cashierId: user.uid,
            items: cart,
            subtotal,
            discount,
            deliveryFee: parseFloat(delivery || 0),
            total,
            paymentStatus: method === 'whatsapp' ? 'Pendiente' : 'Pagado',
            method
          };
          const saleRef = await db.collection("sales").add(sale);

          cart.forEach(async (item) => {
            await db.collection("products").doc(item.id).update({ stock: firebase.firestore.FieldValue.increment(-item.qty) });
          });

          if (method !== 'whatsapp') {
            printTicket(sale);
            Swal.fire("Éxito", "Venta registrada!", "success");
          } else {
            const link = `\( {window.location.origin} \){window.location.pathname}?orderId=${saleRef.id}`;
            const msg = `*Pedido Homemart PRO*\n\n\( {cart.map(i=>` \){i.qty}x \( {i.name} \){i.variantName ? '('+i.variantName+')' : ''} - \[ {(i.price*i.qty).toFixed(2)}`).join('\n')}\n\nEnvío: \]{delivery.toFixed(2)}\nDescuento: ${discount}%\n*Total: $${total.toFixed(2)}*\n\nVer: ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
          }
          setCart([]); setDelivery(0); setDiscount(0);
        } catch (e) { console.error(e); Swal.fire("Error", "No se pudo registrar la venta", "error"); }
        setLoading(false);
      };

      return (
        <div className="flex flex-col lg:flex-row gap-6">
          {/* Productos */}
          <div className="flex-1">
            <Input placeholder="Buscar productos..." value={search} onChange={e=>setSearch(e.target.value)} />
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4 scrollbar-hide overflow-y-auto max-h-[70vh]">
              {products.filter(p=>p.name.toLowerCase().includes(search.toLowerCase())).map(p => (
                <button key={p.id} onClick={()=>p.variants?.length ? setSelProd(p) : addToCart(p)}
                  className="glass p-4 rounded-xl hover:shadow-xl transition-all text-white text-left">
                  <h3 className="font-bold mb-2">{p.name}</h3>
                  <p className="text-sm opacity-80">Stock: {p.stock}</p>
                  <p className="text-lg font-bold mt-2">${p.price.toFixed(2)}</p>
                </button>
              ))}
            </div>
          </div>

          {/* Carrito */}
          <div className="lg:w-96 glass rounded-xl p-6">
            <h2 className="text-xl font-bold mb-4 text-white">Orden Actual</h2>
            <div className="space-y-3 max-h-64 overflow-y-auto">
              {cart.map(i => (
                <div key={i.cartId} className="flex justify-between text-white">
                  <span>{i.qty}x {i.name} {i.variantName}</span>
                  <span>${(i.price*i.qty).toFixed(2)}</span>
                  <Button variant="danger" icon="trash" size="sm" onClick={()=>setCart(cart.filter(x=>x.cartId!==i.cartId))} />
                </div>
              ))}
            </div>
            <div className="mt-6 space-y-3 text-white">
              <Input label="Envío ($)" type="number" value={delivery} onChange={e=>setDelivery(e.target.value)} />
              <Input label="Descuento (%)" type="number" value={discount} onChange={e=>setDiscount(e.target.value)} />
              <p className="text-2xl font-bold text-right">Total: ${total.toFixed(2)}</p>
            </div>
            <div className="grid grid-cols-2 gap-3 mt-6">
              <Button variant="success" icon="whatsapp" disabled={loading || !cart.length} onClick={()=>checkout('whatsapp')}>WhatsApp</Button>
              <Button icon="dollar" disabled={loading || !cart.length} onClick={()=>checkout('local')}>Cobrar</Button>
            </div>
          </div>

          {/* Modal Variantes */}
          {selProd && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
              <div className="glass p-6 rounded-xl max-w-md w-full text-white">
                <h3 className="font-bold mb-4">{selProd.name}</h3>
                <div className="space-y-2">
                  {selProd.variants.map(v => (
                    <button key={v.name} onClick={()=>{addToCart(selProd, v); setSelProd(null)}} className="w-full flex justify-between p-3 hover:bg-white/10 rounded">
                      <span>{v.name}</span><span>${v.price.toFixed(2)}</span>
                    </button>
                  ))}
                </div>
                <Button variant="outline" onClick={()=>setSelProd(null)} className="mt-4 w-full">Cerrar</Button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==== INVENTARIO (con variantes) ====
    function Inventory({ products }) {
      const [modal, setModal] = useState(false);
      const [form, setForm] = useState({ name:'', price:0, cost:0, stock:0, variants:[] });
      const [vForm, setVForm] = useState({ name:'', price:0, cost:0, stock:0 });

      const save = async () => {
        if (!form.name) return;
        await db.collection("products").add({ ...form, price: +form.price, cost: +form.cost, stock: +form.stock });
        setModal(false); setForm({ name:'', price:0, cost:0, stock:0, variants:[] });
      };

      const addVar = () => {
        if (!vForm.name) return;
        setForm({...form, variants: [...form.variants, { ...vForm, price: +vForm.price, cost: +vForm.cost, stock: +vForm.stock }]});
        setVForm({ name:'', price:0, cost:0, stock:0 });
      };

      const del = async (id) => {
        if (confirm("¿Eliminar?")) await db.collection("products").doc(id).delete();
      };

      return (
        <div>
          <h2 className="text-2xl font-bold mb-6 text-white">Inventario</h2>
          <Button icon="plus" onClick={()=>setModal(true)}>Nuevo Producto</Button>
          <div className="mt-6 space-y-4">
            {products.map(p => (
              <div key={p.id} className="glass p-4 rounded-xl text-white flex justify-between">
                <div>
                  <h3 className="font-bold">{p.name}</h3>
                  <p>Precio: \( {p.price} | Costo: \){p.cost} | Stock: {p.stock}</p>
                  {p.variants.length > 0 && <p>Variantes: {p.variants.map(v=>v.name).join(', ')}</p>}
                </div>
                <Button variant="danger" icon="trash" onClick={()=>del(p.id)} />
              </div>
            ))}
          </div>

          {modal && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
              <div className="glass p-6 rounded-xl max-w-lg w-full text-white">
                <h3 className="font-bold text-xl mb-4">Nuevo Producto</h3>
                <div className="space-y-4">
                  <Input label="Nombre" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                  <div className="grid grid-cols-3 gap-3">
                    <Input label="Precio" type="number" value={form.price} onChange={e=>setForm({...form, price:e.target.value})} />
                    <Input label="Costo" type="number" value={form.cost} onChange={e=>setForm({...form, cost:e.target.value})} />
                    <Input label="Stock" type="number" value={form.stock} onChange={e=>setForm({...form, stock:e.target.value})} />
                  </div>
                  <div className="space-y-2">
                    <p className="font-bold">Variantes</p>
                    <div className="grid grid-cols-4 gap-2">
                      <Input placeholder="Nombre (ej: Rojo)" value={vForm.name} onChange={e=>setVForm({...vForm, name:e.target.value})} />
                      <Input type="number" placeholder="Precio" value={vForm.price} onChange={e=>setVForm({...vForm, price:e.target.value})} />
                      <Input type="number" placeholder="Costo" value={vForm.cost} onChange={e=>setVForm({...vForm, cost:e.target.value})} />
                      <Input type="number" placeholder="Stock" value={vForm.stock} onChange={e=>setVForm({...vForm, stock:e.target.value})} />
                    </div>
                    <Button onClick={addVar} variant="outline">Agregar Variante</Button>
                    <div className="flex flex-wrap gap-2">
                      {form.variants.map(v => <span key={v.name} className="bg-white/20 p-2 rounded">{v.name} (${v.price}, Stock: {v.stock})</span>)}
                    </div>
                  </div>
                  <div className="flex gap-3">
                    <Button variant="outline" onClick={()=>setModal(false)}>Cancelar</Button>
                    <Button onClick={save}>Guardar</Button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==== HISTORIAL (con filtros) ====
    function HistoryView({ sales }) {
      const [filter, setFilter] = useState("");

      const filteredSales = sales.filter(s => s.paymentStatus.toLowerCase().includes(filter.toLowerCase()) || s.method?.toLowerCase().includes(filter.toLowerCase()));

      return (
        <div>
          <h2 className="text-2xl font-bold mb-6 text-white">Historial de Ventas</h2>
          <Input placeholder="Filtrar por estado o método" value={filter} onChange={e=>setFilter(e.target.value)} />
          <div className="mt-6 space-y-4">
            {filteredSales.map(s => (
              <div key={s.id} className="glass p-4 rounded-xl text-white">
                <p className="font-bold">Fecha: {s.date.toLocaleString()}</p>
                <p>Total: ${s.total.toFixed(2)}</p>
                <p>Estado: {s.paymentStatus}</p>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ==== DASHBOARD ====
    function Dashboard({ sales, products }) {
      const metrics = useMemo(() => {
        let rev = 0, cost = 0, del = 0, items = 0;
        sales.forEach(s => {
          rev += s.total;
          del += s.deliveryFee || 0;
          s.items.forEach(i => { items += i.qty; cost += (i.cost * i.qty); });
        });
        return { rev, net: rev - cost, del, items };
      }, [sales]);

      return (
        <div>
          <h2 className="text-2xl font-bold mb-6 text-white">Reportes Financieros</h2>
          <div className="grid md:grid-cols-4 gap-4">
            <div className="glass p-4 rounded-xl text-white">
              <p className="font-bold">Ventas Totales</p>
              <p className="text-3xl">${metrics.rev.toFixed(2)}</p>
            </div>
            <div className="glass p-4 rounded-xl text-white">
              <p className="font-bold">Ganancia Neta</p>
              <p className="text-3xl">${metrics.net.toFixed(2)}</p>
            </div>
            <div className="glass p-4 rounded-xl text-white">
              <p className="font-bold">Envíos</p>
              <p className="text-3xl">${metrics.del.toFixed(2)}</p>
            </div>
            <div className="glass p-4 rounded-xl text-white">
              <p className="font-bold">Items Vendidos</p>
              <p className="text-3xl">{metrics.items}</p>
            </div>
          </div>
          <h3 className="text-xl font-bold mt-8 mb-4 text-white">Stock Bajo</h3>
          <div className="space-y-2">
            {products.filter(p => p.stock <= 5).map(p => (
              <div key={p.id} className="glass p-3 rounded text-white flex justify-between">
                <span>{p.name}</span><span className="text-red-300">Stock: {p.stock}</span>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ==== ABRIR CAJA ====
    const OpenShift = ({ onOpen, user }) => {
      const [amount, setAmount] = useState(0);
      const open = async () => {
        const ref = await db.collection("shifts").add({ userId: user.uid, startAmount: +amount, openedAt: firebase.firestore.FieldValue.serverTimestamp(), status: "open" });
        onOpen(user.uid);
      };
      return (
        <div className="flex items-center justify-center h-full">
          <div className="glass p-8 rounded-xl max-w-md text-white text-center">
            <h2 className="text-2xl font-bold mb-4">Abrir Caja</h2>
            <Input label="Monto Inicial ($)" type="number" value={amount} onChange={e=>setAmount(e.target.value)} />
            <Button onClick={open} disabled={!amount} className="mt-6 w-full">Abrir</Button>
          </div>
        </div>
      );
    };

    // ==== CONTROL CAJA (con cierre automático) ====
    const ShiftControl = ({ shift, onUpdate }) => {
      const [endAmount, setEndAmount] = useState(0);
      const close = async () => {
        if (confirm("¿Cerrar caja?")) {
          await db.collection("shifts").doc(shift.id).update({ status: "closed", endAmount: +endAmount, closedAt: firebase.firestore.FieldValue.serverTimestamp() });
          onUpdate();
        }
      };
      return (
        <div>
          <h2 className="text-2xl font-bold mb-6 text-white">Control de Caja</h2>
          <div className="glass p-6 rounded-xl text-white">
            <p>Inicio: ${shift.startAmount}</p>
            <p>Apertura: {shift.openedAt?.toDate().toLocaleString()}</p>
            <Input label="Monto Final ($)" type="number" value={endAmount} onChange={e=>setEndAmount(e.target.value)} className="mt-4" />
            <Button variant="danger" onClick={close} className="mt-6 w-full">Cerrar Caja</Button>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
