<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Homemart PRO - Punto de Venta</title>
  <meta name="description" content="Sistema POS profesional para Homemart - Ferretería y Hogar"/>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase v8 CDN (Compatibilidad heredada) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- ESC/POS para impresoras térmicas -->
  <script src="https://unpkg.com/escpos-web@1.0.2/dist/escpos.min.js"></script>

  <style>
    body { 
      font-family: 'Inter', system-ui, sans-serif; 
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); 
      min-height: 100vh; 
      overflow-x: hidden;
    }
    .glass { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(12px); 
      border: 1px solid rgba(255, 255, 255, 0.3); 
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }
    .glass-dark {
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(5px);
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Animaciones */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // ==== CONFIGURACIÓN FIREBASE (Tus claves originales) ====
    const firebaseConfig = {
      apiKey: "AIzaSyDF374bHcODY8N0R78HE8kZpmjeGeuhniU",
      authDomain: "posdeventas-a03ca.firebaseapp.com",
      projectId: "posdeventas-a03ca",
      storageBucket: "posdeventas-a03ca.firebasestorage.app",
      messagingSenderId: "975141670948",
      appId: "1:975141670948:web:e58ed3da11878ecfdf88b1"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();
    const { useState, useEffect, useMemo, useRef } = React;

    // Activar persistencia local para mantener la sesión
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e => console.error(e));

    // ==== COMPONENTES UI ====
    const Icon = ({ name, size = 20, className="" }) => {
      const icons = {
        cart: "fa-cart-shopping", box: "fa-box", history: "fa-clock-rotate-left",
        chart: "fa-chart-pie", lock: "fa-lock", unlock: "fa-lock-open", plus: "fa-plus",
        trash: "fa-trash-can", search: "fa-magnifying-glass", whatsapp: "fa-whatsapp",
        dollar: "fa-money-bill-wave", truck: "fa-truck-fast", user: "fa-user-circle", logout: "fa-right-from-bracket",
        receipt: "fa-receipt", tag: "fa-tag", print: "fa-print", filter: "fa-filter",
        check: "fa-circle-check", edit: "fa-pen-to-square", chevron: "fa-chevron-right"
      };
      return <i className={`fa-solid ${icons[name] || 'fa-circle'} ${className}`} style={{fontSize: size}}></i>;
    };

    const Button = ({ children, onClick, variant = "primary", icon, disabled, className = "", type="button" }) => {
      const variants = {
        primary: "bg-indigo-600 hover:bg-indigo-700 text-white shadow-md hover:shadow-lg",
        success: "bg-emerald-600 hover:bg-emerald-700 text-white shadow-md",
        danger: "bg-rose-600 hover:bg-rose-700 text-white shadow-md",
        outline: "border-2 border-indigo-100 hover:bg-white/10 text-indigo-100",
        ghost: "hover:bg-white/10 text-white"
      };
      return (
        <button type={type} onClick={onClick} disabled={disabled}
          className={`px-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all active:scale-95 ${variants[variant]} disabled:opacity-50 disabled:cursor-not-allowed ${className}`}>
          {icon && <Icon name={icon} />}
          {children}
        </button>
      );
    };

    const Input = ({ label, ...props }) => (
      <div className="flex flex-col gap-1 w-full">
        {label && <label className="text-xs font-bold uppercase tracking-wider text-indigo-100 ml-1">{label}</label>}
        <input className="w-full px-4 py-3 rounded-xl bg-white/10 backdrop-blur text-white placeholder-indigo-200/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 focus:bg-white/20 transition-all" {...props} />
      </div>
    );

    // ==== LOGIN / REGISTRO (ARREGLADO) ====
    const Login = () => {
      const [email, setEmail] = useState("");
      const [pass, setPass] = useState("");
      const [isRegistering, setIsRegistering] = useState(false);
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if(!email || !pass) return Swal.fire("Campos vacíos", "Por favor llena todos los campos", "warning");
        
        setLoading(true);
        try {
          if (isRegistering) {
            await auth.createUserWithEmailAndPassword(email, pass);
            Swal.fire("Bienvenido", "Cuenta creada exitosamente. ¡Bienvenido a Homemart!", "success");
          } else {
            await auth.signInWithEmailAndPassword(email, pass);
          }
        } catch (error) {
          console.error(error);
          let msg = "Error desconocido";
          if(error.code === 'auth/email-already-in-use') msg = "Este correo ya está registrado.";
          if(error.code === 'auth/wrong-password') msg = "Contraseña incorrecta.";
          if(error.code === 'auth/user-not-found') msg = "Usuario no encontrado.";
          if(error.code === 'auth/weak-password') msg = "La contraseña debe tener al menos 6 caracteres.";
          Swal.fire("Error de Acceso", msg, "error");
        }
        setLoading(false);
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="glass rounded-3xl shadow-2xl p-8 md:p-10 max-w-md w-full animate-fade-in relative overflow-hidden">
            {/* Decoración de fondo */}
            <div className="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500 rounded-full blur-3xl opacity-50"></div>
            
            <div className="text-center mb-8 relative z-10">
              <div className="bg-white/20 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 backdrop-blur-md shadow-inner">
                 <Icon name="tag" size={30} className="text-white" />
              </div>
              <h1 className="text-3xl font-bold text-white mb-1">Homemart PRO</h1>
              <p className="text-indigo-100 opacity-90">{isRegistering ? "Crear nueva cuenta" : "Iniciar Sesión"}</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-5 relative z-10">
              <Input placeholder="correo@ejemplo.com" type="email" value={email} onChange={e=>setEmail(e.target.value)} required />
              <Input placeholder="Contraseña (mín 6 carácteres)" type="password" value={pass} onChange={e=>setPass(e.target.value)} required />
              
              <Button type="submit" className="w-full py-4 text-lg" disabled={loading}>
                {loading ? "Procesando..." : (isRegistering ? "Registrarse" : "Entrar")}
              </Button>
            </form>

            <div className="mt-6 text-center relative z-10">
              <button 
                onClick={() => setIsRegistering(!isRegistering)}
                className="text-white hover:text-indigo-200 underline text-sm font-medium transition-colors"
              >
                {isRegistering ? "¿Ya tienes cuenta? Inicia sesión" : "¿No tienes cuenta? Regístrate aquí"}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ==== APP PRINCIPAL ====
    function App() {
      const [user, setUser] = useState(null);
      const [loadingApp, setLoadingApp] = useState(true);
      const [view, setView] = useState('pos');
      const [products, setProducts] = useState([]);
      const [sales, setSales] = useState([]);
      const [shift, setShift] = useState(null);
      const [customerOrder, setCustomerOrder] = useState(null);
      const [isCustomerView, setIsCustomerView] = useState(false);

      // Listener de Autenticación
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('orderId');

        if (orderId) {
          setIsCustomerView(true);
          loadCustomerOrder(orderId);
        } else {
          const unsubscribe = auth.onAuthStateChanged(async (u) => {
            setUser(u);
            if (u) {
              await checkShift(u.uid);
            }
            setLoadingApp(false);
          });
          return unsubscribe;
        }
      }, []);

      // Listeners de Datos (Solo si hay usuario)
      useEffect(() => {
        if (!user || isCustomerView) return;

        // Listener Productos
        const unsubProd = db.collection("products").onSnapshot(
          s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()}))),
          err => console.error("Error cargando productos:", err)
        );

        // Listener Ventas (Con manejo de error de índice)
        const unsubSales = db.collection("sales")
          .orderBy("date", "desc")
          .limit(100) // Límite para optimizar
          .onSnapshot(
            s => setSales(s.docs.map(d => ({id:d.id, ...d.data(), date: d.data().date?.toDate()}))),
            err => {
               console.error("Error cargando ventas (posible falta de índice):", err);
               // Fallback si falla el orderBy por falta de index
               if(err.code === 'failed-precondition') {
                 Swal.fire("Info de Sistema", "Si es la primera vez, abre la consola del navegador y sigue el link de Firebase para crear el índice 'date'.", "info");
               }
            }
          );

        return () => {
          unsubProd();
          unsubSales();
        };
      }, [user, isCustomerView]);

      const loadCustomerOrder = async (id) => {
        try {
          await auth.signInAnonymously();
          const docSnap = await db.collection("sales").doc(id).get();
          if (docSnap.exists) setCustomerOrder({ id: docSnap.id, ...docSnap.data(), date: docSnap.data().date?.toDate() });
          else Swal.fire("Error", "Orden no encontrada", "error");
        } catch (e) { console.error(e); }
        setLoadingApp(false);
      };

      const checkShift = async (uid) => {
        try {
            const snap = await db.collection("shifts").where("status","==","open").where("userId","==",uid).get();
            setShift(snap.empty ? null : { id: snap.docs[0].id, ...snap.docs[0].data() });
        } catch (e) {
            console.error("Error checando turno:", e);
        }
      };

      if (loadingApp) return <div className="fixed inset-0 glass flex flex-col items-center justify-center text-white"><i className="fas fa-circle-notch fa-spin text-4xl mb-4"></i><span className="text-xl font-bold">Cargando Sistema...</span></div>;
      if (isCustomerView) return <CustomerView order={customerOrder} />;
      if (!user) return <Login />;

      return (
        <div className="flex flex-col md:flex-row h-screen overflow-hidden">
          {/* Sidebar / Navbar Móvil */}
          <aside className="bg-indigo-900/40 backdrop-blur-xl border-r border-white/10 text-white flex flex-row md:flex-col justify-between shrink-0 h-16 md:h-auto md:w-64 fixed bottom-0 w-full md:relative z-40">
            <div className="p-4 hidden md:block">
              <h1 className="text-2xl font-bold tracking-tight">Homemart <span className="text-indigo-300">PRO</span></h1>
              <div className="mt-2 flex items-center gap-2 text-xs bg-black/20 p-2 rounded-lg">
                <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                <span className="truncate w-32">{user.email}</span>
              </div>
            </div>
            
            <nav className="flex-1 flex md:flex-col justify-around md:justify-start px-2 md:px-4 md:mt-4 gap-1">
              {[
                {v:'pos',i:'cart',l:'Venta'},
                {v:'products',i:'box',l:'Inventario'},
                {v:'history',i:'history',l:'Historial'},
                {v:'dashboard',i:'chart',l:'Reportes'},
                {v:'shift',i:'lock',l:'Caja'}
              ].map(item => (
                <button key={item.v} onClick={()=>setView(item.v)}
                  className={`flex flex-col md:flex-row items-center md:gap-4 p-3 md:py-4 md:px-5 rounded-xl transition-all ${view===item.v ? 'bg-indigo-600 shadow-lg text-white scale-105' : 'text-indigo-200 hover:bg-white/10'}`}>
                  <Icon name={item.i} size={view===item.v ? 22 : 20} />
                  <span className="text-[10px] md:text-sm font-medium mt-1 md:mt-0">{item.l}</span>
                </button>
              ))}
              
              <button onClick={()=>auth.signOut()} className="flex flex-col md:flex-row items-center md:gap-4 p-3 md:py-4 md:px-5 rounded-xl text-rose-300 hover:bg-rose-500/20 md:mt-auto md:mb-4">
                <Icon name="logout" size={20} />
                <span className="text-[10px] md:text-sm font-medium mt-1 md:mt-0">Salir</span>
              </button>
            </nav>
          </aside>

          {/* Main Content */}
          <main className="flex-1 overflow-y-auto pb-20 md:pb-0 relative">
            <div className="p-4 md:p-8 max-w-7xl mx-auto min-h-full">
              {view === 'pos' && !shift ? <OpenShift user={user} onOpen={checkShift} /> : (
                <div className="glass rounded-3xl p-4 md:p-8 min-h-[85vh] shadow-2xl animate-fade-in relative">
                   {/* Header móvil */}
                   <div className="md:hidden flex justify-between items-center mb-6">
                      <h2 className="text-xl font-bold text-white uppercase tracking-wider">{view}</h2>
                      <div className="text-xs text-white/70">{user.email}</div>
                   </div>

                   {view === 'pos' && <POSModule products={products} shift={shift} user={user} />}
                   {view === 'products' && <Inventory products={products} />}
                   {view === 'history' && <HistoryView sales={sales} />}
                   {view === 'dashboard' && <Dashboard sales={sales} products={products} />}
                   {view === 'shift' && <ShiftControl shift={shift} onUpdate={()=>checkShift(user.uid)} />}
                </div>
              )}
            </div>
          </main>
        </div>
      );
    }

    // ==== VISTA CLIENTE (LINK PÚBLICO) ====
    const CustomerView = ({ order }) => (
      <div className="min-h-screen bg-gradient-to-br from-indigo-900 to-purple-900 flex items-center justify-center p-4">
        <div className="glass rounded-3xl shadow-2xl max-w-md w-full p-8 text-center text-white border-t-4 border-indigo-400">
          <Icon name="check" size={50} className="text-emerald-400 mb-4" />
          <h1 className="text-3xl font-bold mb-1">Homemart</h1>
          <p className="text-indigo-200 text-sm mb-6 uppercase tracking-widest">Recibo Digital #{order?.id.slice(0,6)}</p>
          
          <div className="bg-black/20 rounded-2xl p-6 mb-6">
             <p className="text-5xl font-bold tracking-tight">${order?.total.toFixed(2)}</p>
             <p className="text-sm opacity-60 mt-2">{order?.paymentStatus}</p>
          </div>

          <div className="space-y-3 text-left mb-6 max-h-60 overflow-y-auto pr-2">
            {order?.items.map((i, idx) => (
              <div key={idx} className="flex justify-between items-center border-b border-white/10 pb-2">
                <div>
                   <span className="font-bold">{i.qty}x</span> {i.name} 
                   {i.variantName && <span className="text-xs bg-indigo-500/50 px-2 py-0.5 rounded ml-2">{i.variantName}</span>}
                </div>
                <span className="font-mono">${(i.price * i.qty).toFixed(2)}</span>
              </div>
            ))}
          </div>

          <div className="space-y-2 border-t border-white/20 pt-4 text-sm">
             {order.deliveryFee > 0 && <div className="flex justify-between"><span>Envío</span><span>${order.deliveryFee.toFixed(2)}</span></div>}
             {order.discount > 0 && <div className="flex justify-between text-emerald-300"><span>Descuento</span><span>-{order.discount}%</span></div>}
             <div className="flex justify-between text-lg font-bold pt-2"><span>Total</span><span>${order.total.toFixed(2)}</span></div>
          </div>
        </div>
      </div>
    );

    // ==== POS MODULE ====
    function POSModule({ products, shift, user }) {
      const [cart, setCart] = useState([]);
      const [search, setSearch] = useState("");
      const [delivery, setDelivery] = useState(0);
      const [discount, setDiscount] = useState(0);
      const [selProd, setSelProd] = useState(null);
      const [loading, setLoading] = useState(false);

      const addToCart = (p, variant = null) => {
        const stock = variant ? variant.stock : p.stock;
        if (stock <= 0) return Swal.fire("Sin Stock", "No quedan unidades disponibles", "warning");

        const cartId = variant ? `${p.id}-${variant.name}` : p.id;
        const exists = cart.find(x => x.cartId === cartId);

        if (exists) {
          if (exists.qty + 1 > stock) return Swal.fire("Límite Alcanzado", "No hay más stock disponible", "warning");
          setCart(cart.map(x => x.cartId === cartId ? {...x, qty: x.qty + 1} : x));
        } else {
          setCart([...cart, {
            cartId, id: p.id, name: p.name, variantName: variant?.name,
            price: Number(variant?.price || p.price), 
            cost: Number(variant?.cost || p.cost),
            qty: 1
          }]);
        }
      };

      const removeFromCart = (id) => setCart(cart.filter(x => x.cartId !== id));

      const subtotal = cart.reduce((acc, el) => acc + (el.price * el.qty), 0);
      const total = (subtotal * (1 - discount / 100)) + Number(delivery || 0);

      const checkout = async (method) => {
        if(cart.length === 0) return;
        setLoading(true);
        try {
          const saleData = {
            date: firebase.firestore.FieldValue.serverTimestamp(),
            shiftId: shift.id,
            cashierId: user.uid,
            cashierEmail: user.email, // Útil para reportes
            items: cart,
            subtotal: Number(subtotal),
            discount: Number(discount),
            deliveryFee: Number(delivery),
            total: Number(total),
            paymentStatus: method === 'whatsapp' ? 'Pendiente' : 'Pagado',
            method
          };

          const saleRef = await db.collection("sales").add(saleData);

          // Actualizar Stock
          const batch = db.batch();
          cart.forEach(item => {
             const docRef = db.collection("products").doc(item.id);
             // Nota: Decrementar stock de variantes es complejo en NoSQL simple, 
             // aquí decrementamos el stock base o se necesitaría lógica más compleja para arrays.
             // Simplificación: Decrementamos stock global del producto por ahora.
             batch.update(docRef, { stock: firebase.firestore.FieldValue.increment(-item.qty) });
          });
          await batch.commit();

          if (method === 'whatsapp') {
            const link = `${window.location.origin}${window.location.pathname}?orderId=${saleRef.id}`;
            const msg = `*Pedido Homemart PRO*\n\n${cart.map(i=>`${i.qty}x ${i.name} ${i.variantName ? '('+i.variantName+')' : ''} - $${(i.price*i.qty).toFixed(2)}`).join('\n')}\n\nEnvío: $${Number(delivery).toFixed(2)}\nDescuento: ${discount}%\n*Total: $${total.toFixed(2)}*\n\nVer Recibo: ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
          } else {
            Swal.fire({
              title: "¡Venta Exitosa!",
              text: `Total: $${total.toFixed(2)}`,
              icon: "success",
              timer: 2000,
              showConfirmButton: false
            });
          }
          setCart([]); setDelivery(0); setDiscount(0); setSearch("");
        } catch (e) { console.error(e); Swal.fire("Error", "No se pudo registrar la venta", "error"); }
        setLoading(false);
      };

      return (
        <div className="flex flex-col lg:flex-row gap-6 h-full">
          {/* Panel Izquierdo: Productos */}
          <div className="flex-1 flex flex-col h-full overflow-hidden">
            <div className="relative mb-4">
              <Icon name="search" className="absolute left-4 top-4 text-white/50" />
              <input 
                className="w-full pl-12 pr-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 focus:outline-none focus:bg-white/20"
                placeholder="Buscar producto por nombre..." 
                value={search} 
                autoFocus
                onChange={e=>setSearch(e.target.value)} 
              />
            </div>
            
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 overflow-y-auto scrollbar-hide pr-2 pb-20 lg:pb-0">
              {products.filter(p=>p.name.toLowerCase().includes(search.toLowerCase())).map(p => (
                <button key={p.id} onClick={()=>p.variants?.length ? setSelProd(p) : addToCart(p)}
                  className="bg-white/5 hover:bg-white/10 border border-white/10 p-3 rounded-xl text-left transition-all active:scale-95 flex flex-col justify-between h-32 group relative overflow-hidden">
                  <div className="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-30 transition-opacity">
                     <Icon name={p.variants?.length ? "tag" : "box"} size={40} />
                  </div>
                  <div>
                    <h3 className="font-bold text-white leading-tight line-clamp-2">{p.name}</h3>
                    <p className={`text-xs mt-1 ${p.stock < 5 ? 'text-rose-400 font-bold' : 'text-emerald-400'}`}>Stock: {p.stock}</p>
                  </div>
                  <div className="flex justify-between items-end mt-2">
                     <p className="text-lg font-bold text-indigo-200">${Number(p.price).toFixed(2)}</p>
                     {p.variants?.length > 0 && <span className="text-[10px] bg-indigo-500 px-1.5 rounded">Opciones</span>}
                  </div>
                </button>
              ))}
              {products.length === 0 && <div className="col-span-full text-center text-white/50 py-10">No hay productos en inventario</div>}
            </div>
          </div>

          {/* Panel Derecho: Carrito (Sticky en Desktop) */}
          <div className="lg:w-96 flex flex-col h-full bg-black/20 rounded-2xl border border-white/10 overflow-hidden">
            <div className="p-4 bg-indigo-900/50 border-b border-white/10 flex justify-between items-center">
              <h2 className="font-bold text-white flex items-center gap-2"><Icon name="cart" /> Orden Actual</h2>
              <button onClick={()=>setCart([])} className="text-rose-300 text-xs hover:underline">Limpiar</button>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-2">
              {cart.length === 0 ? (
                <div className="h-full flex flex-col items-center justify-center text-white/30">
                  <Icon name="cart" size={40} className="mb-2" />
                  <p>Carrito vacío</p>
                </div>
              ) : (
                cart.map(i => (
                  <div key={i.cartId} className="flex items-center justify-between bg-white/5 p-2 rounded-lg animate-fade-in group">
                    <div className="flex-1">
                      <div className="text-white text-sm font-medium">{i.name}</div>
                      <div className="text-white/60 text-xs">{i.variantName}</div>
                      <div className="text-indigo-300 text-xs font-bold">${Number(i.price).toFixed(2)} x {i.qty}</div>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className="text-white font-bold">${(i.price*i.qty).toFixed(2)}</span>
                      <button onClick={()=>removeFromCart(i.cartId)} className="text-white/20 hover:text-rose-400 transition-colors"><Icon name="trash" size={14}/></button>
                    </div>
                  </div>
                ))
              )}
            </div>

            <div className="p-4 bg-indigo-900/80 border-t border-white/10 space-y-3">
              <div className="grid grid-cols-2 gap-2">
                 <Input placeholder="Envío $" type="number" min="0" value={delivery} onChange={e=>setDelivery(e.target.value)} />
                 <Input placeholder="Desc %" type="number" min="0" max="100" value={discount} onChange={e=>setDiscount(e.target.value)} />
              </div>
              
              <div className="flex justify-between items-end text-white border-t border-white/10 pt-2">
                <span className="opacity-70">Total a Pagar</span>
                <span className="text-3xl font-bold tracking-tight">${total.toFixed(2)}</span>
              </div>
              
              <div className="grid grid-cols-2 gap-3 pt-1">
                <Button variant="success" icon="whatsapp" disabled={loading || !cart.length} onClick={()=>checkout('whatsapp')} className="text-sm">WhatsApp</Button>
                <Button variant="primary" icon="dollar" disabled={loading || !cart.length} onClick={()=>checkout('local')} className="text-sm">Cobrar</Button>
              </div>
            </div>
          </div>

          {/* Modal Variantes */}
          {selProd && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in">
              <div className="glass p-6 rounded-2xl max-w-sm w-full text-white shadow-2xl">
                <div className="flex justify-between items-center mb-4">
                   <h3 className="font-bold text-lg">{selProd.name}</h3>
                   <button onClick={()=>setSelProd(null)} className="text-white/50 hover:text-white"><i className="fas fa-times"></i></button>
                </div>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {selProd.variants.map(v => (
                    <button key={v.name} onClick={()=>{addToCart(selProd, v); setSelProd(null)}} 
                      className="w-full flex justify-between items-center p-4 bg-white/10 hover:bg-white/20 rounded-xl transition-colors border border-white/5">
                      <div className="text-left">
                        <span className="font-bold block">{v.name}</span>
                        <span className="text-xs text-white/60">Stock: {v.stock}</span>
                      </div>
                      <span className="font-bold text-indigo-300 text-lg">${Number(v.price).toFixed(2)}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==== INVENTARIO ====
    function Inventory({ products }) {
      const [modal, setModal] = useState(false);
      const [form, setForm] = useState({ name:'', price:'', cost:'', stock:'', variants:[] });
      const [vForm, setVForm] = useState({ name:'', price:'', cost:'', stock:'' });

      const save = async () => {
        if (!form.name || !form.price) return Swal.fire("Error", "Nombre y Precio requeridos", "error");
        
        try {
          await db.collection("products").add({ 
            ...form, 
            price: Number(form.price), 
            cost: Number(form.cost), 
            stock: Number(form.stock),
            searchKey: form.name.toLowerCase() // Para búsquedas más eficientes en futuro
          });
          Swal.fire("Guardado", "Producto agregado", "success");
          setModal(false); setForm({ name:'', price:'', cost:'', stock:'', variants:[] });
        } catch(e) { console.error(e); }
      };

      const addVar = () => {
        if (!vForm.name || !vForm.price) return;
        setForm({...form, variants: [...form.variants, { ...vForm, price: Number(vForm.price), cost: Number(vForm.cost), stock: Number(vForm.stock) }]});
        setVForm({ name:'', price:'', cost:'', stock:'' });
      };

      const del = async (id) => {
        Swal.fire({
          title: '¿Eliminar?',
          text: "No podrás revertir esto",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Sí, eliminar'
        }).then(async (result) => {
          if (result.isConfirmed) {
            await db.collection("products").doc(id).delete();
            Swal.fire('Eliminado!', '', 'success');
          }
        })
      };

      return (
        <div className="h-full flex flex-col">
          <div className="flex justify-between items-center mb-6">
             <h2 className="text-2xl font-bold text-white"><Icon name="box" className="mr-2"/>Inventario</h2>
             <Button icon="plus" onClick={()=>setModal(true)}>Nuevo</Button>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto pb-20">
            {products.map(p => (
              <div key={p.id} className="bg-white/5 border border-white/10 p-4 rounded-xl text-white hover:bg-white/10 transition-colors relative group">
                <div className="flex justify-between items-start mb-2">
                   <h3 className="font-bold text-lg">{p.name}</h3>
                   <span className="bg-indigo-600 text-xs px-2 py-1 rounded font-mono">${Number(p.price).toFixed(2)}</span>
                </div>
                <div className="text-sm opacity-70 mb-3 space-y-1">
                   <p>Costo: ${Number(p.cost).toFixed(2)}</p>
                   <p>Stock General: {p.stock}</p>
                </div>
                {p.variants?.length > 0 && (
                  <div className="mt-2 pt-2 border-t border-white/10">
                    <p className="text-xs font-bold mb-1 opacity-50 uppercase">Variantes</p>
                    <div className="flex flex-wrap gap-1">
                      {p.variants.map(v => <span key={v.name} className="text-[10px] bg-white/10 px-2 py-1 rounded border border-white/5">{v.name} ({v.stock})</span>)}
                    </div>
                  </div>
                )}
                <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onClick={()=>del(p.id)} className="bg-rose-600 p-2 rounded-lg text-white shadow-lg hover:scale-110 transition-transform"><Icon name="trash" size={14}/></button>
                </div>
              </div>
            ))}
          </div>

          {modal && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in">
              <div className="glass p-6 rounded-2xl max-w-lg w-full text-white shadow-2xl max-h-[90vh] overflow-y-auto">
                <h3 className="font-bold text-xl mb-4 border-b border-white/10 pb-2">Nuevo Producto</h3>
                <div className="space-y-4">
                  <Input label="Nombre del Producto" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                  <div className="grid grid-cols-3 gap-3">
                    <Input label="Precio Venta" type="number" value={form.price} onChange={e=>setForm({...form, price:e.target.value})} />
                    <Input label="Costo Compra" type="number" value={form.cost} onChange={e=>setForm({...form, cost:e.target.value})} />
                    <Input label="Stock Inicial" type="number" value={form.stock} onChange={e=>setForm({...form, stock:e.target.value})} />
                  </div>
                  
                  <div className="bg-white/5 p-4 rounded-xl border border-white/10">
                    <p className="font-bold text-sm mb-3 flex items-center gap-2"><Icon name="tag"/> Agregar Variantes (Opcional)</p>
                    <div className="grid grid-cols-4 gap-2 mb-2">
                      <Input placeholder="Ej: Rojo" value={vForm.name} onChange={e=>setVForm({...vForm, name:e.target.value})} />
                      <Input type="number" placeholder="$ Venta" value={vForm.price} onChange={e=>setVForm({...vForm, price:e.target.value})} />
                      <Input type="number" placeholder="$ Costo" value={vForm.cost} onChange={e=>setVForm({...vForm, cost:e.target.value})} />
                      <Input type="number" placeholder="Stock" value={vForm.stock} onChange={e=>setVForm({...vForm, stock:e.target.value})} />
                    </div>
                    <Button onClick={addVar} variant="outline" size="sm" className="w-full text-sm py-2">Agregar Variante</Button>
                    
                    <div className="mt-2 flex flex-wrap gap-2">
                      {form.variants.map((v, i) => (
                        <span key={i} className="bg-indigo-600/50 p-2 rounded text-xs flex items-center gap-2">
                          {v.name} (${v.price}) 
                          <button onClick={()=>setForm({...form, variants: form.variants.filter((_, idx)=>idx!==i)})}><i className="fas fa-times"></i></button>
                        </span>
                      ))}
                    </div>
                  </div>

                  <div className="flex gap-3 mt-4 pt-4 border-t border-white/10">
                    <Button variant="ghost" onClick={()=>setModal(false)} className="flex-1">Cancelar</Button>
                    <Button onClick={save} className="flex-1">Guardar Producto</Button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==== HISTORIAL ====
    function HistoryView({ sales }) {
      const [filter, setFilter] = useState("");
      const filteredSales = sales.filter(s => 
        (s.paymentStatus?.toLowerCase() || "").includes(filter.toLowerCase()) || 
        (s.method?.toLowerCase() || "").includes(filter.toLowerCase()) ||
        (s.id || "").includes(filter)
      );

      return (
        <div className="h-full flex flex-col">
          <h2 className="text-2xl font-bold mb-6 text-white"><Icon name="history" className="mr-2"/>Historial</h2>
          <Input placeholder="Filtrar por ID, Estado o Método..." value={filter} onChange={e=>setFilter(e.target.value)} />
          <div className="mt-4 space-y-3 overflow-y-auto pb-20">
            {filteredSales.map(s => (
              <div key={s.id} className="bg-white/5 border border-white/10 p-4 rounded-xl text-white flex justify-between items-center hover:bg-white/10 transition-colors">
                <div>
                  <div className="flex items-center gap-2 mb-1">
                     <span className="font-mono text-xs opacity-50">#{s.id.slice(0,6)}</span>
                     <span className={`text-[10px] px-2 rounded-full ${s.paymentStatus === 'Pagado' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-yellow-500/20 text-yellow-300'}`}>{s.paymentStatus}</span>
                  </div>
                  <p className="text-sm opacity-80">{s.date ? s.date.toLocaleString() : 'Sin fecha'}</p>
                  <p className="text-xs mt-1 text-indigo-300">{s.items.length} productos ({s.method})</p>
                </div>
                <div className="text-right">
                  <p className="font-bold text-xl">${Number(s.total).toFixed(2)}</p>
                  {s.deliveryFee > 0 && <p className="text-xs opacity-60">+${s.deliveryFee} envío</p>}
                </div>
              </div>
            ))}
            {filteredSales.length === 0 && <p className="text-center text-white/50 py-10">No se encontraron ventas</p>}
          </div>
        </div>
      );
    }

    // ==== DASHBOARD ====
    function Dashboard({ sales, products }) {
      const metrics = useMemo(() => {
        let rev = 0, cost = 0, del = 0, items = 0;
        sales.forEach(s => {
          rev += Number(s.total || 0);
          del += Number(s.deliveryFee || 0);
          s.items.forEach(i => { items += i.qty; cost += (Number(i.cost || 0) * i.qty); });
        });
        return { rev, net: rev - cost, del, items, margin: rev > 0 ? ((rev-cost)/rev)*100 : 0 };
      }, [sales]);

      const StatCard = ({ title, val, sub, icon, color }) => (
        <div className="bg-white/5 border border-white/10 p-5 rounded-2xl relative overflow-hidden group">
           <div className={`absolute top-0 right-0 p-3 opacity-20 group-hover:opacity-40 transition-opacity ${color}`}>
              <Icon name={icon} size={40} />
           </div>
           <p className="text-sm font-medium text-white/60 mb-1">{title}</p>
           <p className="text-3xl font-bold text-white">{val}</p>
           {sub && <p className="text-xs mt-2 text-white/40">{sub}</p>}
        </div>
      );

      return (
        <div>
          <h2 className="text-2xl font-bold mb-6 text-white"><Icon name="chart" className="mr-2"/>Reporte Financiero</h2>
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <StatCard title="Ventas Totales" val={`$${metrics.rev.toFixed(2)}`} icon="dollar" color="text-emerald-400" />
            <StatCard title="Ganancia Neta" val={`$${metrics.net.toFixed(2)}`} sub={`Margen: ${metrics.margin.toFixed(1)}%`} icon="chart" color="text-indigo-400" />
            <StatCard title="Envíos Cobrados" val={`$${metrics.del.toFixed(2)}`} icon="truck" color="text-blue-400" />
            <StatCard title="Items Vendidos" val={metrics.items} icon="tag" color="text-purple-400" />
          </div>
          
          <div className="bg-white/5 rounded-2xl p-6 border border-white/10">
            <h3 className="text-lg font-bold mb-4 text-white flex items-center gap-2"><Icon name="filter" /> Alertas de Inventario</h3>
            <div className="space-y-2">
              {products.filter(p => p.stock <= 5).length === 0 ? <p className="text-emerald-400 text-sm">Todo el inventario está saludable.</p> :
              products.filter(p => p.stock <= 5).map(p => (
                <div key={p.id} className="flex justify-between items-center bg-rose-500/10 p-3 rounded-lg border border-rose-500/20">
                  <span className="text-white font-medium">{p.name}</span>
                  <span className="text-rose-300 font-bold text-sm bg-rose-500/20 px-2 py-1 rounded">Quedan: {p.stock}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ==== CAJA ====
    const OpenShift = ({ onOpen, user }) => {
      const [amount, setAmount] = useState("");
      const [opening, setOpening] = useState(false);
      
      const open = async () => {
        setOpening(true);
        try {
          await db.collection("shifts").add({ 
            userId: user.uid, 
            userEmail: user.email,
            startAmount: Number(amount), 
            openedAt: firebase.firestore.FieldValue.serverTimestamp(), 
            status: "open" 
          });
          onOpen(user.uid);
          Swal.fire("Caja Abierta", "Buen turno de trabajo", "success");
        } catch(e) { console.error(e); }
        setOpening(false);
      };

      return (
        <div className="h-full flex items-center justify-center">
          <div className="glass p-10 rounded-3xl max-w-md w-full text-white text-center shadow-2xl animate-fade-in">
            <div className="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-600/50">
               <Icon name="lock" size={30} />
            </div>
            <h2 className="text-3xl font-bold mb-2">Apertura de Caja</h2>
            <p className="text-white/60 mb-8">Ingresa el dinero base en caja para comenzar a vender.</p>
            <Input label="Fondo de Caja ($)" type="number" value={amount} onChange={e=>setAmount(e.target.value)} autoFocus />
            <Button onClick={open} disabled={!amount || opening} className="mt-8 w-full py-4 text-lg" icon="unlock">
               {opening ? "Abriendo..." : "Abrir Turno"}
            </Button>
          </div>
        </div>
      );
    };

    const ShiftControl = ({ shift, onUpdate }) => {
      const [endAmount, setEndAmount] = useState("");
      
      const close = async () => {
        Swal.fire({
          title: '¿Cerrar Caja?',
          text: `Se registrará el cierre del turno iniciado el ${shift.openedAt?.toDate().toLocaleTimeString()}`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Sí, Cerrar',
          confirmButtonColor: '#e11d48'
        }).then(async (result) => {
          if (result.isConfirmed) {
            await db.collection("shifts").doc(shift.id).update({ 
               status: "closed", 
               endAmount: Number(endAmount), 
               closedAt: firebase.firestore.FieldValue.serverTimestamp() 
            });
            onUpdate();
            Swal.fire("Turno Cerrado", "Resumen guardado", "success");
          }
        });
      };

      return (
        <div className="h-full flex items-center justify-center">
          <div className="glass p-10 rounded-3xl max-w-md w-full text-white relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-400 to-indigo-500"></div>
            <h2 className="text-2xl font-bold mb-6 text-center">Control de Turno Activo</h2>
            
            <div className="bg-black/20 p-6 rounded-2xl space-y-4 mb-6">
               <div className="flex justify-between border-b border-white/10 pb-2">
                 <span className="opacity-70">Fondo Inicial</span>
                 <span className="font-bold text-xl">${Number(shift.startAmount).toFixed(2)}</span>
               </div>
               <div className="flex justify-between items-center">
                 <span className="opacity-70">Hora Inicio</span>
                 <span className="text-sm bg-white/10 px-2 py-1 rounded">{shift.openedAt?.toDate().toLocaleTimeString()}</span>
               </div>
            </div>

            <Input label="Dinero en Caja al Cierre ($)" type="number" value={endAmount} onChange={e=>setEndAmount(e.target.value)} />
            <Button variant="danger" onClick={close} className="mt-8 w-full py-3" icon="lock">Cerrar Caja y Salir</Button>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

