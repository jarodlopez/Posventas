<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Homemart POS - Enterprise</title>
  <meta name="theme-color" content="#4338ca">

  <!-- ==========================================
       LIBRERÍAS (NO TOCAR)
       ========================================== -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  
  <!-- REACT CORE -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: #f1f5f9;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }

    #root { height: 100%; display: flex; flex-direction: column; }

    .scroll-area {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      flex: 1;
    }
    .scroll-area::-webkit-scrollbar { display: none; }
    
    .input-field {
      width: 100%; background: white; border: 1px solid #cbd5e1; border-radius: 0.75rem;
      padding: 0.75rem 1rem; font-size: 0.95rem; outline: none; transition: all 0.2s;
      color: #1e293b;
    }
    .input-field:focus { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

    .btn {
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      font-weight: 700; padding: 0.85rem 1.5rem; border-radius: 0.75rem;
      transition: transform 0.1s; cursor: pointer; user-select: none;
    }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
    
    /* Animaciones */
    @keyframes enter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-enter { animation: enter 0.3s ease-out forwards; }
    
    /* Menu Lateral */
    .drawer {
        position: fixed; inset: 0; z-index: 100; pointer-events: none;
    }
    .drawer-overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s;
    }
    .drawer-content {
        position: absolute; top: 0; left: 0; bottom: 0; width: 80%; max-width: 300px;
        background: white; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: auto; display: flex; flex-direction: column;
    }
    .drawer.open { pointer-events: auto; }
    .drawer.open .drawer-overlay { opacity: 1; }
    .drawer.open .drawer-content { transform: translateX(0); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // --- FIREBASE INIT ---
    const firebaseConfig = {
      apiKey: "AIzaSyDF374bHcODY8N0R78HE8kZpmjeGeuhniU",
      authDomain: "posdeventas-a03ca.firebaseapp.com",
      projectId: "posdeventas-a03ca",
      storageBucket: "posdeventas-a03ca.firebasestorage.app",
      messagingSenderId: "975141670948",
      appId: "1:975141670948:web:e58ed3da11878ecfdf88b1"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'pos-pro-mobile-v2';
    const getCollection = (name) => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(name);

    const { useState, useEffect } = React;

    // --- ICONOS ---
    const Icon = ({ name, size = 20, className = "" }) => {
      useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
      return <i data-lucide={name} width={size} height={size} className={className}></i>;
    };

    const formatMoney = (amount) => new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'NIO' }).format(amount).replace('NIO', 'C$');

    // --- RASTREO ---
    const TrackingView = ({ trackId }) => {
      const [order, setOrder] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsub = getCollection('orders').where('displayId', '==', trackId).limit(1)
          .onSnapshot(snap => {
            if(!snap.empty) setOrder({id: snap.docs[0].id, ...snap.docs[0].data()});
            setLoading(false);
          });
        return unsub;
      }, [trackId]);

      if(loading) return <div className="h-full flex items-center justify-center bg-slate-100"><div className="w-12 h-12 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div></div>;
      if(!order) return <div className="h-full flex flex-col items-center justify-center text-gray-400 gap-4"><Icon name="search-x" size={64}/><h2 className="text-xl font-bold">Orden no encontrada</h2></div>;

      const steps = ['recibido', 'proceso', 'ruta', 'entregado'];
      let stepIdx = steps.indexOf(order.status);
      const progress = order.status==='cancelado' ? 100 : ((stepIdx === -1 ? 0 : stepIdx) / (steps.length-1)) * 100;
      const color = order.status==='cancelado' ? 'bg-red-500' : (order.status==='proceso' ? 'bg-orange-500' : 'bg-green-500');

      return (
        <div className="flex flex-col h-full bg-slate-50 overflow-hidden">
           <div className="bg-indigo-900 text-white pt-10 pb-20 px-6 rounded-b-[2.5rem] shadow-xl text-center relative overflow-hidden">
              <div className="relative z-10">
                 <div className="bg-white/10 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 backdrop-blur-sm"><Icon name="package" size={32} color="white"/></div>
                 <h1 className="text-2xl font-black tracking-tight">HOMEMART</h1>
                 <div className="mt-2 inline-block px-4 py-1 bg-white/20 rounded-full text-sm font-bold backdrop-blur">#{order.displayId}</div>
              </div>
           </div>
           
           <div className="px-5 -mt-12 flex-1 scroll-area pb-10">
              <div className="bg-white rounded-2xl shadow-lg p-6 mb-4 animate-enter">
                 <div className="flex justify-between items-center mb-4">
                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Estado</span>
                    <span className={`px-3 py-1 rounded-full text-xs font-bold text-white uppercase ${color}`}>{order.status}</span>
                 </div>
                 <div className="relative pt-2">
                    <div className="w-full bg-gray-100 h-2.5 rounded-full overflow-hidden">
                       <div className={`h-full transition-all duration-1000 rounded-full ${color}`} style={{width: `${progress}%`}}></div>
                    </div>
                    <div className="flex justify-between text-[10px] font-bold text-gray-400 mt-2 uppercase"><span>Recibido</span><span>Proceso</span><span>Ruta</span><span>Entregado</span></div>
                 </div>
              </div>

              <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 animate-enter">
                 <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4 border-b pb-2"><Icon name="shopping-bag" size={18} className="text-indigo-600"/> Resumen</h3>
                 <div className="space-y-3 mb-4">
                    {order.cart?.map((item, idx) => (
                       <div key={idx} className="flex justify-between items-start text-sm">
                          <div className="flex gap-3">
                             <span className="font-bold text-slate-500 bg-slate-100 px-2 rounded h-fit">{item.qty}x</span>
                             <div>
                                <p className="font-bold text-slate-700">{item.name}</p>
                                {item.variantName && <p className="text-xs text-slate-400">{item.variantName}</p>}
                             </div>
                          </div>
                          <span className="font-bold text-slate-800">{formatMoney(item.price * item.qty)}</span>
                       </div>
                    ))}
                 </div>
                 <div className="bg-slate-50 p-4 rounded-xl space-y-2 text-sm mb-4">
                    <div className="flex justify-between text-slate-500"><span>Subtotal</span><span>{formatMoney(order.subtotal)}</span></div>
                    {order.discountAmount > 0 && <div className="flex justify-between text-green-600 font-bold"><span>Descuento</span><span>-{formatMoney(order.discountAmount)}</span></div>}
                    <div className="flex justify-between text-slate-500"><span>IVA</span><span>{formatMoney(order.tax)}</span></div>
                    {order.isDelivery && <div className="flex justify-between text-indigo-600 font-bold"><span>Envío</span><span>{formatMoney(order.shipCost)}</span></div>}
                    <div className="flex justify-between text-xl font-black text-slate-900 border-t pt-2 mt-2"><span>Total</span><span>{formatMoney(order.total)}</span></div>
                 </div>

                 <div className="text-center pt-2 border-t border-slate-100">
                    <p className="text-xs text-slate-400 uppercase font-bold mb-1">Entregar a:</p>
                    <p className="text-sm font-bold text-slate-800">{order.client || 'Cliente'}</p>
                    <p className="text-xs text-slate-500">{order.isDelivery ? order.address : 'Retiro en Sucursal'}</p>
                 </div>
              </div>
           </div>
        </div>
      );
    };

    // --- LOGIN ---
    const LoginScreen = () => {
      const [email, setEmail] = useState("");
      const [pass, setPass] = useState("");
      const [error, setError] = useState("");
      const [loading, setLoading] = useState(false);

      const doLogin = async (e) => {
         e.preventDefault(); setLoading(true); setError("");
         try { await auth.signInWithEmailAndPassword(email, pass); }
         catch(e) { setError("Credenciales incorrectas"); setLoading(false); }
      };

      return (
         <div className="h-full flex items-center justify-center bg-slate-900 px-4">
            <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 animate-enter">
               <div className="text-center mb-8">
                  <div className="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-700"><Icon name="store" size={32}/></div>
                  <h1 className="text-3xl font-black text-slate-800 tracking-tighter">HOMEMART</h1>
                  <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mt-1">Acceso Administrativo</p>
               </div>
               <form onSubmit={doLogin} className="space-y-4">
                  <div><label className="text-xs font-bold text-slate-500 uppercase ml-1">Usuario</label><input type="email" className="input-field mt-1" value={email} onChange={e=>setEmail(e.target.value)} required /></div>
                  <div><label className="text-xs font-bold text-slate-500 uppercase ml-1">Contraseña</label><input type="password" className="input-field mt-1" value={pass} onChange={e=>setPass(e.target.value)} required /></div>
                  {error && <div className="bg-red-50 text-red-500 text-xs font-bold p-3 rounded-lg flex items-center gap-2"><Icon name="alert-triangle" size={16}/> {error}</div>}
                  <button disabled={loading} className="btn btn-primary w-full py-4 text-lg mt-2">{loading ? '...' : 'INICIAR SESIÓN'}</button>
               </form>
            </div>
         </div>
      );
    };

    // --- MODULO ADMIN (REPORTES REPARADO) ---
    const AdminModule = ({ user, shift, updateShift }) => {
       const [tab, setTab] = useState('shift'); 
       const [startAmt, setStartAmt] = useState("");
       const [d1, setD1] = useState(new Date().toISOString().slice(0,10));
       const [d2, setD2] = useState(new Date().toISOString().slice(0,10));

       const openS = async () => { if(startAmt) { await getCollection('shifts').add({userId:user.uid, startAmount:parseFloat(startAmt), openedAt: firebase.firestore.FieldValue.serverTimestamp(), status:'open'}); updateShift(); Swal.fire("Caja Abierta", "", "success"); }};
       const closeS = async () => { if((await Swal.fire({title:'¿Cerrar Turno?', icon:"warning", showCancelButton:true, confirmButtonColor:"#ef4444"})).isConfirmed) { await getCollection('shifts').doc(shift.id).update({status:'closed', closedAt: firebase.firestore.FieldValue.serverTimestamp()}); updateShift(); Swal.fire("Turno Cerrado", "", "success"); }};
       
       const report = async (type) => {
          try {
             const sd = new Date(d1); const ed = new Date(d2); ed.setHours(23,59,59,999);
             const snap = await getCollection('orders').where('createdAt','>=',sd.toISOString()).where('createdAt','<=',ed.toISOString()).get();
             const data = snap.docs.map(d=>{const x=d.data(); return [x.displayId, new Date(x.createdAt).toLocaleDateString(), x.client || 'Anon', x.method, x.total.toFixed(2)]});
             if(data.length===0) return Swal.fire("Sin datos", "", "info");
             
             if(type==='pdf') { 
                 // Aseguramos acceso a librería cargada
                 const { jsPDF } = window.jspdf;
                 const doc = new jsPDF(); 
                 doc.text(`Reporte: ${d1} a ${d2}`, 14, 20); 
                 doc.autoTable({head:[['ID','Fecha','Cliente','Método','Total']], body:data, startY:30}); 
                 doc.save(`ventas.pdf`); 
             } else { 
                 const ws = XLSX.utils.aoa_to_sheet([['ID','Fecha','Cliente','Método','Total'], ...data]); 
                 const wb=XLSX.utils.book_new(); 
                 XLSX.utils.book_append_sheet(wb, ws, "Ventas"); 
                 XLSX.writeFile(wb, `ventas.xlsx`); 
             }
          } catch(e) { console.error(e); Swal.fire("Error", "Error al generar reporte", "error"); }
       };

       return (
          <div className="flex flex-col h-full bg-slate-50">
             <div className="p-4 bg-white border-b flex justify-center shrink-0">
                 <div className="bg-slate-100 p-1 rounded-xl flex">
                     <button onClick={()=>setTab('shift')} className={`px-6 py-2 rounded-lg text-xs font-bold transition-all ${tab==='shift'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Control Caja</button>
                     <button onClick={()=>setTab('reports')} className={`px-6 py-2 rounded-lg text-xs font-bold transition-all ${tab==='reports'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Reportes</button>
                 </div>
             </div>
             
             <div className="scroll-area p-6 flex flex-col items-center justify-start pt-10">
                {/* PANEL CAJA */}
                {tab === 'shift' && (
                   <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center border border-slate-200 animate-enter">
                      <div className={`w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 ${shift?'bg-green-100 text-green-600':'bg-slate-100 text-slate-400'}`}><Icon name={shift?'unlock':'lock'} size={32}/></div>
                      <h2 className="text-2xl font-bold mb-2 text-slate-800">{shift?'Turno Activo':'Caja Cerrada'}</h2>
                      {shift ? (<div className="space-y-6"><div className="bg-slate-50 p-4 rounded-xl border border-slate-200"><p className="text-xs font-bold text-slate-400 uppercase">Fondo Inicial</p><p className="text-3xl font-black text-slate-800">{formatMoney(shift.startAmount)}</p></div><button onClick={closeS} className="w-full btn btn-primary bg-red-500 hover:bg-red-600 shadow-red-200"><Icon name="lock" size={18}/> CERRAR TURNO</button></div>) 
                      : (<div className="space-y-4"><div className="relative"><span className="absolute left-4 top-3.5 text-slate-400 font-bold">C$</span><input type="number" className="w-full bg-slate-50 pl-10 pr-4 py-3 rounded-xl border-2 border-slate-200 outline-none text-xl font-bold text-center" placeholder="0.00" value={startAmt} onChange={e => setStartAmt(e.target.value)} /></div><button onClick={openS} disabled={!startAmt} className="btn btn-primary w-full py-3.5">ABRIR TURNO</button></div>)}
                   </div>
                )}
                
                {/* PANEL REPORTES */}
                {tab === 'reports' && (
                   <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm border border-slate-200 space-y-6 animate-enter">
                      <div className="flex items-center gap-3 text-indigo-700 font-bold text-lg border-b pb-4"><div className="p-2 bg-indigo-50 rounded-lg"><Icon name="file-text" size={24}/></div> Exportar Ventas</div>
                      <div className="space-y-4">
                          <div><label className="text-xs font-bold text-slate-400 uppercase ml-1">Fecha Inicio</label><input type="date" className="input-field mt-1" value={d1} onChange={e=>setD1(e.target.value)}/></div>
                          <div><label className="text-xs font-bold text-slate-400 uppercase ml-1">Fecha Fin</label><input type="date" className="input-field mt-1" value={d2} onChange={e=>setD2(e.target.value)}/></div>
                      </div>
                      <div className="flex gap-3 pt-4"><button onClick={()=>report('pdf')} className="flex-1 btn btn-primary bg-red-500 hover:bg-red-600 text-xs shadow-red-200"><Icon name="file" size={16}/> PDF</button><button onClick={()=>report('excel')} className="flex-1 btn btn-primary bg-green-600 hover:bg-green-700 text-xs shadow-green-200"><Icon name="sheet" size={16}/> Excel</button></div>
                   </div>
                )}
             </div>
          </div>
       );
    };

    // --- APP ---
    const App = () => {
      const [user, setUser] = useState(null);
      const [view, setView] = useState('pos');
      const [products, setProducts] = useState([]);
      const [cart, setCart] = useState([]);
      const [shift, setShift] = useState(null);
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(true);
      const [menuOpen, setMenuOpen] = useState(false);

      // POS
      const [search, setSearch] = useState("");
      const [cat, setCat] = useState("");
      const [selProd, setSelProd] = useState(null);
      const [showMobileCart, setShowMobileCart] = useState(false);
      const [showCheckout, setShowCheckout] = useState(false);
      const [disc, setDisc] = useState(0);
      const [taxOn, setTaxOn] = useState(false);

      // Inventory
      const [invModal, setInvModal] = useState(false);
      const [invEdit, setInvEdit] = useState(null);
      const [invForm, setInvForm] = useState({ name:'', sku:'', cat:'', img:'', price:'', stock:'', hasVars:false });
      const [invVars, setInvVars] = useState([]);

      // URL Track
      const trackId = new URLSearchParams(window.location.search).get('track');

      useEffect(() => {
        auth.onAuthStateChanged(async u => {
           if(trackId && !u) await auth.signInAnonymously();
           setUser(u);
           if(u && !trackId) {
              getCollection('products').onSnapshot(s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()})))); 
              getCollection('orders').orderBy('createdAt', 'desc').limit(50).onSnapshot(s => setOrders(s.docs.map(d => ({id:d.id, ...d.data()}))));
              checkShift(u.uid);
           }
           setLoading(false);
        });
      }, []);

      const checkShift = async (uid) => { const s = await getCollection('shifts').where('status','==','open').where('userId','==',uid).limit(1).get(); setShift(s.empty?null:{id:s.docs[0].id, ...s.docs[0].data()}); };

      const addToCart = (p, v=null) => {
         if(!shift) return Swal.fire({title: "Caja Cerrada", text: "Abre turno primero", icon: "warning"});
         const stock = v ? Number(v.stock) : Number(p.stock);
         if(stock<=0) return Swal.fire("Agotado", "", "error");
         const id = v ? `${p.id}-${v.name}` : p.id;
         const exist = cart.find(x=>x.cartId===id);
         if(exist && exist.qty>=stock) return Swal.fire("Stock Máximo", "", "info");
         if(exist) setCart(cart.map(x=>x.cartId===id ? {...x, qty:x.qty+1}:x));
         else setCart([...cart, {cartId:id, id:p.id, name:p.name, sku: p.sku || '', price:Number(v?v.price:p.price), isVariant:!!v, variantName:v?.name, qty:1, maxStock:stock, image:p.image}]);
      };
      
      const updateQty = (id, d) => setCart(cart.map(i=>i.cartId===id?{...i, qty:i.qty+d}:i).filter(i=>i.qty>0));
      const clearCart = () => setCart([]);
      const subtotal = cart.reduce((a,b)=>a+(b.price*b.qty),0);
      const discAmt = subtotal * (disc/100);
      const base = subtotal - discAmt;
      const tax = taxOn ? base * 0.15 : 0;
      const total = base + tax;

      const filteredProds = products.filter(p => {
          const s = search.toLowerCase();
          return (p.name.toLowerCase().includes(s) || (p.sku && p.sku.toLowerCase().includes(s))) && (!cat || p.category === cat);
      });
      const cats = [...new Set(products.map(p=>p.category).filter(Boolean))];
      const pendingCount = orders.filter(o => o.paymentStatus === 'pendiente').length;

      if(loading) return <div className="h-full w-full flex items-center justify-center bg-slate-50"><div className="w-16 h-16 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div></div>;
      if(trackId) return <div className="fixed inset-0 bg-white"><TrackingView trackId={trackId}/></div>;
      if(!user || (user.isAnonymous && !trackId)) return <LoginScreen/>;

      return (
        <div className="flex h-full w-full bg-slate-100 overflow-hidden relative">
          
          {/* MENU DRAWER */}
          <div className={`drawer ${menuOpen ? 'open' : ''}`}>
             <div className="drawer-overlay" onClick={()=>setMenuOpen(false)}></div>
             <div className="drawer-content shadow-2xl">
                 <div className="p-6 bg-indigo-900 text-white">
                     <h2 className="text-2xl font-black">HOMEMART</h2>
                     <p className="text-xs opacity-70 mt-1">{user.email}</p>
                 </div>
                 <div className="flex-1 p-4 space-y-2 overflow-y-auto">
                     <button onClick={()=>{setView('pos'); setMenuOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold ${view==='pos'?'bg-indigo-50 text-indigo-600':'text-slate-600 hover:bg-slate-50'}`}><Icon name="store"/> Punto de Venta</button>
                     <button onClick={()=>{setView('inv'); setMenuOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold ${view==='inv'?'bg-indigo-50 text-indigo-600':'text-slate-600 hover:bg-slate-50'}`}><Icon name="package"/> Inventario</button>
                     <button onClick={()=>{setView('admin'); setMenuOpen(false)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold ${view==='admin'?'bg-indigo-50 text-indigo-600':'text-slate-600 hover:bg-slate-50'}`}><Icon name="settings"/> Administración</button>
                 </div>
                 <div className="p-4 border-t">
                     <button onClick={()=>auth.signOut()} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-red-500 hover:bg-red-50"><Icon name="log-out"/> Cerrar Sesión</button>
                 </div>
             </div>
          </div>

          <main className="flex-1 flex flex-col h-full relative">
             <div className="bg-white p-3 border-b border-slate-200 flex justify-between items-center shrink-0 z-20 shadow-sm">
                 <div className="flex items-center gap-3">
                     <button onClick={()=>setMenuOpen(true)} className="p-2 hover:bg-slate-100 rounded-lg"><Icon name="menu" size={24} className="text-indigo-600"/></button>
                     <span className="font-black text-indigo-900 text-lg tracking-tight">HOMEMART</span>
                 </div>
                 <div className="flex items-center gap-2">
                     {shift ? <span className="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded-full border border-green-200">CAJA ABIERTA</span> : <span className="bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded-full border border-red-200">CERRADO</span>}
                 </div>
             </div>

             <div className="flex-1 relative overflow-hidden bg-slate-50">
                {view === 'pos' && (
                  <div className="h-full flex flex-col">
                     <div className="p-4 flex gap-3 z-10">
                        <div className="relative flex-1">
                           <div className="absolute left-3 top-3 text-slate-400"><Icon name="search" size={20}/></div>
                           <input className="w-full bg-white pl-10 pr-4 py-3 rounded-xl shadow-sm border border-slate-200 outline-none font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500" placeholder="Buscar por Nombre o SKU..." value={search} onChange={e=>setSearch(e.target.value)}/>
                        </div>
                        <select className="bg-white px-4 rounded-xl shadow-sm border border-slate-200 font-bold text-slate-600 outline-none w-28" value={cat} onChange={e=>setCat(e.target.value)}><option value="">Todo</option>{cats.map(c=><option key={c} value={c}>{c}</option>)}</select>
                     </div>

                     <div className="scroll-area px-4 pb-32">
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                           {filteredProds.map(p => {
                              const hasVars = p.variants?.length > 0;
                              const stock = hasVars ? p.variants.reduce((a,b)=>a+Number(b.stock),0) : Number(p.stock);
                              const price = hasVars ? p.variants[0].price : p.price;
                              const noStock = stock <= 0;
                              return (
                                 <div key={p.id} onClick={() => !noStock && (hasVars ? setSelProd(p) : addToCart(p))} 
                                    className={`bg-white p-3 rounded-2xl shadow-sm border border-slate-200 flex flex-col relative active:scale-95 transition-transform ${noStock?'opacity-60 grayscale':''}`}>
                                    <div className="h-32 bg-slate-50 rounded-xl mb-3 overflow-hidden flex items-center justify-center relative">
                                       {p.image ? <img src={p.image} className="w-full h-full object-cover"/> : <Icon name="package" size={40} className="text-slate-300"/>}
                                       {p.sku && <span className="absolute top-1 left-1 bg-white/90 text-slate-500 text-[9px] font-mono px-1 rounded border border-slate-200">{p.sku}</span>}
                                       {noStock && <span className="absolute inset-0 flex items-center justify-center bg-white/60 font-black text-red-500 border-2 border-red-500 rounded-lg m-6 -rotate-12">AGOTADO</span>}
                                    </div>
                                    <div className="flex-1 flex flex-col justify-between">
                                       <h3 className="font-bold text-slate-800 text-sm leading-tight mb-1">{p.name}</h3>
                                       <div className="flex justify-between items-end">
                                          <span className="text-base font-black text-indigo-600">{formatMoney(price)}</span>
                                          <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${stock<5?'bg-orange-100 text-orange-600':'bg-green-100 text-green-600'}`}>{stock} un.</span>
                                       </div>
                                    </div>
                                 </div>
                              );
                           })}
                        </div>
                     </div>
                     
                     {/* BOTONES FLOTANTES SUBIDOS (BOTTOM-24) */}
                     <div className="absolute bottom-24 right-5 flex flex-col gap-4 z-30">
                        <button onClick={()=>setView('orders')} className="bg-orange-500 text-white p-3.5 rounded-full shadow-xl shadow-orange-200 active:scale-90 relative">
                           <Icon name="list-ordered" size={24}/>
                           {pendingCount > 0 && <span className="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-white">{pendingCount}</span>}
                        </button>
                        <button onClick={()=>setShowMobileCart(true)} className="bg-indigo-600 text-white p-4 rounded-full shadow-2xl shadow-indigo-300 active:scale-90 relative">
                           <Icon name="shopping-cart" size={24}/>
                           {cart.length > 0 && <span className="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-white">{cart.reduce((a,b)=>a+b.qty,0)}</span>}
                        </button>
                     </div>
                  </div>
                )}

                {view === 'orders' && (
                   <div className="h-full flex flex-col">
                      <div className="p-4 bg-white border-b shrink-0"><h2 className="text-xl font-bold flex gap-2 items-center"><Icon name="list"/> Órdenes</h2></div>
                      <div className="scroll-area p-4 space-y-3 pb-24">
                         {orders.map(o => (
                            <div key={o.id} className={`p-4 rounded-xl border shadow-sm flex justify-between items-center bg-white ${o.paymentStatus==='pendiente'?'border-l-4 border-l-red-500':''}`}>
                               <div>
                                  <div className="flex gap-2 items-center mb-1"><span className="bg-slate-100 text-slate-600 text-[10px] font-bold px-1.5 rounded">{o.displayId}</span><span className={`text-[9px] font-bold px-1.5 rounded uppercase ${o.paymentStatus==='pagado'?'text-green-600 bg-green-50':'text-red-600 bg-red-50'}`}>{o.paymentStatus}</span></div>
                                  <p className="font-bold text-sm text-slate-800">{o.client}</p>
                                  <div className="flex gap-2 mt-1"><span className="text-[10px] text-slate-400">{new Date(o.createdAt).toLocaleDateString()}</span><span className="text-[9px] uppercase font-bold px-1.5 rounded bg-slate-100 text-slate-500">{o.status}</span></div>
                               </div>
                               <div className="text-right"><span className="block font-black text-lg text-slate-800">{formatMoney(o.total)}</span></div>
                            </div>
                         ))}
                      </div>
                   </div>
                )}

                {view === 'inv' && (
                   <div className="h-full flex flex-col">
                      <div className="p-4 bg-white border-b shrink-0 flex justify-between items-center">
                         <h2 className="text-xl font-bold flex gap-2 items-center"><Icon name="package"/> Inventario</h2>
                         <button onClick={()=>{setInvEdit(null); setInvForm({name:'',sku:'',cat:'',img:'',price:'',stock:'',hasVars:false}); setInvVars([]); setInvModal(true);}} className="btn btn-primary py-2 px-3 text-xs">+ Nuevo</button>
                      </div>
                      <div className="scroll-area p-4 space-y-2 pb-24">
                         {products.map(p => {
                            const stock = p.variants?.length ? p.variants.reduce((a,b)=>a+Number(b.stock),0) : Number(p.stock);
                            return (
                               <div key={p.id} onClick={()=>{
                                  setInvEdit(p); setInvForm({name:p.name, sku:p.sku||'', cat:p.category, img:p.image||'', price:p.price, stock:p.stock, hasVars:!!p.variants?.length}); setInvVars(p.variants||[]); setInvModal(true);
                               }} className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50">
                                  <div className="flex gap-3 items-center">
                                     <div className="w-10 h-10 bg-slate-100 rounded-lg overflow-hidden flex items-center justify-center border border-slate-200">{p.image?<img src={p.image} className="w-full h-full object-cover"/>:<Icon name="box" className="text-slate-300"/>}</div>
                                     <div>
                                        <p className="font-bold text-sm text-slate-800">{p.name}</p>
                                        <div className="flex gap-2 items-center mt-0.5"><span className="text-[10px] font-mono text-slate-500">{p.sku || 'SIN SKU'}</span><span className={`text-[10px] font-bold ${stock<5?'text-red-500':'text-green-600'}`}>Stock: {stock}</span></div>
                                     </div>
                                  </div>
                                  <Icon name="edit-3" size={16} className="text-slate-300"/>
                               </div>
                            );
                         })}
                      </div>
                   </div>
                )}

                {view === 'admin' && (
                   <AdminModule user={user} shift={shift} updateShift={()=>checkShift(user.uid)} />
                )}
             </div>
          </main>

          {/* SIDEBAR CARRITO */}
          <div className={`fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl z-50 transform transition-transform duration-300 flex flex-col h-full ${showMobileCart?'translate-x-0':'translate-x-full'}`}>
             <div className="p-4 border-b flex justify-between items-center bg-slate-50 shrink-0">
                <div className="flex items-center gap-2 font-bold text-slate-800"><Icon name="shopping-cart" className="text-indigo-600"/> <span>Carrito ({cart.length})</span></div>
                <div className="flex gap-2">
                   <button onClick={clearCart} className="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-lg">LIMPIAR</button>
                   <button onClick={()=>setShowMobileCart(false)} className="p-1.5 bg-slate-200 rounded-full"><Icon name="x" size={18}/></button>
                </div>
             </div>
             <div className="scroll-area p-3 space-y-3 pb-32">
                {cart.length===0 ? <div className="h-full flex flex-col items-center justify-center text-slate-300 gap-3"><Icon name="shopping-basket" size={64}/><p className="font-bold">Vacío</p></div> : 
                   cart.map(item => (
                      <div key={item.cartId} className="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                         <div className="flex-1 pr-3 overflow-hidden">
                            <p className="font-bold text-sm text-slate-800 truncate">{item.name}</p>
                            <div className="flex gap-2 text-xs text-slate-500 mt-0.5"><span>{item.variantName || 'Std'}</span>•<span>{formatMoney(item.price)}</span></div>
                         </div>
                         <div className="flex items-center gap-3">
                            <div className="flex items-center bg-slate-50 rounded-lg border border-slate-200 h-8">
                               <button onClick={()=>updateQty(item.cartId, -1)} className="px-2.5 h-full text-slate-500 font-bold">-</button>
                               <span className="w-6 text-center text-sm font-bold">{item.qty}</span>
                               <button onClick={()=>updateQty(item.cartId, 1)} className="px-2.5 h-full text-indigo-600 font-bold">+</button>
                            </div>
                            <span className="font-bold text-sm w-16 text-right">{formatMoney(item.price*item.qty)}</span>
                         </div>
                      </div>
                   ))
                }
             </div>
             <div className="p-5 bg-white border-t shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-20 shrink-0 pb-safe">
                <div className="flex gap-3 mb-4">
                   <div className="flex-1 relative bg-slate-50 rounded-lg border border-slate-200 flex items-center overflow-hidden h-10"><span className="pl-3 text-xs font-bold text-slate-400">Desc%</span><input type="number" min="0" max="100" className="w-full h-full px-2 text-sm font-bold bg-transparent outline-none text-center" value={disc} onChange={e=>setDisc(Math.min(100,Math.max(0,e.target.value)))}/></div>
                   <button onClick={()=>setTaxOn(!taxOn)} className={`flex-1 rounded-lg text-xs font-bold border transition-all flex items-center justify-center gap-2 ${taxOn?'bg-indigo-50 text-indigo-700 border-indigo-200':'bg-slate-50 text-slate-500 border-slate-200'}`}>{taxOn?<Icon name="check-square" size={16}/>:<Icon name="square" size={16}/>} IVA 15%</button>
                </div>
                <div className="space-y-2 text-sm mb-4">
                   <div className="flex justify-between text-slate-500"><span>Subtotal</span><span>{formatMoney(subtotal)}</span></div>
                   {disc > 0 && <div className="flex justify-between text-green-600 font-bold"><span>Desc {disc}%</span><span>-{formatMoney(discAmt)}</span></div>}
                   <div className={`flex justify-between ${taxOn?'text-indigo-600 font-bold':'text-slate-400'}`}><span>IVA 15%</span><span>{formatMoney(tax)}</span></div>
                   <div className="flex justify-between text-xl font-black text-slate-900 border-t pt-2 mt-1"><span>Total</span><span>{formatMoney(total)}</span></div>
                </div>
                <button onClick={()=>setShowCheckout(true)} disabled={cart.length===0} className="btn btn-primary w-full py-3.5 text-base shadow-lg shadow-indigo-200">COBRAR <Icon name="arrow-right" size={20}/></button>
             </div>
          </div>

          {/* MODAL INVENTARIO (CON SKU) */}
          {invModal && (
             <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-enter">
                <div className="bg-white w-full max-w-lg rounded-2xl flex flex-col max-h-[90vh] overflow-hidden shadow-2xl">
                   <div className="p-4 border-b flex justify-between items-center bg-slate-50 shrink-0"><h3 className="font-bold text-lg text-slate-800">{invEdit?'Editar':'Nuevo'}</h3><button onClick={()=>setInvModal(false)}><Icon name="x"/></button></div>
                   <form onSubmit={async(e)=>{
                      e.preventDefault();
                      const d = { name: invForm.name, sku: invForm.sku, category: invForm.cat, image: invForm.img, price: invForm.hasVars?0:Number(invForm.price), stock: invForm.hasVars?0:Number(invForm.stock), variants: invForm.hasVars?invVars.map(v=>({name:v.name,price:Number(v.price),stock:Number(v.stock)})):[] };
                      if(invEdit) await getCollection('products').doc(invEdit.id).update(d); else await getCollection('products').add(d);
                      setInvModal(false); Swal.fire({toast:true,title:"Guardado",icon:"success",timer:1500,position:'top',showConfirmButton:false});
                   }} className="scroll-area p-6 space-y-5 bg-white pb-40">
                      <div><label className="text-xs font-bold text-slate-400 uppercase">Nombre</label><input className="input-field mt-1" value={invForm.name} onChange={e=>setInvForm({...invForm,name:e.target.value})} required/></div>
                      <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-400 uppercase">SKU / Código</label><input className="input-field mt-1 font-mono uppercase" value={invForm.sku} onChange={e=>setInvForm({...invForm,sku:e.target.value})} placeholder="CODE-123"/></div><div><label className="text-xs font-bold text-slate-400 uppercase">Categoría</label><input className="input-field mt-1" list="cats" value={invForm.cat} onChange={e=>setInvForm({...invForm,cat:e.target.value})}/><datalist id="cats"><option value="Ropa"/><option value="Tecnología"/><option value="Hogar"/></datalist></div></div>
                      <div><label className="text-xs font-bold text-slate-400 uppercase">Imagen URL</label><input className="input-field mt-1" value={invForm.img} onChange={e=>setInvForm({...invForm,img:e.target.value})}/></div>
                      <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex items-center gap-3"><input type="checkbox" className="w-5 h-5 accent-indigo-600 rounded" checked={invForm.hasVars} onChange={e=>setInvForm({...invForm,hasVars:e.target.checked})}/><label className="font-bold text-indigo-900 text-sm">Habilitar Variantes</label></div>
                      {!invForm.hasVars ? (<div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-400 uppercase">Precio</label><input type="number" step="0.01" className="input-field mt-1 font-bold" value={invForm.price} onChange={e=>setInvForm({...invForm,price:e.target.value})}/></div><div><label className="text-xs font-bold text-slate-400 uppercase">Stock</label><input type="number" className="input-field mt-1 font-bold" value={invForm.stock} onChange={e=>setInvForm({...invForm,stock:e.target.value})}/></div></div>) 
                      : (<div className="space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-200"><p className="text-xs font-bold text-slate-400 uppercase">Lista de Variantes</p>{invVars.map((v, i) => (<div key={i} className="flex gap-2 items-center"><input className="input-field py-2 text-xs" placeholder="Nombre (Ej. XL)" value={v.name} onChange={e=>{const n=[...invVars];n[i].name=e.target.value;setInvVars(n)}}/><input type="number" className="input-field py-2 text-xs w-24 text-center" placeholder="Precio" value={v.price} onChange={e=>{const n=[...invVars];n[i].price=e.target.value;setInvVars(n)}}/><input type="number" className="input-field py-2 text-xs w-20 text-center" placeholder="Stock" value={v.stock} onChange={e=>{const n=[...invVars];n[i].stock=e.target.value;setInvVars(n)}}/><button type="button" onClick={()=>setInvVars(invVars.filter((_,x)=>x!==i))} className="text-red-400 p-2 hover:bg-red-50 rounded"><Icon name="trash-2" size={16}/></button></div>))}<button type="button" onClick={()=>setInvVars([...invVars, {name:'', price:'', stock:''}])} className="w-full py-3 border-2 border-dashed border-indigo-300 text-indigo-600 rounded-xl text-xs font-bold hover:bg-indigo-50 transition-colors">+ Agregar Variante</button></div>)}
                      <div className="pt-4"><button className="btn btn-primary w-full py-4 text-lg">GUARDAR</button></div>
                   </form>
                </div>
             </div>
          )}

          {/* MODAL CHECKOUT */}
          {showCheckout && <CheckoutModal cart={cart} totals={{subtotal, discAmt, disc, tax, taxOn, total}} onClose={()=>setShowCheckout(false)} onSuccess={()=>{clearCart(); setShowCheckout(false); setShowMobileCart(false); setDisc(0);}} shift={shift}/>}

          {/* MODAL VARIANTES SELECT POS */}
          {selProd && (
            <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm animate-enter">
               <div className="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl">
                  <div className="p-4 border-b flex justify-between items-center bg-slate-50"><h3 className="font-bold text-slate-800">{selProd.name}</h3><button onClick={()=>setSelProd(null)} className="p-1 hover:bg-slate-200 rounded-full"><Icon name="x"/></button></div>
                  <div className="p-2 max-h-80 overflow-y-auto">
                     {selProd.variants.map((v,i)=>(
                        <button key={i} onClick={()=>{addToCart(selProd,v); setSelProd(null)}} className="w-full flex justify-between items-center p-4 hover:bg-indigo-50 border-b last:border-0 transition-colors group">
                           <div className="text-left"><p className="font-bold text-slate-700 text-sm">{v.name}</p><p className="text-xs text-slate-400">Stock: {v.stock}</p></div>
                           <span className="font-bold text-indigo-600 bg-indigo-100 px-3 py-1 rounded-lg text-sm">{formatMoney(v.price)}</span>
                        </button>
                     ))}
                  </div>
               </div>
            </div>
          )}

        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>


