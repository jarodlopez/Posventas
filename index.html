<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Homemart POS - ventas</title>
  <meta name="theme-color" content="#4338ca">

  <!-- ==========================================
       LIBRER√çAS DE PRODUCCI√ìN
       ========================================== -->
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Iconos -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <!-- Alertas -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Reportes (Excel & PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <!-- React Core -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase v8 (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: #f1f5f9;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }

    #root { height: 100%; display: flex; flex-direction: column; }

    /* Scrollbars invisibles pero funcionales */
    .scroll-area {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      flex: 1;
    }
    .scroll-area::-webkit-scrollbar { display: none; }
    
    /* Inputs Estilizados */
    .input-field {
      width: 100%; background: white; border: 1px solid #cbd5e1; border-radius: 0.75rem;
      padding: 0.75rem 1rem; font-size: 0.95rem; outline: none; transition: all 0.2s;
      color: #1e293b;
    }
    .input-field:focus { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

    /* Botones */
    .btn {
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      font-weight: 700; padding: 0.85rem 1.5rem; border-radius: 0.75rem;
      transition: transform 0.1s; cursor: pointer; user-select: none;
    }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
    .btn-secondary { background: white; color: #475569; border: 1px solid #e2e8f0; }

    /* Animaciones */
    @keyframes enter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-enter { animation: enter 0.3s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // ==========================================
    // 1. MOTOR DE BASE DE DATOS (FIREBASE)
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyDF374bHcODY8N0R78HE8kZpmjeGeuhniU",
      authDomain: "posdeventas-a03ca.firebaseapp.com",
      projectId: "posdeventas-a03ca",
      storageBucket: "posdeventas-a03ca.firebasestorage.app",
      messagingSenderId: "975141670948",
      appId: "1:975141670948:web:e58ed3da11878ecfdf88b1"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // CR√çTICO: Usamos __app_id del entorno o un fallback consistente para recuperar datos previos.
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'pos-pro-mobile-v2';
    
    // Helper de rutas seguro
    const getCollection = (name) => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(name);

    const { useState, useEffect, useMemo } = React;

    // ==========================================
    // 2. COMPONENTES UI REUTILIZABLES
    // ==========================================
    const Icon = ({ name, size = 20, className = "" }) => {
      useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
      return <i data-lucide={name} width={size} height={size} className={className}></i>;
    };

    const formatMoney = (amount) => new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'NIO' }).format(amount).replace('NIO', 'C$');

    // ==========================================
    // 3. VISTA DE RASTREO (CLIENTE)
    // ==========================================
    const TrackingView = ({ trackId }) => {
      const [order, setOrder] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        // Buscar por ID visual
        const unsub = getCollection('orders').where('displayId', '==', trackId).limit(1)
          .onSnapshot(snap => {
            if(!snap.empty) setOrder({id: snap.docs[0].id, ...snap.docs[0].data()});
            setLoading(false);
          });
        return unsub;
      }, [trackId]);

      if(loading) return <div className="h-full flex items-center justify-center bg-slate-100"><div className="w-12 h-12 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div></div>;
      if(!order) return <div className="h-full flex flex-col items-center justify-center text-gray-400 gap-4"><Icon name="search-x" size={64}/><h2 className="text-xl font-bold">Orden no encontrada</h2></div>;

      const steps = ['recibido', 'proceso', 'ruta', 'entregado'];
      let stepIdx = steps.indexOf(order.status);
      const progress = order.status==='cancelado' ? 100 : ((stepIdx === -1 ? 0 : stepIdx) / (steps.length-1)) * 100;
      const color = order.status==='cancelado' ? 'bg-red-500' : (order.status==='proceso' ? 'bg-orange-500' : 'bg-green-500');

      return (
        <div className="flex flex-col h-full bg-slate-50 overflow-hidden">
           <div className="bg-indigo-900 text-white pt-10 pb-20 px-6 rounded-b-[2.5rem] shadow-xl text-center relative overflow-hidden">
              <div className="relative z-10">
                 <div className="bg-white/10 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 backdrop-blur-sm"><Icon name="package" size={32} color="white"/></div>
                 <h1 className="text-2xl font-black tracking-tight">HOMEMART</h1>
                 <div className="mt-2 inline-block px-4 py-1 bg-white/20 rounded-full text-sm font-bold backdrop-blur">#{order.displayId}</div>
              </div>
           </div>
           
           <div className="px-5 -mt-12 flex-1 scroll-area pb-10">
              <div className="bg-white rounded-2xl shadow-lg p-6 mb-4 animate-enter">
                 <div className="flex justify-between items-center mb-4">
                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Estado del Pedido</span>
                    <span className={`px-3 py-1 rounded-full text-xs font-bold text-white uppercase ${color}`}>{order.status}</span>
                 </div>
                 <div className="relative pt-2">
                    <div className="w-full bg-gray-100 h-2.5 rounded-full overflow-hidden">
                       <div className={`h-full transition-all duration-1000 rounded-full ${color}`} style={{width: `${progress}%`}}></div>
                    </div>
                    <div className="flex justify-between text-[10px] font-bold text-gray-400 mt-2 uppercase"><span>Recibido</span><span>En Proceso</span><span>En Ruta</span><span>Entregado</span></div>
                 </div>
              </div>

              <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 animate-enter" style={{animationDelay: '0.1s'}}>
                 <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4 border-b pb-2"><Icon name="shopping-bag" size={18} className="text-indigo-600"/> Resumen</h3>
                 <div className="space-y-3 mb-4">
                    {order.cart?.map((item, idx) => (
                       <div key={idx} className="flex justify-between items-start text-sm">
                          <div className="flex gap-3">
                             <span className="font-bold text-slate-500 bg-slate-100 px-2 rounded h-fit">{item.qty}x</span>
                             <div><p className="font-bold text-slate-700">{item.name}</p>{item.variantName && <p className="text-xs text-slate-400">{item.variantName}</p>}</div>
                          </div>
                          <span className="font-bold text-slate-800">{formatMoney(item.price * item.qty)}</span>
                       </div>
                    ))}
                 </div>
                 <div className="bg-slate-50 p-4 rounded-xl space-y-2 text-sm">
                    <div className="flex justify-between text-slate-500"><span>Subtotal</span><span>{formatMoney(order.subtotal)}</span></div>
                    {order.discountAmount > 0 && <div className="flex justify-between text-green-600 font-bold"><span>Descuento</span><span>-{formatMoney(order.discountAmount)}</span></div>}
                    <div className="flex justify-between text-slate-500"><span>IVA</span><span>{formatMoney(order.tax)}</span></div>
                    {order.isDelivery && <div className="flex justify-between text-indigo-600 font-bold"><span>Env√≠o</span><span>{formatMoney(order.shipCost)}</span></div>}
                    <div className="flex justify-between text-xl font-black text-slate-900 border-t pt-2 mt-2"><span>Total</span><span>{formatMoney(order.total)}</span></div>
                 </div>
              </div>
           </div>
        </div>
      );
    };

    // ==========================================
    // 4. PANTALLA DE ACCESO (LOGIN)
    // ==========================================
    const LoginScreen = () => {
      const [email, setEmail] = useState("");
      const [pass, setPass] = useState("");
      const [error, setError] = useState("");
      const [loading, setLoading] = useState(false);

      const doLogin = async (e) => {
         e.preventDefault(); setLoading(true); setError("");
         try { await auth.signInWithEmailAndPassword(email, pass); }
         catch(e) { setError("Credenciales incorrectas"); setLoading(false); }
      };

      return (
         <div className="h-full flex items-center justify-center bg-slate-900 px-4">
            <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 animate-enter">
               <div className="text-center mb-8">
                  <div className="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-700"><Icon name="store" size={32}/></div>
                  <h1 className="text-3xl font-black text-slate-800 tracking-tighter">HOMEMART</h1>
                  <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mt-1">Punto de Venta</p>
               </div>
               <form onSubmit={doLogin} className="space-y-4">
                  <div>
                     <label className="text-xs font-bold text-slate-500 uppercase ml-1">Usuario</label>
                     <input type="email" className="input-field mt-1" value={email} onChange={e=>setEmail(e.target.value)} required />
                  </div>
                  <div>
                     <label className="text-xs font-bold text-slate-500 uppercase ml-1">Contrase√±a</label>
                     <input type="password" className="input-field mt-1" value={pass} onChange={e=>setPass(e.target.value)} required />
                  </div>
                  {error && <div className="bg-red-50 text-red-500 text-xs font-bold p-3 rounded-lg flex items-center gap-2"><Icon name="alert-triangle" size={16}/> {error}</div>}
                  <button disabled={loading} className="btn btn-primary w-full py-4 text-lg mt-2">{loading ? 'Accediendo...' : 'INICIAR SESI√ìN'}</button>
               </form>
            </div>
         </div>
      );
    };

    // ==========================================
    // 5. M√ìDULO POS (VENTA)
    // ==========================================
    const POSModule = ({ products, shift, cart, addToCart, updateQty, clearCart }) => {
       const [search, setSearch] = useState("");
       const [cat, setCat] = useState("");
       const [selProd, setSelProd] = useState(null); // Para modal variantes
       const [showMobileCart, setShowMobileCart] = useState(false);
       const [showCheckout, setShowCheckout] = useState(false);
       
       // Finanzas
       const [disc, setDisc] = useState(0);
       const [taxOn, setTaxOn] = useState(false);

       const subtotal = cart.reduce((a,b)=>a+(b.price*b.qty),0);
       const discAmt = subtotal * (disc/100);
       const base = subtotal - discAmt;
       const tax = taxOn ? base * 0.15 : 0;
       const total = base + tax;

       const filtered = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) && (!cat || p.category === cat));
       const cats = [...new Set(products.map(p=>p.category).filter(Boolean))];

       return (
          <div className="flex h-full relative bg-slate-100 overflow-hidden">
             {/* CAT√ÅLOGO */}
             <div className="flex-1 flex flex-col h-full min-w-0">
                <div className="bg-white p-4 border-b border-slate-200 flex gap-3 shadow-sm z-10 shrink-0">
                   <div className="relative flex-1">
                      <div className="absolute left-3 top-3 text-slate-400"><Icon name="search" size={20}/></div>
                      <input className="w-full bg-slate-100 pl-10 pr-4 py-2.5 rounded-xl outline-none font-bold text-slate-700 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="Buscar producto..." value={search} onChange={e=>setSearch(e.target.value)}/>
                   </div>
                   <select className="bg-slate-100 px-4 rounded-xl font-bold text-slate-600 outline-none focus:ring-2 focus:ring-indigo-500" value={cat} onChange={e=>setCat(e.target.value)}><option value="">Todo</option>{cats.map(c=><option key={c} value={c}>{c}</option>)}</select>
                </div>

                <div className="scroll-area p-4 pb-24 md:pb-4">
                   {/* FIX: Grid m√°s amplio y tarjetas m√°s altas para mejor visibilidad */}
                   <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                      {filtered.map(p => {
                         const hasVars = p.variants && p.variants.length > 0;
                         const stock = hasVars ? p.variants.reduce((a,b)=>a+Number(b.stock),0) : Number(p.stock);
                         const price = hasVars ? p.variants[0].price : p.price;
                         const noStock = stock <= 0;

                         return (
                            <div key={p.id} onClick={() => !noStock && (hasVars ? setSelProd(p) : addToCart(p))} 
                               className={`bg-white p-3 rounded-2xl shadow-sm border border-slate-200 flex flex-col relative transition-transform active:scale-95 cursor-pointer hover:shadow-md ${noStock?'opacity-60 grayscale':''}`}>
                               <div className="h-40 bg-slate-50 rounded-xl mb-3 overflow-hidden flex items-center justify-center relative">
                                  {p.image ? <img src={p.image} className="w-full h-full object-cover"/> : <Icon name="package" size={48} className="text-slate-300"/>}
                                  {hasVars && <span className="absolute bottom-2 right-2 bg-slate-900/80 backdrop-blur text-white text-[10px] font-bold px-2 py-1 rounded-lg">OPCIONES</span>}
                                  {noStock && <span className="absolute inset-0 flex items-center justify-center bg-white/60 font-black text-red-500 rotate-[-12deg] text-xl border-4 border-red-500 rounded-lg m-8">AGOTADO</span>}
                               </div>
                               <div className="flex-1 flex flex-col justify-between px-1">
                                  <h3 className="font-bold text-slate-700 leading-snug mb-1">{p.name}</h3>
                                  <div className="flex justify-between items-end mt-2">
                                     <span className="text-lg font-black text-indigo-600">{formatMoney(price)}</span>
                                     <span className={`text-xs font-bold px-2 py-1 rounded-lg ${stock<5?'bg-orange-100 text-orange-600':'bg-green-100 text-green-600'}`}>Stock: {stock}</span>
                                  </div>
                               </div>
                            </div>
                         );
                      })}
                   </div>
                </div>
             </div>

             {/* BOT√ìN FLOTANTE M√ìVIL */}
             <button onClick={()=>setShowMobileCart(true)} className="md:hidden fixed bottom-24 right-5 bg-indigo-600 text-white p-4 rounded-full shadow-2xl z-30 flex items-center justify-center active:scale-90 transition-transform">
                <Icon name="shopping-cart" size={24}/>
                {cart.length>0 && <span className="absolute -top-1 -right-1 bg-red-500 border-2 border-white text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full">{cart.reduce((a,b)=>a+b.qty,0)}</span>}
             </button>

             {/* SIDEBAR CARRITO */}
             <div className={`fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl z-50 transform transition-transform duration-300 flex flex-col ${showMobileCart?'translate-x-0':'translate-x-full md:translate-x-0 md:static md:shadow-none md:border-l'}`}>
                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                   <div className="flex items-center gap-2 text-slate-800 font-bold"><Icon name="shopping-cart" className="text-indigo-600"/> <span>Carrito ({cart.reduce((a,b)=>a+b.qty,0)})</span></div>
                   <div className="flex gap-2">
                      <button onClick={clearCart} className="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-lg hover:bg-red-100 transition-colors">LIMPIAR</button>
                      <button onClick={()=>setShowMobileCart(false)} className="md:hidden p-1.5 bg-slate-200 rounded-full"><Icon name="x" size={18}/></button>
                   </div>
                </div>

                <div className="scroll-area p-3 space-y-3 pb-32 md:pb-4">
                   {cart.length===0 ? 
                      <div className="h-full flex flex-col items-center justify-center text-slate-300 gap-3"><Icon name="shopping-basket" size={64} strokeWidth={1}/><p className="font-bold">Tu carrito est√° vac√≠o</p></div> 
                   : cart.map(item => (
                      <div key={item.cartId} className="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                         <div className="flex-1 pr-3 overflow-hidden">
                            <p className="font-bold text-sm text-slate-800 truncate">{item.name}</p>
                            <div className="flex gap-2 text-xs text-slate-500 mt-0.5"><span>{item.variantName || 'Est√°ndar'}</span>‚Ä¢<span>{formatMoney(item.price)}</span></div>
                         </div>
                         <div className="flex items-center gap-3">
                            <div className="flex items-center bg-slate-50 rounded-lg border border-slate-200 h-8">
                               <button onClick={()=>updateQty(item.cartId, -1)} className="px-2.5 h-full text-slate-500 hover:text-red-500 font-bold text-lg">-</button>
                               <span className="w-6 text-center text-sm font-bold">{item.qty}</span>
                               <button onClick={()=>updateQty(item.cartId, 1)} className="px-2.5 h-full text-indigo-600 hover:bg-indigo-50 font-bold text-lg rounded-r-lg">+</button>
                            </div>
                            <span className="font-bold text-sm w-16 text-right">{formatMoney(item.price*item.qty)}</span>
                         </div>
                      </div>
                   ))}
                </div>

                <div className="p-5 bg-white border-t border-slate-200 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-20 shrink-0 pb-safe">
                   <div className="flex gap-3 mb-4">
                      <div className="flex-1 relative bg-slate-50 rounded-lg border border-slate-200 flex items-center overflow-hidden h-10"><span className="pl-3 text-xs font-bold text-slate-400">Desc%</span><input type="number" min="0" max="100" className="w-full h-full px-2 text-sm font-bold bg-transparent outline-none text-center" value={disc} onChange={e=>setDisc(Math.min(100,Math.max(0,e.target.value)))}/></div>
                      <button onClick={()=>setTaxOn(!taxOn)} className={`flex-1 rounded-lg text-xs font-bold border transition-all flex items-center justify-center gap-2 ${taxOn?'bg-indigo-50 text-indigo-700 border-indigo-200':'bg-slate-50 text-slate-500 border-slate-200'}`}>{taxOn?<Icon name="check-square" size={16}/>:<Icon name="square" size={16}/>} IVA 15%</button>
                   </div>
                   <div className="space-y-2 text-sm mb-4">
                      <div className="flex justify-between text-slate-500"><span>Subtotal</span><span>{formatMoney(subtotal)}</span></div>
                      {disc > 0 && <div className="flex justify-between text-green-600 font-bold"><span>Descuento {disc}%</span><span>-{formatMoney(discAmt)}</span></div>}
                      <div className={`flex justify-between ${taxOn?'text-indigo-600 font-bold':'text-slate-400'}`}><span>IVA 15%</span><span>{formatMoney(tax)}</span></div>
                      <div className="flex justify-between text-xl font-black text-slate-900 border-t pt-2 mt-1"><span>Total</span><span>{formatMoney(total)}</span></div>
                   </div>
                   <button onClick={()=>setShowCheckout(true)} disabled={cart.length===0} className="btn btn-primary w-full py-3.5 text-base shadow-lg shadow-indigo-200">COBRAR <Icon name="arrow-right" size={20}/></button>
                </div>
             </div>

             {/* MODAL VARIANTES */}
             {selProd && (
                <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm animate-enter">
                   <div className="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl">
                      <div className="p-4 border-b flex justify-between items-center bg-slate-50"><h3 className="font-bold text-slate-800">{selProd.name}</h3><button onClick={()=>setSelProd(null)} className="p-1 hover:bg-slate-200 rounded-full"><Icon name="x"/></button></div>
                      <div className="p-2 max-h-80 overflow-y-auto">
                         {selProd.variants.map((v,i)=>(
                            <button key={i} onClick={()=>{addToCart(selProd,v); setSelProd(null)}} className="w-full flex justify-between items-center p-4 hover:bg-indigo-50 border-b last:border-0 transition-colors group">
                               <div className="text-left"><p className="font-bold text-slate-700 text-sm">{v.name}</p><p className="text-xs text-slate-400">Stock: {v.stock}</p></div>
                               <span className="font-bold text-indigo-600 bg-indigo-100 px-3 py-1 rounded-lg text-sm">{formatMoney(v.price)}</span>
                            </button>
                         ))}
                      </div>
                   </div>
                </div>
             )}

             {showCheckout && <CheckoutModal cart={cart} totals={{subtotal, discAmt, disc, tax, taxOn, total}} onClose={()=>setShowCheckout(false)} onSuccess={()=>{clearCart(); setShowCheckout(false); setShowMobileCart(false); setDisc(0);}} shift={shift}/>}
          </div>
       );
    };

    // ==========================================
    // 6. CHECKOUT
    // ==========================================
    const CheckoutModal = ({ cart, totals, onClose, onSuccess, shift }) => {
       const [client, setClient] = useState("");
       const [phone, setPhone] = useState("");
       const [method, setMethod] = useState("Efectivo");
       const [isDel, setIsDel] = useState(false);
       const [addr, setAddr] = useState("");
       const [ship, setShip] = useState(0);
       const [paid, setPaid] = useState("");
       const [loading, setLoading] = useState(false);
       
       const user = auth.currentUser;
       const finalTotal = totals.total + (isDel ? Number(ship) : 0);
       const change = Number(paid) - finalTotal;

       const confirm = async () => {
          setLoading(true);
          try {
             // Generar ID
             const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
             const ref = getCollection('counters').doc('orders_'+dateStr);
             let seq = 1;
             await db.runTransaction(async t => {
                const doc = await t.get(ref);
                if(doc.exists) { seq = doc.data().val + 1; t.update(ref, {val: seq}); } 
                else { t.set(ref, {val: 1}); }
             });
             const oid = `HM-${dateStr}-${String(seq).padStart(3,'0')}`;

             const orderData = {
                displayId: oid, createdAt: new Date().toISOString(), cart, client, phone, method, isDelivery: isDel, address: isDel?addr:'', shipCost: Number(ship),
                subtotal: totals.subtotal, discountAmount: totals.discAmt, tax: totals.tax, taxRate: totals.taxOn?0.15:0, total: finalTotal,
                status: 'recibido', paymentStatus: (method==='Efectivo' && Number(paid)>=finalTotal)?'pagado':'pendiente',
                seller: user.email, shiftId: shift ? shift.id : 'closed', paidAmount: Number(paid), change: method==='Efectivo'?change:0
             };

             await getCollection('orders').doc(oid).set(orderData);

             // Update Stock
             cart.forEach(async item => {
                const ref = getCollection('products').doc(item.id);
                if(!item.isVariant) await ref.update({stock: firebase.firestore.FieldValue.increment(-item.qty)});
                else {
                   await db.runTransaction(async t => {
                      const d = await t.get(ref); if(!d.exists) return;
                      const vars = d.data().variants || [];
                      const newVars = vars.map(v => v.name===item.variantName ? {...v, stock: Math.max(0, Number(v.stock)-item.qty)} : v);
                      t.update(ref, {variants: newVars});
                   });
                }
             });

             // WhatsApp
             const itemsList = cart.map(i => `‚Ä¢ ${i.qty}x ${i.name} ${i.variantName?`(${i.variantName})`:''}`).join('\n');
             const link = `${window.location.origin}${window.location.pathname}?track=${oid}`;
             const msg = `Hola *${client}*, pedido *${oid}* confirmado.\n\nüõí *Detalle:*\n${itemsList}\n\nüí∞ Total: ${formatMoney(finalTotal)}\nüõµ Entrega: ${isDel?'Domicilio':'Retiro'}\n\nüîó Rastreo: ${link}`;
             if(phone) window.open(`https://wa.me/505${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');

             Swal.fire({title:'Venta Exitosa', text:`Orden ${oid}`, icon:'success', timer:2000, showConfirmButton:false});
             onSuccess();
          } catch(e) { console.error(e); Swal.fire('Error', 'No se pudo guardar la venta', 'error'); }
          setLoading(false);
       };

       return (
          <div className="fixed inset-0 z-[80] bg-white md:bg-black/50 md:flex md:items-center md:justify-center animate-enter">
             <div className="bg-white w-full h-full md:h-auto md:max-w-lg md:rounded-2xl flex flex-col overflow-hidden shadow-2xl">
                <div className="bg-slate-900 text-white p-4 flex justify-between items-center shrink-0"><h3 className="font-bold flex gap-2"><Icon name="wallet"/> Finalizar Venta</h3><button onClick={onClose}><Icon name="x"/></button></div>
                <div className="scroll-area p-6 space-y-5 bg-slate-50">
                   <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 space-y-3">
                      <div className="flex items-center gap-2 text-indigo-600 font-bold text-xs uppercase tracking-wider border-b pb-2"><Icon name="user" size={14}/> Datos Cliente</div>
                      <input className="input-field" placeholder="Nombre Completo" value={client} onChange={e=>setClient(e.target.value)}/>
                      <div className="grid grid-cols-2 gap-3"><input className="input-field" type="tel" placeholder="WhatsApp" value={phone} onChange={e=>setPhone(e.target.value)}/><select className="input-field" value={method} onChange={e=>setMethod(e.target.value)}><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></div>
                   </div>
                   <div className={`p-4 rounded-xl border transition-colors ${isDel?'bg-indigo-50 border-indigo-200':'bg-white border-slate-200 shadow-sm'}`}>
                      <div className="flex justify-between items-center"><span className="font-bold text-sm text-slate-700 flex gap-2"><Icon name="bike" size={18} className="text-indigo-600"/> Delivery / Env√≠o</span><input type="checkbox" className="w-5 h-5 accent-indigo-600" checked={isDel} onChange={e=>setIsDel(e.target.checked)}/></div>
                      {isDel && <div className="mt-3 space-y-3 animate-enter"><input className="input-field" placeholder="Direcci√≥n Exacta" value={addr} onChange={e=>setAddr(e.target.value)}/><div className="flex justify-between bg-white p-3 rounded-lg border border-indigo-100 items-center"><span className="text-xs font-bold text-indigo-800">Costo Env√≠o:</span><div className="flex items-center gap-1"><span className="text-slate-400 text-xs">C$</span><input type="number" className="w-24 text-right font-bold outline-none text-slate-800" value={ship} onChange={e=>setShip(e.target.value)}/></div></div></div>}
                   </div>
                   <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm space-y-3">
                      {method==='Efectivo' && <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 flex items-center gap-4"><div className="flex-1"><label className="text-[10px] font-bold text-slate-400 uppercase">Recibido</label><input type="number" className="w-full bg-transparent text-xl font-bold outline-none" placeholder="0.00" value={paid} onChange={e=>setPaid(e.target.value)}/></div><div className="text-right"><label className="text-[10px] font-bold text-slate-400 uppercase">Cambio</label><div className={`text-xl font-black ${change<0?'text-red-500':'text-green-600'}`}>{formatMoney(change)}</div></div></div>}
                      <div className="text-sm space-y-2 pt-2"><div className="flex justify-between text-slate-500"><span>Subtotal Neto</span><span>{formatMoney(totals.total - totals.tax)}</span></div>{totals.taxOn && <div className="flex justify-between text-indigo-600"><span>IVA 15%</span><span>{formatMoney(totals.tax)}</span></div>}{isDel && <div className="flex justify-between text-indigo-600"><span>Env√≠o</span><span>{formatMoney(Number(ship))}</span></div>}<div className="flex justify-between text-2xl font-black text-slate-900 border-t pt-3"><span>Total</span><span>{formatMoney(finalTotal)}</span></div></div>
                   </div>
                </div>
                <div className="p-4 bg-white border-t shrink-0 pb-safe"><button onClick={confirm} disabled={loading || !client || !phone || (method==='Efectivo' && change < -0.5)} className="btn btn-primary w-full py-4 text-lg">{loading ? 'PROCESANDO...' : 'CONFIRMAR PEDIDO'}</button></div>
             </div>
          </div>
       );
    };

    // ==========================================
    // 7. HISTORIAL
    // ==========================================
    const OrdersModule = ({ user }) => {
       const [orders, setOrders] = useState([]);
       const [viewId, setViewId] = useState(null);

       useEffect(() => {
          const unsub = getCollection('orders').orderBy('createdAt', 'desc').limit(50).onSnapshot(s => setOrders(s.docs.map(d => ({id:d.id, ...d.data()}))));
          return unsub;
       }, []);

       const sorted = [...orders].sort((a,b) => (a.status==='proceso' && b.status!=='proceso') ? -1 : (a.status!=='proceso' && b.status==='proceso') ? 1 : 0);
       const sel = sorted.find(o => o.id === viewId);

       const updateOrder = async (f, v) => { if(viewId) await getCollection('orders').doc(viewId).update({[f]:v}); };
       const sendWA = () => {
          const msg = `Hola *${sel.client}*. Actualizaci√≥n pedido *${sel.displayId}*:\nEstado: *${sel.status.toUpperCase()}*\nüîó Rastreo: ${window.location.origin}${window.location.pathname}?track=${sel.displayId}`;
          window.open(`https://wa.me/505${sel.phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`);
       };

       return (
          <div className="flex flex-col h-full bg-slate-50 relative">
             <div className="p-4 bg-white border-b shrink-0 flex items-center gap-2"><Icon name="list" className="text-indigo-600"/><h2 className="text-xl font-bold text-slate-800">Historial</h2></div>
             <div className="scroll-area p-4 space-y-3 pb-24">
                {sorted.map(o => (
                   <div key={o.id} onClick={()=>setViewId(o.id)} className={`p-4 rounded-xl border shadow-sm flex justify-between items-center cursor-pointer active:scale-95 transition-all ${o.status==='proceso'?'bg-orange-50 border-orange-200 ring-1 ring-orange-200':'bg-white border-slate-100'}`}>
                      <div>
                         <div className="flex gap-2 items-center mb-1"><span className="bg-indigo-50 text-indigo-700 text-[10px] font-bold px-1.5 rounded">{o.displayId}</span><span className={`text-[10px] font-bold px-1.5 rounded uppercase ${o.paymentStatus==='pagado'?'text-green-600 bg-green-50':'text-red-600 bg-red-50'}`}>{o.paymentStatus}</span></div>
                         <p className="font-bold text-sm text-slate-800">{o.client}</p>
                         <div className="flex gap-2 mt-1"><span className="text-[10px] text-slate-400">{new Date(o.createdAt).toLocaleDateString()}</span><span className={`text-[10px] uppercase font-bold px-1.5 rounded ${o.status==='proceso'?'bg-orange-500 text-white':(o.status==='entregado'?'bg-green-100 text-green-600':'bg-slate-100 text-slate-500')}`}>{o.status}</span></div>
                      </div>
                      <div className="text-right"><span className="block font-black text-lg text-slate-800">{formatMoney(o.total)}</span><Icon name="chevron-right" size={16} className="text-slate-300 ml-auto"/></div>
                   </div>
                ))}
             </div>
             {sel && (
                <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm animate-enter">
                   <div className="bg-white w-full max-w-md rounded-2xl flex flex-col max-h-[90vh] overflow-hidden shadow-2xl">
                      <div className="p-4 border-b bg-slate-50 flex justify-between items-center shrink-0"><div><h3 className="font-bold text-lg">{sel.displayId}</h3><p className="text-xs text-slate-500">{new Date(sel.createdAt).toLocaleString()}</p></div><button onClick={()=>setViewId(null)} className="p-1 hover:bg-slate-200 rounded-full"><Icon name="x"/></button></div>
                      <div className="scroll-area p-5 bg-white space-y-5">
                         <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Estado</label><select className="w-full border rounded-lg p-2 text-xs font-bold bg-slate-50" value={sel.status} onChange={e=>updateOrder('status',e.target.value)}><option value="recibido">Recibido</option><option value="proceso">En Proceso</option><option value="ruta">En Ruta</option><option value="entregado">Entregado</option><option value="cancelado">Cancelado</option></select></div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Pago</label><select className={`w-full border rounded-lg p-2 text-xs font-bold ${sel.paymentStatus==='pagado'?'bg-green-50 text-green-700':'bg-red-50 text-red-600'}`} value={sel.paymentStatus} onChange={e=>updateOrder('paymentStatus',e.target.value)}><option value="pendiente">Pendiente</option><option value="pagado">Pagado</option></select></div>
                         </div>
                         <div className="space-y-2 border-t pt-4">{sel.cart.map((i,k)=>(<div key={k} className="flex justify-between text-sm"><span className="text-slate-700">{i.qty}x {i.name} {i.variantName&&`(${i.variantName})`}</span><span className="font-bold">{formatMoney(i.price*i.qty)}</span></div>))}</div>
                         <div className="bg-slate-50 p-4 rounded-xl text-sm space-y-1">
                            {sel.discountAmount>0 && <div className="flex justify-between text-green-600"><span>Desc</span><span>-{formatMoney(sel.discountAmount)}</span></div>}
                            <div className="flex justify-between text-slate-500"><span>IVA</span><span>{formatMoney(sel.tax||0)}</span></div>
                            <div className="flex justify-between font-black text-xl text-slate-900 border-t pt-2 mt-1"><span>Total</span><span>{formatMoney(sel.total)}</span></div>
                         </div>
                         <div className="flex gap-3"><button onClick={sendWA} className="flex-1 btn btn-primary bg-green-500 hover:bg-green-600 shadow-none"><Icon name="message-circle" size={18}/> WhatsApp</button></div>
                      </div>
                   </div>
                </div>
             )}
          </div>
       );
    };

    // ==========================================
    // 8. INVENTARIO (FIX BOT√ìN GUARDAR)
    // ==========================================
    const InventoryModule = ({ products }) => {
       const [modal, setModal] = useState(false);
       const [edit, setEdit] = useState(null);
       const [form, setForm] = useState({ name:'', cat:'', img:'', price:'', stock:'', hasVars:false });
       const [vars, setVars] = useState([]);

       const open = (p) => {
          if (p) { setEdit(p); setForm({ name:p.name, cat:p.category, img:p.image||'', price:p.price, stock:p.stock, hasVars:!!p.variants?.length }); setVars(p.variants || []); } 
          else { setEdit(null); setForm({ name:'', cat:'', img:'', price:'', stock:'', hasVars:false }); setVars([]); }
          setModal(true);
       };

       const save = async (e) => {
          e.preventDefault();
          const d = { name: form.name, category: form.cat, image: form.img, price: form.hasVars ? 0 : Number(form.price), stock: form.hasVars ? 0 : Number(form.stock), variants: form.hasVars ? vars.map(v => ({ name: v.name, price: Number(v.price), stock: Number(v.stock) })) : [] };
          if (edit) await getCollection('products').doc(edit.id).update(d); else await getCollection('products').add(d);
          setModal(false); Swal.fire({ toast: true, title: "Guardado", icon: "success", timer: 1500, position: 'top', showConfirmButton: false });
       };

       return (
          <div className="flex flex-col h-full bg-slate-50 relative">
             <div className="p-4 bg-white border-b flex justify-between shrink-0 items-center"><h2 className="text-xl font-bold flex gap-2 items-center text-slate-800"><Icon name="package" className="text-indigo-600"/> Inventario</h2><button onClick={() => open()} className="btn btn-primary py-2 px-4 text-xs">+ Nuevo</button></div>
             <div className="scroll-area p-4 space-y-3 pb-24">
                {products.map(p => {
                   const stock = p.variants?.length ? p.variants.reduce((a,b)=>a+Number(b.stock),0) : Number(p.stock);
                   return (
                      <div key={p.id} onClick={() => open(p)} className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50">
                         <div className="flex gap-4 items-center">
                            <div className="w-12 h-12 bg-slate-100 rounded-lg overflow-hidden flex items-center justify-center border border-slate-200">{p.image ? <img src={p.image} className="w-full h-full object-cover"/> : <Icon name="box" className="text-slate-300"/>}</div>
                            <div><p className="font-bold text-sm text-slate-800">{p.name}</p><div className="flex gap-2 items-center mt-0.5"><span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 rounded font-bold uppercase">{p.variants?.length > 0 ? 'Vars' : 'Std'}</span><span className={`text-[10px] font-bold ${stock < 5 ? 'text-red-500' : 'text-green-600'}`}>Stock: {stock}</span></div></div>
                         </div>
                         <div className="p-2 bg-slate-50 rounded-full text-slate-400"><Icon name="edit-3" size={16}/></div>
                      </div>
                   );
                })}
             </div>
             {modal && (
                <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-enter">
                   <div className="bg-white w-full max-w-lg rounded-2xl flex flex-col max-h-[90vh] overflow-hidden shadow-2xl">
                      <div className="p-4 border-b flex justify-between items-center bg-slate-50 shrink-0"><h3 className="font-bold text-lg text-slate-800">{edit?'Editar Producto':'Nuevo Producto'}</h3><button onClick={()=>setModal(false)} className="p-1 hover:bg-slate-200 rounded-full"><Icon name="x"/></button></div>
                      {/* FIX: pb-40 asegura que el bot√≥n guardar se vea siempre */}
                      <form onSubmit={save} className="scroll-area p-6 space-y-5 bg-white pb-40">
                         <div><label className="text-xs font-bold text-slate-400 uppercase">Nombre</label><input className="input-field mt-1" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required/></div>
                         <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-400 uppercase">Categor√≠a</label><input className="input-field mt-1" list="cats" value={form.cat} onChange={e=>setForm({...form,cat:e.target.value})}/><datalist id="cats"><option value="Ropa"/><option value="Tecnolog√≠a"/><option value="Hogar"/></datalist></div><div><label className="text-xs font-bold text-slate-400 uppercase">Imagen URL</label><input className="input-field mt-1" value={form.img} onChange={e=>setForm({...form,img:e.target.value})}/></div></div>
                         <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex items-center gap-3"><input type="checkbox" className="w-5 h-5 accent-indigo-600 rounded" checked={form.hasVars} onChange={e=>setForm({...form,hasVars:e.target.checked})}/><label className="font-bold text-indigo-900 text-sm">Habilitar Variantes (Tallas/Colores)</label></div>
                         {!form.hasVars ? (<div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-400 uppercase">Precio</label><input type="number" step="0.01" className="input-field mt-1 font-bold" value={form.price} onChange={e=>setForm({...form,price:e.target.value})}/></div><div><label className="text-xs font-bold text-slate-400 uppercase">Stock</label><input type="number" className="input-field mt-1 font-bold" value={form.stock} onChange={e=>setForm({...form,stock:e.target.value})}/></div></div>) 
                         : (<div className="space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-200"><p className="text-xs font-bold text-slate-400 uppercase">Lista de Variantes</p>{vars.map((v, i) => (<div key={i} className="flex gap-2 items-center"><input className="input-field py-2 text-xs" placeholder="Nombre (Ej. XL)" value={v.name} onChange={e=>{const n=[...vars];n[i].name=e.target.value;setVars(n)}}/><input type="number" className="input-field py-2 text-xs w-24 text-center" placeholder="Precio" value={v.price} onChange={e=>{const n=[...vars];n[i].price=e.target.value;setVars(n)}}/><input type="number" className="input-field py-2 text-xs w-20 text-center" placeholder="Stock" value={v.stock} onChange={e=>{const n=[...vars];n[i].stock=e.target.value;setVars(n)}}/><button type="button" onClick={()=>setVars(vars.filter((_,x)=>x!==i))} className="text-red-400 p-2 hover:bg-red-50 rounded"><Icon name="trash-2" size={16}/></button></div>))}<button type="button" onClick={()=>setVars([...vars, {name:'', price:'', stock:''}])} className="w-full py-3 border-2 border-dashed border-indigo-300 text-indigo-600 rounded-xl text-xs font-bold hover:bg-indigo-50 transition-colors">+ Agregar Variante</button></div>)}
                         <div className="pt-4"><button className="btn btn-primary w-full py-4 text-lg">GUARDAR PRODUCTO</button></div>
                      </form>
                   </div>
                </div>
             )}
          </div>
       );
    };

    // ==========================================
    // 9. ADMIN (REPORTES REPARADO)
    // ==========================================
    const AdminModule = ({ user, shift, updateShift }) => {
       const [tab, setTab] = useState('shift'); 
       const [startAmt, setStartAmt] = useState("");
       const [d1, setD1] = useState(new Date().toISOString().slice(0,10));
       const [d2, setD2] = useState(new Date().toISOString().slice(0,10));

       const openS = async () => { if(startAmt) { await getCollection('shifts').add({userId:user.uid, startAmount:parseFloat(startAmt), openedAt: firebase.firestore.FieldValue.serverTimestamp(), status:'open'}); updateShift(); Swal.fire("Caja Abierta", "", "success"); }};
       const closeS = async () => { if((await Swal.fire({title:'¬øCerrar Turno?', icon:"warning", showCancelButton:true, confirmButtonColor:"#ef4444"})).isConfirmed) { await getCollection('shifts').doc(shift.id).update({status:'closed', closedAt: firebase.firestore.FieldValue.serverTimestamp()}); updateShift(); Swal.fire("Turno Cerrado", "", "success"); }};
       
       const report = async (type) => {
          try {
             // FIX: Asegurar rango completo de fechas
             const sd = new Date(d1); 
             const ed = new Date(d2); 
             ed.setHours(23,59,59,999); 
             
             const snap = await getCollection('orders')
                .where('createdAt','>=',sd.toISOString())
                .where('createdAt','<=',ed.toISOString())
                .get();
                
             const data = snap.docs.map(d=>{
                const x=d.data(); 
                return [x.displayId, new Date(x.createdAt).toLocaleDateString(), x.client || 'Anon', x.method, x.total.toFixed(2)]
             });

             if(data.length===0) return Swal.fire("Sin datos", "No hay ventas en este rango", "info");

             if(type==='pdf') { 
                const doc = new window.jspdf.jsPDF(); 
                doc.text(`Reporte Homemart: ${d1} a ${d2}`, 14, 20); 
                doc.autoTable({head:[['ID','Fecha','Cliente','M√©todo','Total']], body:data, startY:30}); 
                doc.save(`ventas_${d1}.pdf`); 
             } else { 
                const ws = XLSX.utils.aoa_to_sheet([['ID','Fecha','Cliente','M√©todo','Total'], ...data]); 
                const wb=XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, ws, "Ventas"); 
                XLSX.writeFile(wb, `ventas_${d1}.xlsx`); 
             }
          } catch(e) { console.error(e); Swal.fire("Error", "Revisa la consola", "error"); }
       };

       return (
          <div className="flex flex-col h-full bg-slate-50 relative">
             <div className="p-4 bg-white border-b flex justify-center shrink-0"><div className="bg-slate-100 p-1 rounded-xl flex"><button onClick={()=>setTab('shift')} className={`px-6 py-2 rounded-lg text-xs font-bold transition-all ${tab==='shift'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Control Caja</button><button onClick={()=>setTab('reports')} className={`px-6 py-2 rounded-lg text-xs font-bold transition-all ${tab==='reports'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Reportes</button></div></div>
             <div className="scroll-area p-6 flex flex-col items-center justify-start pt-10">
                {tab==='shift' ? (
                   <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center border border-slate-200 animate-enter">
                      <div className={`w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 ${shift?'bg-green-100 text-green-600':'bg-slate-100 text-slate-400'}`}><Icon name={shift?'unlock':'lock'} size={32}/></div>
                      <h2 className="text-2xl font-bold mb-2 text-slate-800">{shift?'Turno Activo':'Caja Cerrada'}</h2>
                      <p className="text-sm text-slate-500 mb-6">{shift ? 'El sistema est√° listo para vender.' : 'Debes abrir caja para comenzar.'}</p>
                      {shift ? (<div className="space-y-6"><div className="bg-slate-50 p-4 rounded-xl border border-slate-200"><p className="text-xs font-bold text-slate-400 uppercase">Fondo Inicial</p><p className="text-3xl font-black text-slate-800">{formatMoney(shift.startAmount)}</p></div><button onClick={closeS} className="w-full btn btn-danger shadow-red-200"><Icon name="lock" size={18}/> CERRAR TURNO</button></div>) 
                      : (<div className="space-y-4"><div className="relative"><span className="absolute left-4 top-3.5 text-slate-400 font-bold">C$</span><input type="number" className="w-full bg-slate-50 pl-10 pr-4 py-3 rounded-xl border-2 border-slate-200 focus:border-indigo-500 outline-none text-xl font-bold text-center" placeholder="0.00" value={startAmt} onChange={e => setStartAmt(e.target.value)} /></div><button onClick={openS} disabled={!startAmt} className="btn btn-primary w-full py-3.5">ABRIR TURNO</button></div>)}
                   </div>
                ) : (
                   <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm border border-slate-200 space-y-6 animate-enter">
                      <div className="flex items-center gap-3 text-indigo-700 font-bold text-lg border-b pb-4"><div className="p-2 bg-indigo-50 rounded-lg"><Icon name="file-text" size={24}/></div> Exportar Ventas</div>
                      <div className="space-y-4"><div><label className="text-xs font-bold text-slate-400 uppercase ml-1">Fecha Inicio</label><input type="date" className="input-field mt-1" value={d1} onChange={e=>setD1(e.target.value)}/></div><div><label className="text-xs font-bold text-slate-400 uppercase ml-1">Fecha Fin</label><input type="date" className="input-field mt-1" value={d2} onChange={e=>setD2(e.target.value)}/></div></div>
                      <div className="flex gap-3 pt-4"><button onClick={()=>report('pdf')} className="flex-1 btn btn-danger text-xs"><Icon name="file" size={16}/> PDF</button><button onClick={()=>report('excel')} className="flex-1 btn btn-primary bg-green-600 hover:bg-green-700 text-xs shadow-green-200"><Icon name="sheet" size={16}/> Excel</button></div>
                   </div>
                )}
             </div>
          </div>
       );
    };

    // ==========================================
    // 10. APP PRINCIPAL
    // ==========================================
    const App = () => {
      const [user, setUser] = useState(null);
      const [view, setView] = useState('pos');
      const [products, setProducts] = useState([]);
      const [shift, setShift] = useState(null);
      const [loading, setLoading] = useState(true);
      const [cart, setCart] = useState([]);

      const addToCart = (p, v=null) => {
         if(!shift) return Swal.fire({title: "Caja Cerrada", text: "Abre turno en Administraci√≥n", icon: "warning"});
         const stock = v ? Number(v.stock) : Number(p.stock);
         if(stock<=0) return Swal.fire("Agotado", "", "error");
         const id = v ? `${p.id}-${v.name}` : p.id;
         const exist = cart.find(x=>x.cartId===id);
         if(exist && exist.qty>=stock) return Swal.fire("Stock M√°ximo", "No hay m√°s unidades disponibles", "info");
         if(exist) setCart(cart.map(x=>x.cartId===id ? {...x, qty:x.qty+1}:x));
         else setCart([...cart, {cartId:id, id:p.id, name:p.name, price:Number(v?v.price:p.price), isVariant:!!v, variantName:v?.name, qty:1, maxStock:stock, image:p.image}]);
      };
      
      const updateQty = (id, d) => setCart(cart.map(i=>i.cartId===id?{...i, qty:i.qty+d}:i).filter(i=>i.qty>0));
      const clearCart = () => setCart([]);

      const trackId = new URLSearchParams(window.location.search).get('track');

      useEffect(() => {
        auth.onAuthStateChanged(async u => {
           if(trackId && !u) await auth.signInAnonymously();
           setUser(u);
           if(u && !trackId) { 
              // Carga de datos robusta
              getCollection('products').onSnapshot(s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()})))); 
              checkShift(u.uid); 
           }
           setLoading(false);
        });
      }, []);

      const checkShift = async (uid) => { const s = await getCollection('shifts').where('status','==','open').where('userId','==',uid).limit(1).get(); setShift(s.empty?null:{id:s.docs[0].id, ...s.docs[0].data()}); };

      if(loading) return <div className="h-full w-full flex items-center justify-center bg-slate-50"><div className="w-16 h-16 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div></div>;
      if(trackId) return <div className="fixed inset-0 bg-white"><TrackingView trackId={trackId}/></div>;
      if(!user || (user.isAnonymous && !trackId)) return <LoginScreen/>;

      return (
        <div className="flex flex-col md:flex-row h-full w-full bg-slate-100 overflow-hidden">
          {/* Sidebar Desktop */}
          <aside className="hidden md:flex flex-col w-64 bg-white border-r border-slate-200 h-full">
             <div className="p-6 border-b border-slate-100"><h1 className="text-xl font-black text-indigo-600 flex items-center gap-2"><Icon name="store"/> Homemart</h1><p className="text-xs text-slate-400 mt-2 truncate bg-slate-50 p-1.5 rounded text-center font-mono">{user.email}</p></div>
             <nav className="flex-1 p-4 space-y-2 overflow-y-auto">{[{id:'pos',label:'Punto de Venta',icon:'shopping-cart'},{id:'orders',label:'Historial',icon:'list'},{id:'inv',label:'Inventario',icon:'package'},{id:'admin',label:'Administraci√≥n',icon:'settings'}].map(i=><button key={i.id} onClick={()=>setView(i.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all ${view===i.id?'bg-indigo-50 text-indigo-600 shadow-sm':'text-slate-500 hover:bg-slate-50'}`}><Icon name={i.icon} size={20}/> {i.label}</button>)}</nav>
             <div className="p-4 border-t border-slate-100"><button onClick={()=>auth.signOut()} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-red-500 hover:bg-red-50"><Icon name="log-out" size={20}/> Salir</button></div>
          </aside>

          {/* Header M√≥vil */}
          <div className="md:hidden flex items-center justify-between p-3 bg-white border-b border-slate-200 shrink-0 shadow-sm z-20"><span className="font-black text-indigo-600 flex items-center gap-2 text-base"><Icon name="store" size={22}/> Homemart</span><button onClick={()=>auth.signOut()} className="text-slate-400 p-2"><Icon name="log-out" size={20}/></button></div>

          <main className="flex-1 relative bg-slate-100 h-full overflow-hidden flex flex-col">
             <div className="flex-1 relative overflow-hidden">
                {view==='pos' && <POSModule products={products} shift={shift} cart={cart} addToCart={addToCart} updateQty={updateQty} clearCart={clearCart}/>}
                {view==='orders' && <OrdersModule user={user}/>}
                {view==='inv' && <InventoryModule products={products}/>}
                {view==='admin' && <AdminModule user={user} shift={shift} updateShift={()=>checkShift(user.uid)}/>}
             </div>
          </main>

          {/* Navegaci√≥n M√≥vil */}
          <nav className="md:hidden bg-white border-t border-slate-200 flex justify-around py-1 pb-safe shrink-0 z-40 shadow-[0_-5px_15px_rgba(0,0,0,0.03)] h-16">
             {[{id:'pos',label:'Venta',icon:'shopping-cart'},{id:'orders',label:'Orden',icon:'list'},{id:'inv',label:'Inv',icon:'package'},{id:'admin',label:'Admin',icon:'settings'}].map(i=>(
                <button key={i.id} onClick={()=>setView(i.id)} className={`flex flex-col items-center justify-center p-1 rounded-xl w-16 transition-colors ${view===i.id?'text-indigo-600':'text-slate-400'}`}>
                   <div className="relative"><Icon name={i.icon} size={22} className="mb-0.5" strokeWidth={view===i.id?2.5:2}/>{i.id==='pos' && cart.length>0 && <span className="absolute -top-1 -right-2 bg-red-500 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center border border-white shadow-sm">{cart.reduce((a,b)=>a+b.qty,0)}</span>}</div>
                   <span className="text-[10px] font-bold">{i.label}</span>
                </button>
             ))}
          </nav>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>


