<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POS Móvil Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        /* Ajustes Mobile */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Ocultar scrollbar pero permitir scroll */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #6366f1;
            border-radius: 50%; width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Input Styles para evitar zoom en iOS */
        input, select, textarea { font-size: 16px !important; }

        /* IMPRESIÓN */
        @media print {
            body > *:not(#invoice-view) { display: none !important; }
            #invoice-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: white; display: block !important; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen flex flex-col overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                    <i data-lucide="store" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900">Bienvenido</h1>
                <p class="text-gray-500 mt-2">Sistema POS & Inventario</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                    <input type="email" id="login-email" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="admin@tienda.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="login-pass" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="••••••" required>
                </div>
                <button type="submit" id="btn-login" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl hover:bg-indigo-700 active:scale-95 transition shadow-lg shadow-indigo-200">
                    Iniciar Sesión
                </button>
            </form>
            
            <button id="toggle-auth" class="mt-6 text-sm text-indigo-600 font-medium w-full text-center py-2">
                ¿No tienes cuenta? Regístrate
            </button>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-screen" class="flex-1 flex flex-col md:flex-row h-full relative hidden">

        <!-- DESKTOP SIDEBAR (Solo visible en md+) -->
        <nav class="hidden md:flex w-64 bg-white border-r flex-col p-4 z-20">
            <div class="flex items-center gap-3 px-2 mb-8 mt-2">
                <div class="bg-indigo-600 p-2 rounded-lg"><i data-lucide="store" class="text-white w-5 h-5"></i></div>
                <span class="font-bold text-xl">Mi Tienda</span>
            </div>
            
            <div class="space-y-1">
                <button onclick="navTo('pos')" id="d-nav-pos" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-100 transition font-medium">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i> Ventas
                </button>
                <button onclick="navTo('inventory')" id="d-nav-inventory" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-100 transition font-medium">
                    <i data-lucide="package" class="w-5 h-5"></i> Inventario
                </button>
                <button onclick="navTo('orders')" id="d-nav-orders" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-100 transition font-medium">
                    <i data-lucide="history" class="w-5 h-5"></i> Historial
                </button>
            </div>

            <div class="mt-auto">
                <div class="bg-gray-50 p-3 rounded-xl mb-4">
                    <p id="user-email-display" class="text-xs text-gray-500 truncate font-medium">usuario@email.com</p>
                </div>
                <button id="btn-logout" class="w-full flex items-center gap-2 text-red-500 px-4 py-2 hover:bg-red-50 rounded-lg transition text-sm font-bold">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Cerrar Sesión
                </button>
            </div>
        </nav>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 relative overflow-hidden bg-gray-50 flex flex-col">
            
            <!-- VIEW: POS (Ventas) -->
            <div id="view-pos" class="absolute inset-0 flex flex-col md:flex-row fade-in">
                <!-- Header Móvil -->
                <div class="md:hidden bg-white p-4 flex items-center justify-between border-b shadow-sm z-10">
                    <h1 class="font-bold text-lg">Punto de Venta</h1>
                    <div class="relative">
                        <i data-lucide="shopping-cart" class="text-gray-700 w-6 h-6" onclick="navTo('cart')"></i>
                        <span id="badge-cart-mobile" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 flex items-center justify-center rounded-full hidden">0</span>
                    </div>
                </div>

                <!-- Buscador y Grid -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <div class="p-4 pb-2">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
                            <input type="text" id="search-pos" placeholder="Buscar por nombre, marca..." class="w-full bg-white border-none shadow-sm rounded-xl py-3 pl-10 pr-4 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>

                    <!-- Lista de Productos (Grid Responsivo) -->
                    <div id="pos-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 content-start pb-24 md:pb-4">
                        <!-- Items inyectados por JS -->
                    </div>
                </div>

                <!-- CARRITO (Sidebar en Desktop, Vista separada en Móvil) -->
                <div class="hidden md:flex w-96 bg-white border-l flex-col shadow-xl z-20">
                    <div class="p-5 border-b bg-gray-50 flex justify-between items-center">
                        <h2 class="font-bold text-lg flex items-center gap-2"><i data-lucide="shopping-cart" class="w-5 h-5"></i> Ticket Actual</h2>
                        <button onclick="clearCart()" class="text-xs text-red-500 hover:text-red-700 font-medium">Vaciar</button>
                    </div>
                    <!-- Lista Items Desktop -->
                    <div id="cart-items-desktop" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                    <!-- Checkout Footer Desktop -->
                    <div class="p-5 bg-gray-50 border-t space-y-3">
                        <div id="cart-summary-desktop"></div>
                        <button onclick="processSale()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">COBRAR</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: CART (Solo Móvil) -->
            <div id="view-cart" class="absolute inset-0 flex flex-col bg-white z-30 hidden fade-in md:hidden">
                <div class="p-4 border-b flex items-center justify-between bg-white shadow-sm sticky top-0 z-10">
                    <h1 class="font-bold text-xl">Carrito de Compra</h1>
                    <button onclick="clearCart()" class="text-red-500 text-sm font-medium">Limpiar</button>
                </div>
                
                <div id="cart-items-mobile" class="flex-1 overflow-y-auto p-4 space-y-4 pb-32">
                    <!-- Items inyectados -->
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <i data-lucide="shopping-cart" class="w-12 h-12 mb-2 opacity-50"></i>
                        <p>Carrito vacío</p>
                    </div>
                </div>

                <div class="absolute bottom-[60px] left-0 w-full bg-white border-t p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                     <div class="space-y-2 mb-3">
                        <div class="flex justify-between text-sm"><span>Subtotal</span> <span id="m-subtotal">$0.00</span></div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Descuento</span>
                            <input type="number" id="m-discount" class="w-20 text-right border rounded p-1 text-sm" placeholder="0.00">
                        </div>
                        <div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t"><span>Total</span> <span id="m-total">$0.00</span></div>
                    </div>
                    <button onclick="processSale()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold text-lg shadow-lg shadow-indigo-200 active:scale-95 transition">
                        Cobrar
                    </button>
                </div>
            </div>

            <!-- VIEW: INVENTORY -->
            <div id="view-inventory" class="absolute inset-0 flex flex-col hidden fade-in bg-gray-50">
                <div class="p-4 bg-white border-b flex justify-between items-center sticky top-0 z-10 shadow-sm">
                    <h1 class="font-bold text-lg md:text-2xl">Inventario</h1>
                    <button onclick="openProductModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition">
                        <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden md:inline">Nuevo Producto</span><span class="md:hidden">Nuevo</span>
                    </button>
                </div>
                
                <div class="p-4 flex-1 overflow-y-auto pb-24">
                    <!-- Cards de Inventario -->
                    <div id="inventory-list" class="space-y-3 md:grid md:grid-cols-2 lg:grid-cols-3 md:space-y-0 md:gap-4">
                        <!-- Inyectado JS -->
                    </div>
                </div>
            </div>

            <!-- VIEW: ORDERS -->
            <div id="view-orders" class="absolute inset-0 flex flex-col hidden fade-in bg-gray-50">
                <div class="p-4 bg-white border-b sticky top-0 z-10 shadow-sm">
                    <h1 class="font-bold text-lg md:text-2xl">Historial de Ventas</h1>
                </div>
                <div id="orders-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-24">
                    <!-- Orders List -->
                </div>
            </div>

        </main>

        <!-- MOBILE BOTTOM NAV (Solo visible en móviles) -->
        <div class="md:hidden fixed bottom-0 w-full bg-white border-t flex justify-around items-center py-2 pb-safe z-40 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
            <button onclick="navTo('pos')" id="m-nav-pos" class="flex flex-col items-center p-2 text-indigo-600 transition">
                <i data-lucide="store" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Ventas</span>
            </button>
            <button onclick="navTo('cart')" id="m-nav-cart" class="flex flex-col items-center p-2 text-gray-400 transition relative">
                <i data-lucide="shopping-cart" class="w-6 h-6 mb-1"></i>
                <span id="badge-nav" class="absolute top-1 right-2 bg-red-500 text-white text-[9px] w-3.5 h-3.5 rounded-full flex items-center justify-center hidden">0</span>
                <span class="text-[10px] font-medium">Carrito</span>
            </button>
            <button onclick="navTo('inventory')" id="m-nav-inventory" class="flex flex-col items-center p-2 text-gray-400 transition">
                <i data-lucide="package" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Stock</span>
            </button>
            <button onclick="navTo('orders')" id="m-nav-orders" class="flex flex-col items-center p-2 text-gray-400 transition">
                <i data-lucide="file-clock" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Historial</span>
            </button>
        </div>

    </div>

    <!-- MODAL PRODUCTO (Formulario Completo) -->
    <div id="modal-product" class="fixed inset-0 z-50 bg-black/50 hidden flex items-end md:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full md:w-[600px] h-[90vh] md:h-auto rounded-t-2xl md:rounded-2xl flex flex-col shadow-2xl overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg" id="modal-title">Nuevo Producto</h3>
                <button onclick="closeProductModal()" class="p-2 bg-gray-200 rounded-full hover:bg-gray-300"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <form id="product-form" class="space-y-5">
                    <input type="hidden" name="id" id="prod-id">
                    
                    <!-- Sección Principal -->
                    <div>
                        <label class="label-input">Nombre del Producto *</label>
                        <input name="name" required class="input-field" placeholder="Ej: Zapatillas Running">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label-input">Marca</label>
                            <input name="brand" class="input-field" placeholder="Ej: Nike">
                        </div>
                        <div>
                            <label class="label-input">Categoría</label>
                            <input name="category" list="categories" class="input-field" placeholder="Ej: Calzado">
                            <datalist id="categories">
                                <option value="Ropa"></option>
                                <option value="Calzado"></option>
                                <option value="Accesorios"></option>
                                <option value="Electrónica"></option>
                            </datalist>
                        </div>
                    </div>

                    <!-- Precios y Stock -->
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label-input text-indigo-900">Costo Unitario ($) *</label>
                                <input type="number" step="0.01" name="cost" required class="input-field border-indigo-200 focus:ring-indigo-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="label-input text-indigo-900">Precio Venta ($) *</label>
                                <input type="number" step="0.01" name="price" required class="input-field border-indigo-200 focus:ring-indigo-500 font-bold" placeholder="0.00">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label-input text-indigo-900">Stock Actual *</label>
                                <input type="number" name="stock" required class="input-field border-indigo-200" placeholder="0">
                            </div>
                            <div>
                                <label class="label-input text-indigo-900">Stock Mínimo</label>
                                <input type="number" name="minStock" class="input-field border-indigo-200" placeholder="5">
                            </div>
                        </div>
                    </div>

                    <!-- Detalles Visuales -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label-input">Color</label>
                            <input name="color" class="input-field" placeholder="Ej: Negro/Blanco">
                        </div>
                        <div>
                            <label class="label-input">Talla / Medida</label>
                            <input name="size" class="input-field" placeholder="Ej: 42, M, XL">
                        </div>
                    </div>

                    <div>
                        <label class="label-input">URL Imagen (Opcional)</label>
                        <input name="imageUrl" class="input-field" placeholder="https://ejemplo.com/foto.jpg">
                    </div>
                </form>
            </div>

            <div class="p-4 border-t bg-gray-50 flex gap-3">
                <button onclick="closeProductModal()" class="flex-1 py-3 rounded-xl border border-gray-300 font-bold text-gray-600">Cancelar</button>
                <button onclick="submitProduct()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-200">Guardar</button>
            </div>
        </div>
    </div>

    <!-- FACTURA MODAL (Overlay) -->
    <div id="invoice-view" class="fixed inset-0 bg-white z-[100] hidden overflow-y-auto">
        <div class="max-w-2xl mx-auto min-h-screen bg-white p-6 relative">
            <div class="no-print absolute top-4 right-4 flex gap-2">
                <button onclick="closeInvoice()" class="bg-gray-100 p-2 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
                <button onclick="window.print()" class="bg-indigo-600 text-white p-2 rounded-lg"><i data-lucide="printer" class="w-5 h-5"></i></button>
            </div>
            
            <div class="text-center mb-8 mt-4">
                <h2 class="text-2xl font-bold uppercase tracking-widest text-gray-800">Factura</h2>
                <p class="text-sm text-gray-500 mt-1" id="inv-date">Fecha</p>
                <p class="text-xs text-gray-400 font-mono mt-1" id="inv-id">#ID</p>
            </div>

            <div class="border-t border-b border-dashed border-gray-300 py-4 mb-4">
                <div class="flex justify-between text-sm font-bold text-gray-700 mb-2">
                    <span>Producto</span>
                    <span>Total</span>
                </div>
                <div id="inv-items" class="space-y-2 text-sm text-gray-600">
                    <!-- Items Factura -->
                </div>
            </div>

            <div class="space-y-2 text-right">
                <div class="flex justify-between text-sm"><span>Subtotal</span> <span id="inv-subtotal" class="font-medium">$0.00</span></div>
                <div class="flex justify-between text-sm text-gray-500"><span>Descuento</span> <span id="inv-discount">-$0.00</span></div>
                <div class="flex justify-between text-xl font-bold text-indigo-900 border-t pt-2 mt-2"><span>Total</span> <span id="inv-total">$0.00</span></div>
            </div>

            <div class="mt-12 text-center">
                <p class="font-bold text-gray-800">¡Gracias por su compra!</p>
                <p class="text-xs text-gray-400 mt-1">Este documento es un comprobante válido.</p>
            </div>
        </div>
    </div>

    <style>
        .input-field { width: 100%; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 0.75rem 1rem; outline: none; transition: all; background: #f9fafb; }
        .input-field:focus { border-color: #6366f1; background: white; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .label-input { display: block; font-size: 0.75rem; font-weight: 700; color: #4b5563; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; }
    </style>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, remove, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // CONFIG (Reutilizando la del usuario)
        const firebaseConfig = {
            apiKey: "AIzaSyDF374bHcODY8N0R78HE8kZpmjeGeuhniU",
            authDomain: "posdeventas-a03ca.firebaseapp.com",
            databaseURL: "https://posdeventas-a03ca-default-rtdb.firebaseio.com",
            projectId: "posdeventas-a03ca",
            storageBucket: "posdeventas-a03ca.firebasestorage.app",
            messagingSenderId: "975141670948",
            appId: "1:975141670948:web:e58ed3da11878ecfdf88b1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // STATE
        let currentUser = null;
        let products = [];
        let cart = [];
        let activeView = 'pos'; // pos, cart, inventory, orders

        // DOM ELEMENTS
        const views = {
            pos: document.getElementById('view-pos'),
            cart: document.getElementById('view-cart'),
            inventory: document.getElementById('view-inventory'),
            orders: document.getElementById('view-orders')
        };
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');

        // --- INIT ---
        window.addEventListener('load', () => {
            lucide.createIcons();
            // Auth Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    authScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    appScreen.classList.add('flex');
                    document.getElementById('user-email-display').innerText = user.email;
                    initDataListeners();
                } else {
                    currentUser = null;
                    authScreen.classList.remove('hidden');
                    appScreen.classList.add('hidden');
                    appScreen.classList.remove('flex');
                }
            });
        });

        // --- NAVIGATION ---
        window.navTo = (viewName) => {
            activeView = viewName;
            
            // Ocultar todas las vistas
            Object.values(views).forEach(el => el.classList.add('hidden'));
            
            // Mostrar vista activa
            views[viewName].classList.remove('hidden');
            
            // Actualizar Nav Styles (Mobile & Desktop)
            updateNavStyles(viewName);
        };

        function updateNavStyles(active) {
            // Reset Mobile
            ['pos', 'cart', 'inventory', 'orders'].forEach(v => {
                const btn = document.getElementById(`m-nav-${v}`);
                if(btn) {
                    btn.classList.remove('text-indigo-600');
                    btn.classList.add('text-gray-400');
                }
                // Desktop
                const dBtn = document.getElementById(`d-nav-${v}`);
                if(dBtn) {
                    dBtn.classList.remove('bg-indigo-50', 'text-indigo-600');
                    dBtn.classList.add('text-gray-600');
                }
            });

            // Set Active Mobile
            const activeBtn = document.getElementById(`m-nav-${active}`);
            if(activeBtn) {
                activeBtn.classList.add('text-indigo-600');
                activeBtn.classList.remove('text-gray-400');
            }

            // Set Active Desktop
            const dActiveBtn = document.getElementById(`d-nav-${active}`);
            if(dActiveBtn) {
                dActiveBtn.classList.add('bg-indigo-50', 'text-indigo-600');
                dActiveBtn.classList.remove('text-gray-600');
            }
        }

        // --- DATA LISTENERS ---
        function initDataListeners() {
            // Products
            onValue(ref(db, 'products'), (snapshot) => {
                const data = snapshot.val();
                products = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                renderPOS();
                renderInventory();
            });
            // Orders
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val();
                const orders = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse() : [];
                renderOrders(orders);
            });
        }

        // --- RENDERERS ---

        // 1. POS GRID
        function renderPOS() {
            const container = document.getElementById('pos-grid');
            const search = document.getElementById('search-pos').value.toLowerCase();
            
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(search) || 
                (p.brand && p.brand.toLowerCase().includes(search))
            );

            container.innerHTML = filtered.map(p => `
                <div onclick="addToCart('${p.id}')" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden active:scale-95 transition flex flex-col h-full relative">
                    <div class="h-28 bg-gray-100 flex items-center justify-center relative">
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="w-full h-full object-cover">` : `<i data-lucide="image" class="text-gray-300 w-8 h-8"></i>`}
                        ${p.stock <= 0 ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-xs font-bold uppercase">Agotado</div>' : ''}
                        ${p.stock > 0 && p.stock < 5 ? '<div class="absolute top-1 right-1 bg-orange-500 text-white text-[10px] px-1.5 rounded font-bold">¡Poco!</div>' : ''}
                    </div>
                    <div class="p-3 flex flex-col flex-1">
                        <div class="text-[10px] text-gray-400 font-bold uppercase mb-0.5">${p.brand || 'Genérico'}</div>
                        <h3 class="text-xs font-bold text-gray-800 leading-tight mb-1 line-clamp-2">${p.name}</h3>
                        ${p.color ? `<p class="text-[10px] text-gray-500 mb-2">Color: ${p.color}</p>` : ''}
                        <div class="mt-auto flex justify-between items-center">
                            <span class="text-indigo-600 font-bold">$${parseFloat(p.price).toFixed(2)}</span>
                            <div class="bg-gray-100 rounded-full w-6 h-6 flex items-center justify-center text-indigo-600 shadow-sm"><i data-lucide="plus" class="w-3 h-3"></i></div>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        document.getElementById('search-pos').addEventListener('input', renderPOS);

        // 2. INVENTORY LIST (Cards for Mobile)
        function renderInventory() {
            const container = document.getElementById('inventory-list');
            container.innerHTML = products.map(p => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden shrink-0">
                            ${p.imageUrl ? `<img src="${p.imageUrl}" class="w-full h-full object-cover">` : `<span class="text-xs font-bold text-gray-400">${(p.name[0] || '?').toUpperCase()}</span>`}
                        </div>
                        <div>
                            <h3 class="font-bold text-sm text-gray-800">${p.name}</h3>
                            <p class="text-xs text-gray-500">${p.brand || ''} • ${p.category || 'General'}</p>
                            <div class="text-xs mt-1">
                                <span class="text-gray-400">Costo: $${p.cost}</span>
                                <span class="ml-2 font-bold text-green-600">Venta: $${p.price}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <div class="text-sm font-bold ${p.stock < 5 ? 'text-red-500' : 'text-gray-700'}">
                            Stock: ${p.stock}
                        </div>
                        <button onclick="editProduct('${p.id}')" class="text-indigo-600 text-xs font-bold bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100">Editar</button>
                    </div>
                </div>
            `).join('');
        }

        // 3. CART & LOGIC
        window.addToCart = (id) => {
            const prod = products.find(p => p.id === id);
            if(!prod || prod.stock <= 0) return alert("Sin stock disponible");
            
            const existing = cart.find(c => c.id === id);
            if(existing) {
                if(existing.qty >= prod.stock) return alert("Stock máximo alcanzado");
                existing.qty++;
            } else {
                cart.push({...prod, qty: 1});
            }
            renderCart();
            // Feedback visual simple
            const btn = document.getElementById('m-nav-cart');
            btn.classList.add('scale-110');
            setTimeout(() => btn.classList.remove('scale-110'), 200);
        };

        window.removeFromCart = (idx) => {
            cart.splice(idx, 1);
            renderCart();
        };

        window.clearCart = () => {
            cart = [];
            renderCart();
        }

        function renderCart() {
            // Cálculos
            const subtotal = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
            
            // Render Mobile List
            const mobileContainer = document.getElementById('cart-items-mobile');
            const desktopContainer = document.getElementById('cart-items-desktop');
            
            const html = cart.map((item, idx) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <div class="flex items-center gap-3">
                         <div class="w-10 h-10 bg-white rounded border flex items-center justify-center text-xs font-bold text-gray-400">
                            ${item.qty}x
                         </div>
                         <div>
                            <p class="font-bold text-sm text-gray-800 line-clamp-1 w-40">${item.name}</p>
                            <p class="text-xs text-indigo-600">$${(item.price * item.qty).toFixed(2)}</p>
                         </div>
                    </div>
                    <button onclick="removeFromCart(${idx})" class="text-red-400 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');

            if(cart.length === 0) {
                 mobileContainer.innerHTML = desktopContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                        <i data-lucide="shopping-cart" class="w-10 h-10 mb-2 opacity-30"></i>
                        <p class="text-sm">Vacío</p>
                    </div>`;
            } else {
                mobileContainer.innerHTML = html;
                desktopContainer.innerHTML = html;
            }

            // Totales Mobile
            document.getElementById('m-subtotal').innerText = `$${subtotal.toFixed(2)}`;
            const mDisc = parseFloat(document.getElementById('m-discount').value) || 0;
            document.getElementById('m-total').innerText = `$${Math.max(0, subtotal - mDisc).toFixed(2)}`;

            // Totales Desktop & Badges
            document.getElementById('badge-nav').innerText = cart.length;
            document.getElementById('badge-nav').classList.toggle('hidden', cart.length === 0);
            document.getElementById('badge-cart-mobile').innerText = cart.length;
            document.getElementById('badge-cart-mobile').classList.toggle('hidden', cart.length === 0);

            // Resumen Desktop
            document.getElementById('cart-summary-desktop').innerHTML = `
                <div class="flex justify-between text-sm"><span>Subtotal:</span> <span>$${subtotal.toFixed(2)}</span></div>
                <div class="flex justify-between items-center text-sm my-2">
                    <span>Descuento:</span> 
                    <input type="number" id="d-discount" class="w-16 border rounded text-right p-1" placeholder="0" oninput="renderCart()">
                </div>
                <div class="flex justify-between font-bold text-xl pt-2 border-t">
                    <span>Total:</span> 
                    <span>$${Math.max(0, subtotal - (parseFloat(document.getElementById('d-discount')?.value) || 0)).toFixed(2)}</span>
                </div>
            `;
            
            lucide.createIcons();
        }

        // Listeners descuento mobile
        document.getElementById('m-discount').addEventListener('input', renderCart);

        // --- SALES PROCESS ---
        window.processSale = async () => {
            if(cart.length === 0) return alert("Carrito vacío");
            
            const subtotal = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
            // Detectar si estamos en móvil o desktop para el input de descuento correcto
            const discInput = document.querySelector('#view-cart:not(.hidden) #m-discount') || document.querySelector('#d-discount');
            const discount = parseFloat(discInput?.value) || 0;
            const total = Math.max(0, subtotal - discount);

            if(!confirm(`¿Cobrar $${total.toFixed(2)}?`)) return;

            const order = {
                date: new Date().toISOString(),
                items: cart,
                subtotal, discount, total,
                seller: currentUser.email
            };

            try {
                // Stock Updates
                const updates = cart.map(item => {
                    return runTransaction(ref(db, `products/${item.id}/stock`), (current) => {
                        return (current || 0) - item.qty;
                    });
                });
                await Promise.all(updates);
                
                // Save Order
                const newOrderRef = await push(ref(db, 'orders'), order);
                
                // Reset
                cart = [];
                if(discInput) discInput.value = '';
                renderCart();
                navTo('pos'); // Volver al inicio
                showInvoiceModal({id: newOrderRef.key, ...order});

            } catch(e) {
                alert("Error: " + e.message);
            }
        };

        // --- PRODUCT MANAGEMENT ---
        const modalProd = document.getElementById('modal-product');
        const formProd = document.getElementById('product-form');

        window.openProductModal = () => {
            formProd.reset();
            document.getElementById('prod-id').value = '';
            document.getElementById('modal-title').innerText = "Nuevo Producto";
            modalProd.classList.remove('hidden');
        };

        window.closeProductModal = () => {
            modalProd.classList.add('hidden');
        };

        window.editProduct = (id) => {
            const p = products.find(x => x.id === id);
            if(!p) return;
            
            // Populate Form
            Object.keys(p).forEach(key => {
                const input = formProd.elements[key];
                if(input) input.value = p[key];
            });
            document.getElementById('prod-id').value = id; // Asegurar ID
            document.getElementById('modal-title').innerText = "Editar Producto";
            modalProd.classList.remove('hidden');
        };

        window.submitProduct = async () => {
            const formData = new FormData(formProd);
            const data = Object.fromEntries(formData.entries());
            
            // Validaciones
            if(!data.name || !data.price || !data.stock) return alert("Nombre, Precio y Stock son obligatorios");

            // Conversiones de tipos
            data.price = parseFloat(data.price);
            data.cost = parseFloat(data.cost);
            data.stock = parseInt(data.stock);
            if(data.minStock) data.minStock = parseInt(data.minStock);

            const id = data.id;
            delete data.id; // No guardar ID dentro del objeto data en DB

            try {
                if(id) {
                    // Update
                    await set(ref(db, `products/${id}`), data);
                } else {
                    // Create
                    await push(ref(db, 'products'), data);
                }
                closeProductModal();
                alert("Producto Guardado");
            } catch(e) {
                alert("Error guardando: " + e.message);
            }
        };

        // --- ORDERS & INVOICE ---
        function renderOrders(list) {
            const container = document.getElementById('orders-list');
            container.innerHTML = list.map(o => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-gray-400 font-mono">#${o.id.slice(-6)}</div>
                        <div class="font-bold text-sm">${new Date(o.date).toLocaleDateString()} ${new Date(o.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        <div class="text-xs text-gray-500">${o.items.length} items</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-indigo-600">$${parseFloat(o.total).toFixed(2)}</div>
                        <button onclick='window.viewInvoiceData("${o.id}")' class="text-xs text-gray-400 underline mt-1">Ver Ticket</button>
                    </div>
                </div>
            `).join('');
        }

        window.viewInvoiceData = (id) => {
             // Buscar en lista local (optimización) o hacer fetch si fuera necesario
             // Como ya tenemos orders en memoria por el listener:
             // (Nota: la lista orders dentro de renderOrders viene del snapshot, necesito acceso a ella.
             //  Lo ideal es buscar en la variable global products o hacer un get a DB. 
             //  Aquí haremos un get rápido para asegurar datos frescos).
             get(ref(db, `orders/${id}`)).then(snap => {
                 if(snap.exists()) showInvoiceModal({id: snap.key, ...snap.val()});
             });
        };

        window.showInvoiceModal = (order) => {
            document.getElementById('inv-id').innerText = `#${order.id}`;
            document.getElementById('inv-date').innerText = new Date(order.date).toLocaleString();
            
            document.getElementById('inv-items').innerHTML = order.items.map(i => `
                <div class="flex justify-between">
                    <span>${i.qty} x ${i.name}</span>
                    <span>$${(i.price * i.qty).toFixed(2)}</span>
                </div>
            `).join('');

            document.getElementById('inv-subtotal').innerText = `$${order.subtotal.toFixed(2)}`;
            document.getElementById('inv-discount').innerText = `-$${(order.discount || 0).toFixed(2)}`;
            document.getElementById('inv-total').innerText = `$${order.total.toFixed(2)}`;

            document.getElementById('invoice-view').classList.remove('hidden');
        };

        window.closeInvoice = () => document.getElementById('invoice-view').classList.add('hidden');

        // --- AUTH UI ---
        const loginForm = document.getElementById('login-form');
        let isLoginMode = true;

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const btn = document.getElementById('btn-login');

            btn.disabled = true;
            btn.innerHTML = '<div class="loader mx-auto border-white border-t-transparent"></div>';

            try {
                if(isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    await createUserWithEmailAndPassword(auth, email, pass);
                }
            } catch(e) {
                alert("Error: " + e.message);
                btn.disabled = false;
                btn.innerText = isLoginMode ? "Iniciar Sesión" : "Registrarse";
            }
        });

        document.getElementById('toggle-auth').addEventListener('click', (e) => {
            isLoginMode = !isLoginMode;
            e.target.innerText = isLoginMode ? "¿No tienes cuenta? Regístrate" : "¿Ya tienes cuenta? Inicia Sesión";
            document.getElementById('btn-login').innerText = isLoginMode ? "Iniciar Sesión" : "Registrarse";
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            if(confirm("¿Salir?")) signOut(auth);
        });

    </script>
</body>
</html>


