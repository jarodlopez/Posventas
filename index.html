<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POS Delivery & WhatsApp</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        /* Ajustes Mobile */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #6366f1;
            border-radius: 50%; width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos Inputs M贸viles */
        input, select, textarea { font-size: 16px !important; } /* Evita zoom en iOS */

        /* IMPRESIN */
        @media print {
            body > *:not(#invoice-view) { display: none !important; }
            #invoice-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: white; display: block !important; padding: 0; }
            .no-print { display: none !important; }
            #invoice-card { box-shadow: none !important; border: none !important; width: 100% !important; }
        }
        
        .input-field { width: 100%; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 0.75rem 1rem; outline: none; transition: all; background: #f9fafb; }
        .input-field:focus { border-color: #6366f1; background: white; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .label-input { display: block; font-size: 0.75rem; font-weight: 700; color: #4b5563; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen flex flex-col overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                    <i data-lucide="store" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900">Bienvenido</h1>
                <p class="text-gray-500 mt-2">Gesti贸n de Ventas y Delivery</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Correo</label>
                    <input type="email" id="login-email" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contrase帽a</label>
                    <input type="password" id="login-pass" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none" required>
                </div>
                <button type="submit" id="btn-login" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">
                    Ingresar
                </button>
            </form>
            <button id="toggle-auth" class="mt-6 text-sm text-indigo-600 font-medium w-full text-center py-2">驴No tienes cuenta? Reg铆strate</button>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-screen" class="flex-1 flex flex-col md:flex-row h-full relative hidden">

        <!-- DESKTOP SIDEBAR -->
        <nav class="hidden md:flex w-64 bg-white border-r flex-col p-4 z-20">
            <div class="flex items-center gap-3 px-2 mb-8 mt-2">
                <div class="bg-indigo-600 p-2 rounded-lg"><i data-lucide="zap" class="text-white w-5 h-5"></i></div>
                <span class="font-bold text-xl">QuickPOS</span>
            </div>
            
            <div class="space-y-1">
                <button onclick="navTo('pos')" id="d-nav-pos" class="nav-item-d w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-100 transition font-medium">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i> Ventas
                </button>
                <button onclick="navTo('inventory')" id="d-nav-inventory" class="nav-item-d w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-100 transition font-medium">
                    <i data-lucide="package" class="w-5 h-5"></i> Inventario
                </button>
                <button onclick="navTo('orders')" id="d-nav-orders" class="nav-item-d w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-100 transition font-medium">
                    <i data-lucide="history" class="w-5 h-5"></i> Historial
                </button>
            </div>

            <div class="mt-auto">
                <div class="bg-gray-50 p-3 rounded-xl mb-4">
                    <p id="user-email-display" class="text-xs text-gray-500 truncate font-medium">usuario@email.com</p>
                </div>
                <button id="btn-logout" class="w-full flex items-center gap-2 text-red-500 px-4 py-2 hover:bg-red-50 rounded-lg transition text-sm font-bold">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Salir
                </button>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="flex-1 relative overflow-hidden bg-gray-50 flex flex-col">
            
            <!-- VIEW: POS -->
            <div id="view-pos" class="absolute inset-0 flex flex-col md:flex-row fade-in">
                <!-- Mobile Header -->
                <div class="md:hidden bg-white p-4 flex items-center justify-between border-b shadow-sm z-10">
                    <h1 class="font-bold text-lg text-indigo-900">Punto de Venta</h1>
                    <div class="relative" onclick="navTo('cart')">
                        <i data-lucide="shopping-cart" class="text-gray-700 w-6 h-6"></i>
                        <span id="badge-cart-mobile" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 flex items-center justify-center rounded-full hidden">0</span>
                    </div>
                </div>

                <!-- Products Area -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <div class="p-4 pb-2">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
                            <input type="text" id="search-pos" placeholder="Buscar producto, marca o SKU..." class="w-full bg-white border-none shadow-sm rounded-xl py-3 pl-10 pr-4 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>
                    <div id="pos-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 content-start pb-24 md:pb-4">
                        <!-- JS Injected -->
                    </div>
                </div>

                <!-- Desktop Cart Sidebar -->
                <div class="hidden md:flex w-96 bg-white border-l flex-col shadow-xl z-20">
                    <div class="p-5 border-b bg-gray-50 flex justify-between items-center">
                        <h2 class="font-bold text-lg flex items-center gap-2"><i data-lucide="shopping-cart"></i> Ticket</h2>
                        <button onclick="clearCart()" class="text-xs text-red-500 font-medium hover:underline">Vaciar</button>
                    </div>
                    <div id="cart-items-desktop" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                    <div class="p-5 bg-gray-50 border-t space-y-3">
                        <div id="cart-summary-desktop"></div>
                        <button onclick="openCheckoutModal()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">PROCESAR VENTA</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: CART (Mobile Only) -->
            <div id="view-cart" class="absolute inset-0 flex flex-col bg-white z-30 hidden fade-in md:hidden">
                <div class="p-4 border-b flex items-center justify-between bg-white shadow-sm sticky top-0 z-10">
                    <h1 class="font-bold text-xl">Carrito</h1>
                    <button onclick="clearCart()" class="text-red-500 text-sm font-medium">Limpiar</button>
                </div>
                <div id="cart-items-mobile" class="flex-1 overflow-y-auto p-4 space-y-4 pb-32">
                    <!-- JS Injected -->
                </div>
                <div class="absolute bottom-[60px] left-0 w-full bg-white border-t p-4 shadow-lg">
                     <div class="space-y-2 mb-3">
                        <div class="flex justify-between text-sm"><span>Subtotal</span> <span id="m-subtotal">C$0.00</span></div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Descuento</span>
                            <input type="number" id="m-discount" class="w-20 text-right border rounded p-1 text-sm bg-gray-50" placeholder="0.00">
                        </div>
                        <div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t"><span>Total</span> <span id="m-total">C$0.00</span></div>
                    </div>
                    <!-- Bot贸n de Cobro Corregido -->
                    <button onclick="openCheckoutModal()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">
                        Cobrar y Facturar
                    </button>
                </div>
            </div>

            <!-- VIEW: INVENTORY -->
            <div id="view-inventory" class="absolute inset-0 flex flex-col hidden fade-in bg-gray-50">
                <div class="p-4 bg-white border-b flex justify-between items-center sticky top-0 z-10 shadow-sm">
                    <h1 class="font-bold text-lg md:text-2xl">Inventario</h1>
                    <button onclick="openProductModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-indigo-700 transition shadow-md">
                        <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden md:inline">Nuevo Producto</span><span class="md:hidden">Nuevo</span>
                    </button>
                </div>
                <div class="p-4 flex-1 overflow-y-auto pb-24">
                    <div id="inventory-list" class="space-y-3 md:grid md:grid-cols-2 lg:grid-cols-3 md:space-y-0 md:gap-4">
                        <!-- JS Injected -->
                    </div>
                </div>
            </div>

            <!-- VIEW: ORDERS -->
            <div id="view-orders" class="absolute inset-0 flex flex-col hidden fade-in bg-gray-50">
                <div class="p-4 bg-white border-b sticky top-0 z-10 shadow-sm">
                    <h1 class="font-bold text-lg md:text-2xl">Historial</h1>
                </div>
                <div id="orders-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-24">
                    <!-- JS Injected -->
                </div>
            </div>
        </main>

        <!-- MOBILE BOTTOM NAV -->
        <div class="md:hidden fixed bottom-0 w-full bg-white border-t flex justify-around items-center py-2 pb-safe z-40 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
            <button onclick="navTo('pos')" id="m-nav-pos" class="flex flex-col items-center p-2 text-indigo-600 transition"><i data-lucide="store" class="w-6 h-6 mb-1"></i><span class="text-[10px] font-medium">Ventas</span></button>
            <button onclick="navTo('cart')" id="m-nav-cart" class="flex flex-col items-center p-2 text-gray-400 transition relative">
                <i data-lucide="shopping-cart" class="w-6 h-6 mb-1"></i>
                <span id="badge-nav" class="absolute top-1 right-2 bg-red-500 text-white text-[9px] w-3.5 h-3.5 rounded-full flex items-center justify-center hidden">0</span>
                <span class="text-[10px] font-medium">Carrito</span>
            </button>
            <button onclick="navTo('inventory')" id="m-nav-inventory" class="flex flex-col items-center p-2 text-gray-400 transition"><i data-lucide="package" class="w-6 h-6 mb-1"></i><span class="text-[10px] font-medium">Stock</span></button>
            <button onclick="navTo('orders')" id="m-nav-orders" class="flex flex-col items-center p-2 text-gray-400 transition"><i data-lucide="file-clock" class="w-6 h-6 mb-1"></i><span class="text-[10px] font-medium">Historial</span></button>
        </div>
    </div>

    <!-- MODAL PRODUCTO -->
    <div id="modal-product" class="fixed inset-0 z-50 bg-black/50 hidden flex items-end md:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full md:w-[600px] h-[90vh] md:h-auto rounded-t-2xl md:rounded-2xl flex flex-col shadow-2xl overflow-hidden animate-slide-up">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg" id="modal-title">Gesti贸n Producto</h3>
                <button onclick="closeProductModal()" class="p-2 bg-gray-200 rounded-full hover:bg-gray-300"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <form id="product-form" class="space-y-4">
                    <input type="hidden" name="id" id="prod-id">
                    <div>
                        <label class="label-input">Nombre del Producto *</label>
                        <input name="name" required class="input-field" placeholder="Ej: Camiseta Polo">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="label-input">Marca</label>
                            <input name="brand" class="input-field" placeholder="Ej: Nike">
                        </div>
                        <div>
                            <label class="label-input">Categor铆a</label>
                            <input name="category" list="categories" class="input-field" placeholder="Ej: Ropa">
                            <datalist id="categories"><option value="Ropa"><option value="Calzado"><option value="Electr贸nica"></datalist>
                        </div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 grid grid-cols-3 gap-3">
                        <!-- SKU/C贸digo de Producto A帽adido -->
                        <div>
                            <label class="label-input text-indigo-900">SKU/C贸d.</label>
                            <input name="sku" required class="input-field border-indigo-200" placeholder="A-100-M">
                        </div>
                        <div>
                            <label class="label-input text-indigo-900">Costo (C$)</label>
                            <input type="number" step="0.01" name="cost" required class="input-field border-indigo-200" placeholder="0.00">
                        </div>
                        <div>
                            <label class="label-input text-indigo-900">Precio Venta (C$)</label>
                            <input type="number" step="0.01" name="price" required class="input-field border-indigo-200 font-bold" placeholder="0.00">
                        </div>
                        <div class="col-span-3">
                            <label class="label-input text-indigo-900">Stock</label>
                            <input type="number" name="stock" required class="input-field border-indigo-200" placeholder="0">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="label-input">Color</label><input name="color" class="input-field" placeholder="Ej: Rojo"></div>
                        <div><label class="label-input">Talla</label><input name="size" class="input-field" placeholder="Ej: M"></div>
                    </div>
                    <div>
                        <label class="label-input">Imagen URL</label>
                        <input name="imageUrl" class="input-field" placeholder="https://...">
                    </div>
                </form>
            </div>
            <div class="p-4 border-t bg-gray-50 flex gap-3">
                <button onclick="closeProductModal()" class="flex-1 py-3 rounded-xl border border-gray-300 font-bold text-gray-600">Cancelar</button>
                <button onclick="submitProduct()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL CHECKOUT (DATOS DE ENTREGA) -->
    <div id="modal-checkout" class="fixed inset-0 z-50 bg-black/50 hidden flex items-end md:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full md:w-[500px] rounded-t-2xl md:rounded-2xl flex flex-col shadow-2xl overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="truck" class="w-5 h-5"></i> Detalles de Venta</h3>
                <button onclick="document.getElementById('modal-checkout').classList.add('hidden')" class="p-1 rounded-full hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto max-h-[70vh]">
                
                <!-- Tipo de Entrega -->
                <div>
                    <label class="label-input">Tipo de Entrega</label>
                    <div class="grid grid-cols-2 gap-3 mt-1">
                        <label class="cursor-pointer">
                            <input type="radio" name="deliveryType" value="tienda" class="peer sr-only" checked onchange="toggleDeliveryFields()">
                            <div class="p-3 border rounded-xl text-center peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 transition">
                                <i data-lucide="store" class="w-5 h-5 mx-auto mb-1"></i> Retiro en Tienda
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="deliveryType" value="delivery" class="peer sr-only" onchange="toggleDeliveryFields()">
                            <div class="p-3 border rounded-xl text-center peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 transition">
                                <i data-lucide="bike" class="w-5 h-5 mx-auto mb-1"></i> Delivery
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Datos Cliente -->
                <div class="space-y-3">
                    <div>
                        <label class="label-input">Nombre del Cliente *</label>
                        <input id="checkout-name" class="input-field" placeholder="Nombre completo">
                    </div>
                    <div>
                        <label class="label-input">Tel茅fono / WhatsApp *</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">+505</span>
                            <input type="tel" id="checkout-phone" class="input-field rounded-l-none" placeholder="8888 7777">
                        </div>
                    </div>
                </div>

                <!-- Direcci贸n (Oculto si es Tienda) -->
                <div id="delivery-details" class="hidden space-y-3 p-3 bg-gray-50 rounded-xl border">
                    <div>
                        <label class="label-input">Direcci贸n de Entrega</label>
                        <textarea id="checkout-address" rows="2" class="input-field resize-none" placeholder="Barrio, calle, n煤mero de casa, referencias..."></textarea>
                    </div>
                    <div>
                        <label class="label-input">Costo de Env铆o Adicional (C$)</label>
                        <input type="number" id="checkout-shipping" value="0" class="input-field bg-white" oninput="updateCheckoutTotal()">
                    </div>
                </div>

                <!-- M茅todo de Pago -->
                <div>
                    <label class="label-input">M茅todo de Pago</label>
                    <select id="checkout-payment" class="input-field appearance-none bg-white">
                        <option value="Efectivo"> Efectivo</option>
                        <option value="Transferencia"> Transferencia / Dep贸sito</option>
                        <option value="Tarjeta"> Tarjeta de Cr茅dito/D茅bito</option>
                    </select>
                </div>

                <div class="pt-4 border-t flex justify-between items-center">
                    <span class="text-sm text-gray-500">Total a Pagar:</span>
                    <span id="checkout-total-display" class="text-2xl font-bold text-indigo-700">C$0.00</span>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t">
                <button onclick="confirmTransaction()" class="w-full bg-green-600 text-white py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 hover:bg-green-700 transition">
                    <i data-lucide="check-circle" class="w-5 h-5"></i> Confirmar Venta
                </button>
            </div>
        </div>
    </div>

    <!-- FACTURA FINAL CON OPCIONES WHATSAPP -->
    <div id="invoice-view" class="fixed inset-0 bg-gray-100 z-[100] hidden overflow-y-auto">
        <div class="max-w-xl mx-auto min-h-screen bg-white shadow-2xl relative" id="invoice-card">
            
            <!-- Barra Superior (No Imprimible) -->
            <div class="no-print bg-gray-800 p-4 sticky top-0 z-20 flex justify-between items-center text-white">
                <h2 class="font-bold flex items-center gap-2"><i data-lucide="check-circle" class="text-green-400"></i> Venta Exitosa</h2>
                <button onclick="closeInvoice()" class="p-1 hover:bg-gray-700 rounded"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <!-- Contenido Factura -->
            <div class="p-8 print:p-0" id="printable-area">
                <div class="text-center border-b pb-6 mb-6">
                    <div class="inline-block p-3 bg-indigo-600 rounded-full mb-3 print:hidden">
                        <i data-lucide="shopping-bag" class="text-white w-6 h-6"></i>
                    </div>
                    <h1 class="text-2xl font-bold uppercase tracking-widest text-gray-800">Recibo de Venta</h1>
                    <p class="text-sm text-gray-500 mt-1" id="inv-date">Fecha</p>
                    <p class="text-xs text-gray-400 font-mono mt-1" id="inv-id">#ID</p>
                </div>

                <!-- Info Cliente -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6 text-sm space-y-2 border print:border-none print:bg-transparent print:p-0">
                    <div class="flex justify-between">
                        <span class="text-gray-500">Cliente:</span>
                        <span class="font-bold text-gray-800" id="inv-customer">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Tel茅fono:</span>
                        <span class="font-bold text-gray-800" id="inv-phone">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">M茅todo Pago:</span>
                        <span class="font-bold text-gray-800" id="inv-payment">-</span>
                    </div>
                     <div class="flex justify-between">
                        <span class="text-gray-500">Entrega:</span>
                        <span class="font-bold text-gray-800" id="inv-delivery-type">-</span>
                    </div>
                    <div id="inv-address-box" class="hidden border-t pt-2 mt-2">
                        <span class="block text-gray-500 text-xs mb-1">Direcci贸n de Entrega:</span>
                        <span class="block font-medium text-gray-800" id="inv-address"></span>
                    </div>
                </div>

                <!-- Tabla Items -->
                <div class="mb-6">
                    <div class="flex justify-between text-xs font-bold text-gray-400 uppercase border-b pb-2 mb-2">
                        <span>Descripci贸n</span>
                        <span>Total</span>
                    </div>
                    <div id="inv-items" class="space-y-3 text-sm text-gray-700"></div>
                </div>

                <!-- Totales -->
                <div class="space-y-2 text-right border-t pt-4">
                    <div class="flex justify-between text-sm"><span>Subtotal</span> <span id="inv-subtotal" class="font-medium">C$0.00</span></div>
                    <div class="flex justify-between text-sm text-red-500" id="row-inv-disc"><span>Descuento</span> <span id="inv-discount">-C$0.00</span></div>
                    <div class="flex justify-between text-sm text-blue-600" id="row-inv-ship"><span>Env铆o</span> <span id="inv-shipping">+C$0.00</span></div>
                    <div class="flex justify-between text-xl font-bold text-indigo-900 pt-2 border-t mt-2"><span>Total Final</span> <span id="inv-total">C$0.00</span></div>
                </div>

                <div class="mt-12 text-center print:mt-8">
                    <p class="font-bold text-gray-800">隆Gracias por su preferencia!</p>
                    <p class="text-xs text-gray-400 mt-1">Si tiene dudas contacte a soporte.</p>
                </div>
            </div>

            <!-- Botones de Acci贸n (Whatsapp / Print) -->
            <div class="no-print p-4 bg-gray-50 border-t sticky bottom-0 grid grid-cols-2 gap-3">
                <button onclick="window.print()" class="flex items-center justify-center gap-2 bg-gray-200 text-gray-800 py-3 rounded-xl font-bold hover:bg-gray-300 transition">
                    <i data-lucide="printer" class="w-5 h-5"></i> Imprimir
                </button>
                <button onclick="sendToWhatsApp()" class="flex items-center justify-center gap-2 bg-green-500 text-white py-3 rounded-xl font-bold hover:bg-green-600 transition shadow-lg shadow-green-200">
                    <i data-lucide="message-circle" class="w-5 h-5"></i> Enviar a WhatsApp
                </button>
                <button onclick="copyLink()" class="col-span-2 flex items-center justify-center gap-2 border border-indigo-200 text-indigo-600 py-3 rounded-xl font-medium hover:bg-indigo-50 transition">
                    <i data-lucide="link" class="w-5 h-5"></i> Copiar Enlace Factura
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, get, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // NOTA: Reemplazar con las credenciales de Firebase de tu entorno si es necesario
        const firebaseConfig = {
            apiKey: "AIzaSyDF374bHcODY8N0R78HE8kZpmjeGeuhniU",
            authDomain: "posdeventas-a03ca.firebaseapp.com",
            databaseURL: "https://posdeventas-a03ca-default-rtdb.firebaseio.com",
            projectId: "posdeventas-a03ca",
            storageBucket: "posdeventas-a03ca.firebasestorage.app",
            messagingSenderId: "975141670948",
            appId: "1:975141670948:web:e58ed3da11878ecfdf88b1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let products = [];
        let cart = [];
        let currentOrder = null;
        const CURRENCY = "C$"; // S铆mbolo de moneda

        // ELEMENTOS DOM
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const views = {
            pos: document.getElementById('view-pos'),
            cart: document.getElementById('view-cart'),
            inventory: document.getElementById('view-inventory'),
            orders: document.getElementById('view-orders')
        };

        window.addEventListener('load', () => {
            lucide.createIcons();
            // Revisar si es enlace p煤blico de factura
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            if(orderId) {
                // Modo P煤blico: Mostrar solo factura
                authScreen.classList.add('hidden');
                appScreen.classList.add('hidden');
                fetchAndShowInvoice(orderId);
            } else {
                // Modo Admin: Chequear Auth
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        authScreen.classList.add('hidden');
                        appScreen.classList.remove('hidden');
                        appScreen.classList.add('flex');
                        document.getElementById('user-email-display').innerText = user.email;
                        initListeners();
                        navTo('pos'); // Asegurar vista inicial
                    } else {
                        authScreen.classList.remove('hidden');
                        appScreen.classList.add('hidden');
                        appScreen.classList.remove('flex');
                    }
                });
            }
        });

        // --- NAVEGACIN ---
        window.navTo = (viewName) => {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            updateNavStyles(viewName);
        };

        function updateNavStyles(active) {
            ['pos', 'cart', 'inventory', 'orders'].forEach(v => {
                document.getElementById(`m-nav-${v}`)?.classList.replace('text-indigo-600', 'text-gray-400');
                document.getElementById(`d-nav-${v}`)?.classList.remove('bg-indigo-50', 'text-indigo-600');
            });
            document.getElementById(`m-nav-${active}`)?.classList.replace('text-gray-400', 'text-indigo-600');
            document.getElementById(`d-nav-${active}`)?.classList.add('bg-indigo-50', 'text-indigo-600');
        }

        // --- DATOS ---
        function initListeners() {
            onValue(ref(db, 'products'), (snapshot) => {
                const data = snapshot.val();
                products = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                renderPOS();
                renderInventory();
            });
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val();
                const orders = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse() : [];
                renderOrders(orders);
            });
        }

        // --- RENDER POS ---
        function renderPOS() {
            const search = document.getElementById('search-pos').value.toLowerCase();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(search) || 
                (p.brand && p.brand.toLowerCase().includes(search)) ||
                (p.sku && p.sku.toLowerCase().includes(search)) // B煤squeda por SKU
            );
            document.getElementById('pos-grid').innerHTML = filtered.map(p => `
                <div onclick="addToCart('${p.id}')" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden active:scale-95 transition flex flex-col h-full relative cursor-pointer group">
                    <div class="h-32 bg-gray-100 flex items-center justify-center relative overflow-hidden">
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">` : `<i data-lucide="image" class="text-gray-300 w-8 h-8"></i>`}
                        ${p.stock <= 0 ? '<div class="absolute inset-0 bg-black/60 flex items-center justify-center text-white text-xs font-bold uppercase backdrop-blur-sm">Agotado</div>' : ''}
                    </div>
                    <div class="p-3 flex flex-col flex-1">
                        <div class="text-[10px] text-gray-400 font-bold uppercase mb-0.5 flex justify-between">
                            <span>${p.brand || 'Gen茅rico'}</span>
                            ${p.sku ? `<span class="font-mono">${p.sku}</span>` : ''}
                        </div>
                        <h3 class="text-xs font-bold text-gray-800 leading-tight mb-1 line-clamp-2">${p.name}</h3>
                        <div class="mt-auto flex justify-between items-center">
                            <span class="text-indigo-600 font-bold">${CURRENCY}${parseFloat(p.price).toFixed(2)}</span>
                            <div class="w-6 h-6 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center"><i data-lucide="plus" class="w-3 h-3"></i></div>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        document.getElementById('search-pos').addEventListener('input', renderPOS);

        // --- CARRITO ---
        window.addToCart = (id) => {
            const p = products.find(x => x.id === id);
            if(!p || p.stock <= 0) return alert("Sin stock");
            const exist = cart.find(c => c.id === id);
            if(exist && exist.qty >= p.stock) return alert("Stock m谩ximo");
            exist ? exist.qty++ : cart.push({...p, qty: 1});
            renderCart();
            animateCartIcon();
        };

        window.removeFromCart = (idx) => { cart.splice(idx, 1); renderCart(); };
        window.clearCart = () => { cart = []; renderCart(); };

        function renderCart() {
            const subtotal = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
            
            // Render HTML
            const html = cart.length ? cart.map((item, i) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <div class="flex items-center gap-3">
                         <div class="w-8 h-8 bg-white rounded border flex items-center justify-center text-xs font-bold text-gray-500">${item.qty}x</div>
                         <div><p class="font-bold text-sm text-gray-800 line-clamp-1 w-32">${item.name}</p><p class="text-xs text-indigo-600">${CURRENCY}${(item.price*item.qty).toFixed(2)}</p></div>
                    </div>
                    <button onclick="removeFromCart(${i})" class="text-red-400 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('') : '<div class="text-center py-10 text-gray-400"><i data-lucide="shopping-cart" class="w-10 h-10 mx-auto mb-2 opacity-30"></i><p>Carrito vac铆o</p></div>';

            document.getElementById('cart-items-mobile').innerHTML = html;
            document.getElementById('cart-items-desktop').innerHTML = html;

            // Actualizar Badges y Totales UI
            const badge = document.getElementById('badge-nav');
            if(cart.length) { badge.classList.remove('hidden'); badge.innerText = cart.length; } else { badge.classList.add('hidden'); }
            
            document.getElementById('m-subtotal').innerText = `${CURRENCY}${subtotal.toFixed(2)}`;
            const disc = parseFloat(document.getElementById('m-discount').value) || 0;
            document.getElementById('m-total').innerText = `${CURRENCY}${Math.max(0, subtotal - disc).toFixed(2)}`;

            document.getElementById('cart-summary-desktop').innerHTML = `
                <div class="flex justify-between text-sm"><span>Subtotal:</span> <span>${CURRENCY}${subtotal.toFixed(2)}</span></div>
                <div class="flex justify-between items-center text-sm my-2"><span>Descuento:</span> <input type="number" id="d-discount" class="w-20 border rounded text-right p-1" placeholder="0" oninput="renderCart()"></div>
                <div class="flex justify-between font-bold text-xl pt-2 border-t text-indigo-900"><span>Total:</span> <span>${CURRENCY}${Math.max(0, subtotal - (parseFloat(document.getElementById('d-discount')?.value)||0)).toFixed(2)}</span></div>
            `;
            lucide.createIcons();
        }

        document.getElementById('m-discount').addEventListener('input', renderCart);

        function animateCartIcon() {
            const btn = document.getElementById('m-nav-cart');
            btn.classList.add('scale-110', 'text-indigo-600');
            setTimeout(() => btn.classList.remove('scale-110', 'text-indigo-600'), 200);
        }

        // --- PROCESO DE VENTA (CHECKOUT) ---
        window.openCheckoutModal = () => {
            if(cart.length === 0) return alert("Carrito vac铆o");
            
            // Sincronizar totales antes de abrir
            const subtotal = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
            const discInput = document.querySelector('#view-cart:not(.hidden) #m-discount') || document.getElementById('d-discount');
            const discount = parseFloat(discInput?.value) || 0;
            
            // Reset fields
            document.getElementById('checkout-name').value = '';
            document.getElementById('checkout-phone').value = '';
            document.getElementById('checkout-address').value = '';
            document.getElementById('checkout-shipping').value = 0;
            
            // Calcular total inicial
            window.currentCheckoutSubtotal = subtotal;
            window.currentCheckoutDiscount = discount;
            updateCheckoutTotal();

            document.getElementById('modal-checkout').classList.remove('hidden');
        };

        window.toggleDeliveryFields = () => {
            const type = document.querySelector('input[name="deliveryType"]:checked').value;
            const details = document.getElementById('delivery-details');
            if(type === 'delivery') {
                details.classList.remove('hidden');
            } else {
                details.classList.add('hidden');
                document.getElementById('checkout-shipping').value = 0;
            }
            updateCheckoutTotal();
        };

        window.updateCheckoutTotal = () => {
            const shipping = parseFloat(document.getElementById('checkout-shipping').value) || 0;
            const total = Math.max(0, window.currentCheckoutSubtotal - window.currentCheckoutDiscount + shipping);
            document.getElementById('checkout-total-display').innerText = `${CURRENCY}${total.toFixed(2)}`;
        };

        window.confirmTransaction = async () => {
            const name = document.getElementById('checkout-name').value.trim();
            const phone = document.getElementById('checkout-phone').value.trim();
            const type = document.querySelector('input[name="deliveryType"]:checked').value;
            const address = document.getElementById('checkout-address').value.trim();
            const payment = document.getElementById('checkout-payment').value;
            const shipping = parseFloat(document.getElementById('checkout-shipping').value) || 0;

            if(!name || !phone) return alert("Nombre y Tel茅fono son obligatorios");
            if(type === 'delivery' && !address) return alert("Direcci贸n requerida para delivery");

            const total = Math.max(0, window.currentCheckoutSubtotal - window.currentCheckoutDiscount + shipping);

            const order = {
                date: new Date().toISOString(),
                items: cart,
                subtotal: window.currentCheckoutSubtotal,
                discount: window.currentCheckoutDiscount,
                shipping: shipping,
                total: total,
                customer: name,
                phone: phone, 
                deliveryType: type,
                address: address,
                paymentMethod: payment,
                seller: currentUser.email
            };

            try {
                // Stock Updates
                const updates = cart.map(item => runTransaction(ref(db, `products/${item.id}/stock`), (curr) => (curr || 0) - item.qty));
                await Promise.all(updates);
                
                // Save Order
                const newRef = await push(ref(db, 'orders'), order);
                
                // Success
                cart = [];
                renderCart();
                document.getElementById('modal-checkout').classList.add('hidden');
                document.getElementById('m-discount').value = '';
                if(document.getElementById('d-discount')) document.getElementById('d-discount').value = '';
                navTo('pos');
                
                // Mostrar Factura con Botones
                showInvoiceModal({id: newRef.key, ...order});

            } catch(e) {
                alert("Error: " + e.message);
            }
        };

        // --- FACTURA Y WHATSAPP ---
        function fetchAndShowInvoice(id) {
            get(ref(db, `orders/${id}`)).then(snap => {
                if(snap.exists()) showInvoiceModal({id: snap.key, ...snap.val()});
                else alert("Factura no encontrada");
            });
        }

        window.showInvoiceModal = (order) => {
            currentOrder = order;
            document.getElementById('inv-id').innerText = `#${order.id.slice(-6).toUpperCase()}`;
            document.getElementById('inv-date').innerText = new Date(order.date).toLocaleString();
            document.getElementById('inv-customer').innerText = order.customer;
            document.getElementById('inv-phone').innerText = order.phone || 'N/A';
            document.getElementById('inv-payment').innerText = order.paymentMethod;
            document.getElementById('inv-delivery-type').innerText = order.deliveryType === 'delivery' ? 'Env铆o a Domicilio' : 'Retiro en Tienda';
            
            // Direcci贸n
            const addrBox = document.getElementById('inv-address-box');
            if(order.deliveryType === 'delivery' && order.address) {
                addrBox.classList.remove('hidden');
                document.getElementById('inv-address').innerText = order.address;
            } else {
                addrBox.classList.add('hidden');
            }

            // Items
            document.getElementById('inv-items').innerHTML = order.items.map(i => `
                <div class="flex justify-between border-b border-gray-100 last:border-0 py-2">
                    <div class="flex gap-2">
                        <span class="font-bold text-gray-500">${i.qty}x</span>
                        <span>${i.name} ${i.sku ? `(<span class="font-mono text-xs text-gray-400">${i.sku}</span>)` : ''}</span>
                    </div>
                    <span class="font-medium">${CURRENCY}${(i.price * i.qty).toFixed(2)}</span>
                </div>
            `).join('');

            // Totales
            document.getElementById('inv-subtotal').innerText = `${CURRENCY}${order.subtotal.toFixed(2)}`;
            
            const discRow = document.getElementById('row-inv-disc');
            if(order.discount > 0) {
                discRow.classList.remove('hidden');
                document.getElementById('inv-discount').innerText = `-${CURRENCY}${order.discount.toFixed(2)}`;
            } else { discRow.classList.add('hidden'); }

            const shipRow = document.getElementById('row-inv-ship');
            if(order.shipping > 0) {
                shipRow.classList.remove('hidden');
                document.getElementById('inv-shipping').innerText = `+${CURRENCY}${order.shipping.toFixed(2)}`;
            } else { shipRow.classList.add('hidden'); }

            document.getElementById('inv-total').innerText = `${CURRENCY}${order.total.toFixed(2)}`;
            
            document.getElementById('invoice-view').classList.remove('hidden');
        };

        window.closeInvoice = () => {
            document.getElementById('invoice-view').classList.add('hidden');
            if(new URLSearchParams(window.location.search).get('orderId')) {
                window.location.href = window.location.pathname; // Limpiar URL
            }
        };

        window.sendToWhatsApp = () => {
            if(!currentOrder) return;
            
            // Construir enlace de la factura
            const invoiceUrl = `${window.location.origin}${window.location.pathname}?orderId=${currentOrder.id}`;
            
            // Construir Mensaje
            let msg = `*HOLA ${currentOrder.customer.toUpperCase()}!*\n`;
            msg += `Gracias por tu compra en Mi Tienda.\n\n`;
            msg += `Ь *Orden:* #${currentOrder.id.slice(-6).toUpperCase()}\n`;
            msg += ` *Fecha:* ${new Date(currentOrder.date).toLocaleDateString()}\n`;
            msg += ` *TOTAL A PAGAR: ${CURRENCY}${currentOrder.total.toFixed(2)}*\n\n`;
            
            if(currentOrder.deliveryType === 'delivery') {
                msg += ` *Entrega:* Delivery\n`;
                msg += ` *Direcci贸n:* ${currentOrder.address}\n`;
            } else {
                msg += ` *Entrega:* Retiro en Tienda\n`;
            }
            
            msg += `\n *Ver Factura Digital:*\n${invoiceUrl}`;

            // N煤mero limpio (quitando espacios o guiones si los hubiera puesto el usuario)
            let phone = currentOrder.phone.replace(/\D/g,''); 
            // Asegurar c贸digo de pa铆s si falta (asumiendo 505 por defecto si no tiene 8+ digitos)
            if(phone.length === 8) phone = '505' + phone;

            const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            window.open(waUrl, '_blank');
        };

        window.copyLink = () => {
            if(!currentOrder) return;
            const url = `${window.location.origin}${window.location.pathname}?orderId=${currentOrder.id}`;
            navigator.clipboard.writeText(url).then(() => alert("Enlace copiado al portapapeles"));
        };

        // --- GESTIN INVENTARIO ---
        const modalProd = document.getElementById('modal-product');
        const formProd = document.getElementById('product-form');

        window.openProductModal = () => { formProd.reset(); document.getElementById('prod-id').value=''; modalProd.classList.remove('hidden'); };
        window.closeProductModal = () => modalProd.classList.add('hidden');
        
        window.editProduct = (id) => {
            const p = products.find(x => x.id===id);
            if(!p) return;
            Object.keys(p).forEach(k => { if(formProd.elements[k]) formProd.elements[k].value = p[k]; });
            document.getElementById('prod-id').value = id;
            modalProd.classList.remove('hidden');
        };

        window.submitProduct = async () => {
            const fd = new FormData(formProd);
            const data = Object.fromEntries(fd.entries());
            // Conversi贸n a n煤meros
            data.price=parseFloat(data.price); 
            data.cost=parseFloat(data.cost); 
            data.stock=parseInt(data.stock);
            // Asegurar que SKU sea string (obligatorio)
            data.sku = data.sku.trim().toUpperCase(); 

            if(!data.sku) return alert("El SKU/C贸digo es obligatorio.");

            const id = data.id; delete data.id;
            try {
                id ? await set(ref(db, `products/${id}`), data) : await push(ref(db, 'products'), data);
                closeProductModal();
                alert("Guardado");
            } catch(e) { alert("Error: "+e.message); }
        };

        function renderInventory() {
            document.getElementById('inventory-list').innerHTML = products.map(p => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gray-100 rounded-lg overflow-hidden shrink-0">${p.imageUrl ? `<img src="${p.imageUrl}" class="w-full h-full object-cover">` : `<span class="flex items-center justify-center h-full text-xs font-bold text-gray-400">IMG</span>`}</div>
                        <div>
                            <h3 class="font-bold text-sm text-gray-800">${p.name}</h3>
                            <p class="text-xs text-gray-500">${p.brand||''}  ${p.category||''}</p>
                            <div class="text-xs mt-1">
                                ${p.sku ? `<span class="font-mono text-indigo-500 font-bold">${p.sku}</span> | ` : ''}
                                <span class="text-gray-400">Costo: ${CURRENCY}${p.cost}</span> 
                                <span class="ml-2 font-bold text-green-600">Venta: ${CURRENCY}${p.price}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <div class="text-sm font-bold ${p.stock<5?'text-red-500':'text-gray-700'}">Stock: ${p.stock}</div>
                        <button onclick="editProduct('${p.id}')" class="text-indigo-600 text-xs font-bold bg-indigo-50 px-2 py-1 rounded">Editar</button>
                    </div>
                </div>
            `).join('');
        }

        // --- AUTH ---
        let isLogin=true;
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const btn = document.getElementById('btn-login');
            btn.innerHTML = '<div class="loader mx-auto border-white border-t-transparent"></div>';
            try {
                isLogin ? await signInWithEmailAndPassword(auth, email, pass) : await createUserWithEmailAndPassword(auth, email, pass);
            } catch(e) { alert("Error: "+e.message); btn.innerText = isLogin?"Ingresar":"Registrar"; }
        });
        document.getElementById('toggle-auth').addEventListener('click', (e) => {
            isLogin = !isLogin;
            e.target.innerText = isLogin ? "驴No tienes cuenta? Reg铆strate" : "驴Ya tienes cuenta? Ingresa";
            document.getElementById('btn-login').innerText = isLogin ? "Ingresar" : "Registrar";
        });
        document.getElementById('btn-logout').addEventListener('click', () => confirm("驴Salir?") && signOut(auth));
        
        // Render Orders History
        function renderOrders(list) {
            document.getElementById('orders-list').innerHTML = list.map(o => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-gray-400 font-mono">#${o.id.slice(-6)}</div>
                        <div class="font-bold text-sm">${o.customer}</div>
                        <div class="text-xs text-gray-500">${new Date(o.date).toLocaleDateString()}  ${o.deliveryType === 'delivery' ? ' Delivery' : ' Tienda'}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-indigo-600">${CURRENCY}${parseFloat(o.total).toFixed(2)}</div>
                        <button onclick='fetchAndShowInvoice("${o.id}")' class="text-xs text-gray-400 underline mt-1">Ver Ticket</button>
                    </div>
                </div>
            `).join('');
        }
        window.fetchAndShowInvoice = fetchAndShowInvoice; 
    </script>
</body>
</html>

