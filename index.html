<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Homemart - Sistema POS</title>

  <!-- ==========================================
       LIBRERÃAS EXTERNAS
       ========================================== -->
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- LibrerÃ­as para Reportes (Excel y PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <!-- React 18 & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * { box-sizing: border-box; }
    
    html, body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
      height: 100%;
      width: 100%;
      overflow: hidden; 
      -webkit-tap-highlight-color: transparent;
    }

    #root {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    /* Scroll interno suave */
    .scroll-container {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      flex: 1;
      position: relative;
    }

    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .input-field {
      width: 100%;
      background-color: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      outline: none;
      transition: all 0.2s;
    }
    .input-field:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .btn-action {
      background-color: #4f46e5;
      color: white;
      font-weight: 700;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
      transition: transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      cursor: pointer;
    }
    .btn-action:active { transform: scale(0.98); }
    .btn-action:disabled { background-color: #9ca3af; box-shadow: none; cursor: not-allowed; }

    /* Animaciones */
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .animate-fade { animation: slideUp 0.3s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // ==========================================
    // 1. CONFIGURACIÃ“N FIREBASE
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyDF374bHcODY8N0R78HE8kZpmjeGeuhniU",
      authDomain: "posdeventas-a03ca.firebaseapp.com",
      projectId: "posdeventas-a03ca",
      storageBucket: "posdeventas-a03ca.firebasestorage.app",
      messagingSenderId: "975141670948",
      appId: "1:975141670948:web:e58ed3da11878ecfdf88b1"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'pos-pro-mobile-v2';

    const getCollectionRef = (collectionName) => {
      return db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(collectionName);
    };

    const { useState, useEffect, useRef } = React;

    // ==========================================
    // 2. COMPONENTES COMUNES
    // ==========================================
    const Icon = ({ name, size = 20, className = "", color = "currentColor" }) => {
      useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
      return <i data-lucide={name} width={size} height={size} className={className} style={{ color: color }}></i>;
    };

    // ==========================================
    // 3. VISTA PÃšBLICA: TRACKING
    // ==========================================
    const TrackingView = ({ trackId }) => {
      const [order, setOrder] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsubscribe = getCollectionRef('orders')
          .where('displayId', '==', trackId).limit(1)
          .onSnapshot((snapshot) => {
            if (!snapshot.empty) setOrder({ id: snapshot.docs[0].id, ...snapshot.docs[0].data() });
            setLoading(false);
          });
        return () => unsubscribe();
      }, [trackId]);

      if (loading) return <div className="h-full flex items-center justify-center"><div className="w-10 h-10 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div></div>;
      if (!order) return <div className="h-full flex items-center justify-center font-bold text-gray-400">Orden no encontrada</div>;

      const steps = ['recibido', 'proceso', 'ruta', 'entregado'];
      let currentStepIndex = steps.indexOf(order.status);
      if (currentStepIndex === -1) currentStepIndex = 0;
      const progressPercent = order.status === 'cancelado' ? 100 : ((currentStepIndex / (steps.length - 1)) * 100);
      const statusColor = order.status === 'cancelado' ? 'bg-red-500' : 'bg-green-500';

      return (
        <div className="flex flex-col h-full bg-gray-50 overflow-hidden">
          <div className="scroll-container pb-10">
            <div className="bg-indigo-600 pb-20 pt-10 px-6 rounded-b-[2.5rem] shadow-xl text-center text-white">
              <div className="bg-white/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm"><Icon name="package-search" size={32} color="white" /></div>
              <h1 className="text-2xl font-black">Homemart</h1>
              <p className="opacity-80 font-mono mt-1">Pedido #{order.displayId}</p>
            </div>

            <div className="px-4 -mt-14 relative z-10 max-w-md mx-auto">
              <div className="bg-white rounded-2xl shadow-xl p-6 mb-6 animate-fade">
                <div className="flex justify-between items-center mb-4">
                  <span className="text-xs font-bold text-gray-400 uppercase">Estado</span>
                  <span className={`px-3 py-1 rounded-full text-xs font-bold text-white ${statusColor}`}>{order.status.toUpperCase()}</span>
                </div>
                <div className="relative pt-2 mb-2">
                  <div className="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                    <div className={`h-full transition-all duration-1000 rounded-full ${statusColor}`} style={{ width: `${progressPercent}%` }}></div>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 space-y-4 animate-fade">
                <h3 className="font-bold text-gray-800 flex items-center gap-2"><Icon name="shopping-bag" size={18} className="text-indigo-600"/> Tu Pedido</h3>
                <div className="space-y-3 border-b border-gray-100 pb-4">
                  {order.cart.map((item, i) => (
                    <div key={i} className="flex justify-between text-sm">
                      <span className="text-gray-700 font-medium">{item.qty}x {item.name} {item.variantName ? `(${item.variantName})` : ''}</span>
                      <span className="font-bold text-gray-800">C${(item.price * item.qty).toFixed(2)}</span>
                    </div>
                  ))}
                </div>
                <div className="bg-gray-50 p-4 rounded-xl space-y-2 text-sm">
                  <div className="flex justify-between"><span>Subtotal</span><span>C${(order.subtotal || 0).toFixed(2)}</span></div>
                  {order.discountAmount > 0 && <div className="flex justify-between text-green-600"><span>Descuento</span><span>-C${order.discountAmount.toFixed(2)}</span></div>}
                  <div className="flex justify-between"><span>IVA ({order.taxRate ? (order.taxRate*100) : 0}%)</span><span>C${(order.tax || 0).toFixed(2)}</span></div>
                  {order.isDelivery && <div className="flex justify-between text-indigo-600 font-bold"><span>EnvÃ­o</span><span>C${order.shipCost.toFixed(2)}</span></div>}
                  <div className="flex justify-between text-xl font-black text-gray-900 border-t pt-2 mt-2"><span>Total</span><span>C${order.total.toFixed(2)}</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==========================================
    // 4. MÃ“DULO LOGIN (SIN REGISTRO)
    // ==========================================
    const LoginScreen = () => {
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [error, setError] = useState("");
      const [loading, setLoading] = useState(false);

      const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true); setError("");
        try {
          await auth.signInWithEmailAndPassword(email, password);
        } catch (err) {
          setError("Credenciales incorrectas o error de conexiÃ³n");
          setLoading(false);
        }
      };

      return (
        <div className="h-full flex flex-col items-center justify-center bg-gray-900 px-6">
          <div className="w-full max-w-sm bg-white rounded-2xl shadow-2xl overflow-hidden animate-fade">
            <div className="h-2 bg-gradient-to-r from-indigo-500 to-purple-600"></div>
            <div className="p-8">
              <div className="text-center mb-8">
                <div className="inline-flex items-center justify-center w-16 h-16 bg-indigo-50 rounded-full mb-4"><Icon name="store" size={32} className="text-indigo-600" /></div>
                <h1 className="text-2xl font-bold text-gray-800">Homemart</h1>
                <p className="text-sm text-gray-400 mt-1">Acceso Administrativo</p>
              </div>
              <form onSubmit={handleLogin} className="space-y-4">
                <input type="email" className="input-field" placeholder="Correo" value={email} onChange={e => setEmail(e.target.value)} required />
                <input type="password" className="input-field" placeholder="ContraseÃ±a" value={password} onChange={e => setPassword(e.target.value)} required />
                {error && <div className="bg-red-50 text-red-500 text-xs p-3 rounded font-bold">{error}</div>}
                <button type="submit" disabled={loading} className="btn-action mt-4">{loading ? 'Verificando...' : 'Iniciar SesiÃ³n'}</button>
              </form>
            </div>
          </div>
        </div>
      );
    };

    // ==========================================
    // 5. MÃ“DULO POS (VENTA)
    // ==========================================
    const POSModule = ({ products, user, shift }) => {
      const [cart, setCart] = useState([]);
      const [search, setSearch] = useState("");
      const [cat, setCat] = useState("");
      const [selectedProd, setSelectedProd] = useState(null);
      
      // Estados para Checkout y Carrito
      const [showCheckout, setShowCheckout] = useState(false);
      const [showMobileCart, setShowMobileCart] = useState(false);
      
      // Descuento y Tax
      const [discountPercent, setDiscountPercent] = useState(0);
      const [taxEnabled, setTaxEnabled] = useState(false); // Por defecto desactivado (opcional)

      const addToCart = (p, variant = null) => {
        if (!shift) return Swal.fire("Caja Cerrada", "Abre turno en Admin", "warning");
        const stock = variant ? Number(variant.stock) : Number(p.stock);
        if (stock <= 0) return Swal.fire("Agotado", "Sin stock", "error");

        const cartId = variant ? `${p.id}-${variant.name}` : p.id;
        const exist = cart.find(x => x.cartId === cartId);
        
        if (exist && exist.qty >= stock) return Swal.fire("Stock MÃ¡ximo", "", "info");
        
        if (exist) {
          setCart(cart.map(x => x.cartId === cartId ? { ...x, qty: x.qty + 1 } : x));
        } else {
          setCart([...cart, { 
            cartId, id: p.id, name: p.name, 
            price: Number(variant ? variant.price : p.price),
            isVariant: !!variant, variantName: variant?.name, 
            qty: 1, maxStock: stock, image: p.image 
          }]);
        }
        if (navigator.vibrate) navigator.vibrate(50);
      };

      const updateQty = (id, delta) => {
        setCart(cart.map(i => i.cartId === id ? { ...i, qty: i.qty + delta } : i).filter(i => i.qty > 0));
      };

      // CÃ¡lculos Financieros
      const subtotal = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
      const discountAmount = subtotal * (discountPercent / 100);
      const taxableBase = subtotal - discountAmount;
      const taxAmount = taxEnabled ? (taxableBase * 0.15) : 0;
      const total = taxableBase + taxAmount;

      const filtered = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) && (!cat || p.category === cat));
      const cats = [...new Set(products.map(p => p.category).filter(Boolean))];

      return (
        <div className="flex h-full relative overflow-hidden">
          {/* Panel Grid Productos */}
          <div className="flex-1 flex flex-col h-full bg-gray-50 min-w-0">
            <div className="p-4 bg-white border-b flex gap-3 shadow-sm z-10 shrink-0">
              <div className="relative flex-1">
                <Icon name="search" size={18} className="absolute left-3 top-3.5 text-gray-400" />
                <input className="w-full bg-gray-100 pl-10 pr-4 py-3 rounded-xl outline-none" placeholder="Buscar..." value={search} onChange={e => setSearch(e.target.value)} />
              </div>
              <select className="bg-gray-100 rounded-xl px-4 font-bold text-gray-600 outline-none" value={cat} onChange={e => setCat(e.target.value)}>
                <option value="">Todo</option>
                {cats.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </div>

            <div className="scroll-container p-4 pb-24 md:pb-4">
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {filtered.map(p => {
                  const hasVars = p.variants?.length > 0;
                  const stock = hasVars ? p.variants.reduce((a, b) => a + Number(b.stock), 0) : p.stock;
                  const price = hasVars ? p.variants[0].price : p.price;
                  const noStock = stock <= 0;
                  
                  return (
                    <div key={p.id} onClick={() => !noStock && (hasVars ? setSelectedProd(p) : addToCart(p))}
                      className={`bg-white rounded-2xl p-3 shadow-sm border h-56 flex flex-col relative overflow-hidden active:scale-95 transition-transform ${noStock ? 'opacity-70 grayscale' : ''}`}>
                      {noStock && <div className="absolute inset-0 z-10 bg-white/60 flex items-center justify-center"><span className="bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full -rotate-12">AGOTADO</span></div>}
                      <div className="h-28 bg-gray-50 rounded-xl mb-3 overflow-hidden flex items-center justify-center">
                        {p.image ? <img src={p.image} className="w-full h-full object-cover" /> : <Icon name="package" size={32} className="text-gray-300" />}
                      </div>
                      <div className="flex-1 flex flex-col justify-between">
                        <p className="text-sm font-bold text-gray-700 line-clamp-2">{p.name}</p>
                        <div className="flex justify-between items-end">
                          <span className="text-lg font-black text-indigo-600">C${Number(price).toFixed(2)}</span>
                          {hasVars && <span className="text-[10px] bg-gray-800 text-white px-1.5 rounded">VAR</span>}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* BotÃ³n Flotante (MÃ³vil) */}
          <button onClick={() => setShowMobileCart(true)} className="md:hidden fixed bottom-24 right-4 bg-indigo-600 text-white p-4 rounded-full shadow-xl z-30 active:scale-90">
            <Icon name="shopping-cart" size={24} />
            {cart.length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full">{cart.reduce((a, b) => a + b.qty, 0)}</span>}
          </button>

          {/* Sidebar Carrito */}
          <div className={`fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl z-40 transform transition-transform duration-300 flex flex-col h-full ${showMobileCart ? 'translate-x-0' : 'translate-x-full md:translate-x-0 md:static md:shadow-none md:border-l'}`}>
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
              <h2 className="font-bold text-gray-800 flex items-center gap-2"><Icon name="shopping-cart" className="text-indigo-600" /> Carrito ({cart.reduce((a,b)=>a+b.qty,0)})</h2>
              <div className="flex gap-2">
                 <button onClick={() => setCart([])} className="text-red-500 text-xs font-bold uppercase hover:underline">Limpiar</button>
                 <button onClick={() => setShowMobileCart(false)} className="md:hidden"><Icon name="x"/></button>
              </div>
            </div>

            <div className="scroll-container p-3 space-y-2 bg-white">
              {cart.length === 0 ? <div className="h-40 flex flex-col items-center justify-center text-gray-300"><Icon name="shopping-bag" size={48} /><p>VacÃ­o</p></div> : 
               cart.map(item => (
                <div key={item.cartId} className="flex justify-between items-center bg-gray-50 p-2 rounded-xl border">
                  <div className="flex-1 pr-2 overflow-hidden">
                    <p className="text-xs font-bold truncate">{item.name}</p>
                    <p className="text-[10px] text-gray-500">{item.variantName || 'Simple'} | C${item.price.toFixed(2)}</p>
                  </div>
                  <div className="flex items-center bg-white rounded-lg border h-8">
                    <button onClick={() => updateQty(item.cartId, -1)} className="px-2 font-bold text-gray-500">-</button>
                    <span className="px-1 text-xs font-bold">{item.qty}</span>
                    <button onClick={() => updateQty(item.cartId, 1)} className="px-2 font-bold text-indigo-600">+</button>
                  </div>
                  <span className="text-xs font-bold w-16 text-right">C${(item.price * item.qty).toFixed(2)}</span>
                </div>
              ))}
            </div>

            {/* Footer Carrito: Descuentos, IVA y Total */}
            <div className="p-4 bg-gray-50 border-t shrink-0 pb-safe">
               <div className="space-y-2 mb-3">
                  <div className="flex gap-2 items-center">
                     <div className="flex-1 relative">
                        <span className="absolute left-2 top-2 text-xs text-gray-400">Desc %</span>
                        <input type="number" min="0" max="100" className="w-full pl-14 pr-2 py-1.5 rounded-lg border text-sm font-bold outline-none" 
                           value={discountPercent} onChange={e => setDiscountPercent(Math.min(100, Math.max(0, e.target.value)))} />
                     </div>
                     <button onClick={() => setTaxEnabled(!taxEnabled)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors ${taxEnabled ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-white text-gray-400'}`}>
                        {taxEnabled ? 'IVA ON' : 'IVA OFF'}
                     </button>
                  </div>
                  
                  <div className="flex justify-between text-xs text-gray-500"><span>Subtotal</span><span>C${subtotal.toFixed(2)}</span></div>
                  {discountPercent > 0 && <div className="flex justify-between text-xs text-green-600"><span>Desc ({discountPercent}%)</span><span>-C${discountAmount.toFixed(2)}</span></div>}
                  <div className="flex justify-between text-xs text-indigo-600"><span>IVA (15%)</span><span>C${taxAmount.toFixed(2)}</span></div>
                  <div className="flex justify-between text-xl font-black text-gray-900 border-t pt-2"><span>Total</span><span>C${total.toFixed(2)}</span></div>
               </div>
               
               {/* BOTÃ“N COBRAR (VISIBLE SIEMPRE) */}
               <button onClick={() => setShowCheckout(true)} disabled={cart.length === 0} className="btn-action w-full">
                 COBRAR <Icon name="arrow-right" size={20} />
               </button>
            </div>
          </div>

          {/* Modal Variantes */}
          {selectedProd && (
            <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
              <div className="bg-white w-full max-w-sm rounded-2xl p-4 animate-fade">
                <div className="flex justify-between mb-4"><h3 className="font-bold">{selectedProd.name}</h3><button onClick={() => setSelectedProd(null)}><Icon name="x"/></button></div>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {selectedProd.variants.map((v, i) => (
                    <button key={i} onClick={() => { addToCart(selectedProd, v); setSelectedProd(null); }} className="w-full flex justify-between p-3 border rounded-lg hover:bg-indigo-50">
                      <div className="text-left"><p className="font-bold text-sm">{v.name}</p><p className="text-xs text-gray-500">Stock: {v.stock}</p></div>
                      <span className="font-bold text-indigo-600">C${Number(v.price).toFixed(2)}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Checkout Overlay */}
          {showCheckout && (
            <CheckoutOverlay 
              cart={cart} totals={{ subtotal, discountAmount, discountPercent, taxAmount, taxEnabled, total }}
              user={user} shift={shift} 
              onClose={() => setShowCheckout(false)} 
              onSuccess={() => { setCart([]); setShowCheckout(false); setShowMobileCart(false); setDiscountPercent(0); }} 
            />
          )}
        </div>
      );
    };

    // ==========================================
    // 6. CHECKOUT COMPLETO
    // ==========================================
    const CheckoutOverlay = ({ cart, totals, user, shift, onClose, onSuccess }) => {
      const [client, setClient] = useState("");
      const [phone, setPhone] = useState("");
      const [method, setMethod] = useState("Efectivo");
      const [isDel, setIsDel] = useState(false);
      const [addr, setAddr] = useState("");
      const [ship, setShip] = useState(0);
      const [paid, setPaid] = useState("");
      const [processing, setProcessing] = useState(false);

      const finalTotal = totals.total + (isDel ? Number(ship) : 0);
      const change = Number(paid) - finalTotal;

      const handleConfirm = async () => {
        setProcessing(true);
        try {
          // ID Secuencial
          const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const ref = getCollectionRef('counters').doc('orders_' + dateStr);
          let seq = 1;
          await db.runTransaction(async t => {
            const doc = await t.get(ref);
            if(doc.exists) { seq = doc.data().val + 1; t.update(ref, { val: seq }); }
            else t.set(ref, { val: 1 });
          });
          const oid = `HM-${dateStr}-${String(seq).padStart(3, '0')}`;

          const order = {
            displayId: oid, createdAt: new Date().toISOString(), cart,
            client, phone, method, isDelivery: isDel, address: addr, shipCost: Number(ship),
            subtotal: totals.subtotal, discountAmount: totals.discountAmount, 
            tax: totals.taxAmount, taxRate: totals.taxEnabled ? 0.15 : 0, 
            total: finalTotal,
            status: 'recibido', paymentStatus: (method==='Efectivo' && Number(paid)>=finalTotal) ? 'pagado' : 'pendiente',
            seller: user.email, shiftId: shift.id, paidAmount: Number(paid), change: method==='Efectivo' ? change : 0
          };

          await getCollectionRef('orders').doc(oid).set(order);

          // Actualizar Stock (Optimista simple)
          cart.forEach(async i => {
             const pref = getCollectionRef('products').doc(i.id);
             if(!i.isVariant) await pref.update({ stock: firebase.firestore.FieldValue.increment(-i.qty) });
             else {
                // ActualizaciÃ³n para variantes requerirÃ­a lectura previa, simplificado aquÃ­
                await db.runTransaction(async t => {
                   const d = await t.get(pref);
                   if(!d.exists) return;
                   const nv = d.data().variants.map(v => v.name===i.variantName ? {...v, stock: Math.max(0,Number(v.stock)-i.qty)} : v);
                   t.update(pref, { variants: nv });
                });
             }
          });

          // WhatsApp
          const link = `${window.location.origin}${window.location.pathname}?track=${oid}`;
          const msg = `ðŸ‘‹ Hola *${client}*, pedido *${oid}* confirmado.\nðŸ’° Total: C$${finalTotal.toFixed(2)}\nðŸ“¦ Items: ${cart.length}\nðŸ”— Rastreo: ${link}`;
          if(phone) window.open(`https://wa.me/505${phone.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');

          Swal.fire("Ã‰xito", `Orden ${oid} creada`, "success");
          onSuccess();
        } catch(e) { Swal.fire("Error", "No se procesÃ³ la venta", "error"); }
        setProcessing(false);
      };

      return (
        <div className="fixed inset-0 z-50 bg-white md:bg-black/50 md:flex md:items-center md:justify-center animate-fade">
          <div className="bg-white w-full h-full md:h-auto md:max-w-md md:rounded-2xl flex flex-col overflow-hidden shadow-2xl">
            <div className="bg-gray-900 text-white p-4 flex justify-between shrink-0"><h3 className="font-bold flex gap-2"><Icon name="wallet"/> Checkout</h3><button onClick={onClose}><Icon name="x"/></button></div>
            <div className="scroll-container p-5 space-y-4 bg-gray-50">
              <div className="bg-white p-4 rounded-xl border space-y-3">
                 <p className="text-xs font-bold text-gray-400 uppercase">Cliente</p>
                 <input className="input-field" placeholder="Nombre" value={client} onChange={e=>setClient(e.target.value)} />
                 <div className="grid grid-cols-2 gap-2">
                    <input className="input-field" type="tel" placeholder="WhatsApp" value={phone} onChange={e=>setPhone(e.target.value)} />
                    <select className="input-field" value={method} onChange={e=>setMethod(e.target.value)}><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select>
                 </div>
              </div>
              <div className={`p-4 rounded-xl border ${isDel?'bg-indigo-50 border-indigo-200':'bg-white'}`}>
                 <div className="flex justify-between"><span className="font-bold text-sm text-indigo-900 flex gap-2"><Icon name="bike" size={18}/> Delivery</span><input type="checkbox" className="w-5 h-5 accent-indigo-600" checked={isDel} onChange={e=>setIsDel(e.target.checked)}/></div>
                 {isDel && <div className="mt-3 space-y-2"><input className="input-field" placeholder="DirecciÃ³n" value={addr} onChange={e=>setAddr(e.target.value)} /><div className="flex justify-between bg-white p-2 rounded border"><span className="text-xs font-bold pl-2 pt-1">Costo EnvÃ­o:</span><div className="flex"><span className="text-gray-400 text-xs pt-1">C$</span><input type="number" className="w-20 text-right font-bold outline-none" value={ship} onChange={e=>setShip(e.target.value)}/></div></div></div>}
              </div>
              <div className="bg-white p-4 rounded-xl border">
                 {method==='Efectivo' && <div className="mb-3 flex gap-3"><div className="relative flex-1"><span className="absolute left-3 top-2.5 font-bold text-gray-400">C$</span><input type="number" className="input-field pl-9 font-bold text-lg" placeholder="Recibido" value={paid} onChange={e=>setPaid(e.target.value)}/></div><div className="text-right"><span className="text-[10px] font-bold text-gray-400 uppercase">Cambio</span><div className={`text-xl font-black ${change<0?'text-red-400':'text-green-500'}`}>C${change.toFixed(2)}</div></div></div>}
                 <div className="pt-2 border-t space-y-1 text-sm">
                    <div className="flex justify-between text-gray-500"><span>Subtotal (Neto)</span><span>C${totals.taxableBase ? totals.taxableBase.toFixed(2) : (totals.subtotal - totals.discountAmount).toFixed(2)}</span></div>
                    {totals.taxEnabled && <div className="flex justify-between text-indigo-600"><span>IVA 15%</span><span>C${totals.taxAmount.toFixed(2)}</span></div>}
                    {isDel && <div className="flex justify-between text-indigo-600"><span>EnvÃ­o</span><span>C${Number(ship).toFixed(2)}</span></div>}
                    <div className="flex justify-between text-2xl font-black text-gray-800 pt-2 border-t mt-2"><span>Total</span><span>C${finalTotal.toFixed(2)}</span></div>
                 </div>
              </div>
            </div>
            <div className="p-4 bg-white border-t shrink-0 pb-safe">
               <button onClick={handleConfirm} disabled={processing || !client || !phone || (method==='Efectivo' && change < -0.5)} className="btn-action w-full">{processing ? 'Procesando...' : 'CONFIRMAR PEDIDO'}</button>
            </div>
          </div>
        </div>
      );
    };

    // ==========================================
    // 7. MÃ“DULO Ã“RDENES (HISTORIAL)
    // ==========================================
    const OrdersModule = ({ user }) => {
      const [orders, setOrders] = useState([]);
      const [viewId, setViewId] = useState(null);
      const sel = orders.find(o => o.id === viewId);

      useEffect(() => {
        const unsub = getCollectionRef('orders').orderBy('createdAt', 'desc').limit(50).onSnapshot(s => setOrders(s.docs.map(d => ({ id: d.id, ...d.data() }))));
        return unsub;
      }, []);

      const updateOrder = async (field, val) => {
        if(viewId) { await getCollectionRef('orders').doc(viewId).update({[field]:val}); Swal.fire({toast:true, title:"Actualizado", icon:"success", timer:1000, position:'top', showConfirmButton:false}); }
      };

      const sendWA = () => {
         const link = `${window.location.origin}${window.location.pathname}?track=${sel.displayId}`;
         const msg = `ðŸ‘‹ Hola *${sel.client}*, pedido *${sel.displayId}*.\nEstado: *${sel.status.toUpperCase()}*\nPago: *${sel.paymentStatus.toUpperCase()}*\nRastreo: ${link}`;
         window.open(`https://wa.me/505${sel.phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`);
      };

      return (
        <div className="flex flex-col h-full bg-gray-50 relative">
          <div className="p-4 bg-white border-b shrink-0"><h2 className="text-xl font-bold">Historial</h2></div>
          <div className="scroll-container p-4 space-y-3 pb-24">
             {orders.map(o => (
               <div key={o.id} onClick={() => setViewId(o.id)} className="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center active:scale-95 transition-transform">
                  <div>
                     <div className="flex gap-2 items-center mb-1"><span className="bg-indigo-50 text-indigo-700 text-xs font-bold px-1.5 rounded">{o.displayId}</span><span className={`text-[10px] font-bold px-1.5 rounded border ${o.paymentStatus==='pagado'?'bg-green-50 text-green-700 border-green-200':'bg-red-50 text-red-600 border-red-200'}`}>{o.paymentStatus}</span></div>
                     <p className="font-bold text-sm">{o.client}</p>
                     <span className="text-[10px] uppercase bg-gray-100 text-gray-500 px-1 rounded">{o.status}</span>
                  </div>
                  <div className="text-right"><span className="block font-black text-lg">C${o.total.toFixed(2)}</span><Icon name="chevron-right" className="text-gray-300 ml-auto"/></div>
               </div>
             ))}
          </div>

          {sel && (
             <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white w-full max-w-md rounded-2xl flex flex-col max-h-[90vh] overflow-hidden shadow-2xl">
                   <div className="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                      <div><h3 className="font-bold text-lg">{sel.displayId}</h3><p className="text-xs text-gray-500">{new Date(sel.createdAt).toLocaleString()}</p></div>
                      <button onClick={() => setViewId(null)}><Icon name="x"/></button>
                   </div>
                   <div className="scroll-container p-5 bg-white">
                      <div className="grid grid-cols-2 gap-4 mb-4">
                         <div><label className="text-[10px] font-bold text-gray-400">Estado</label><select className="w-full border rounded p-2 text-xs font-bold mt-1" value={sel.status} onChange={e=>updateOrder('status',e.target.value)}><option value="recibido">Recibido</option><option value="proceso">Proceso</option><option value="ruta">Ruta</option><option value="entregado">Entregado</option><option value="cancelado">Cancelado</option></select></div>
                         <div><label className="text-[10px] font-bold text-gray-400">Pago</label><select className="w-full border rounded p-2 text-xs font-bold mt-1" value={sel.paymentStatus} onChange={e=>updateOrder('paymentStatus',e.target.value)}><option value="pendiente">Pendiente</option><option value="pagado">Pagado</option></select></div>
                      </div>
                      <div className="space-y-2 border-t pt-4">
                         {sel.cart.map((i,k)=><div key={k} className="flex justify-between text-sm"><span>{i.qty}x {i.name}</span><span className="font-bold">C${(i.price*i.qty).toFixed(2)}</span></div>)}
                      </div>
                      <div className="bg-gray-50 p-3 rounded-lg mt-4 text-sm space-y-1">
                         {sel.discountAmount>0 && <div className="flex justify-between text-green-600"><span>Desc</span><span>-C${sel.discountAmount.toFixed(2)}</span></div>}
                         <div className="flex justify-between"><span>IVA</span><span>C${(sel.tax||0).toFixed(2)}</span></div>
                         <div className="flex justify-between font-black text-lg border-t pt-1"><span>Total</span><span>C${sel.total.toFixed(2)}</span></div>
                      </div>
                      <div className="mt-6 flex gap-2">
                         <button onClick={sendWA} className="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold flex justify-center gap-2"><Icon name="message-circle"/> WhatsApp</button>
                         <button onClick={()=>{navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}?track=${sel.displayId}`);Swal.fire({toast:true,title:"Link Copiado",icon:"success",timer:1000,position:'top',showConfirmButton:false})}} className="bg-gray-100 px-4 rounded-xl"><Icon name="link"/></button>
                      </div>
                   </div>
                </div>
             </div>
          )}
        </div>
      );
    };

    // ==========================================
    // 8. MÃ“DULO INVENTARIO
    // ==========================================
    const InventoryModule = ({ products }) => {
       const [modal, setModal] = useState(false);
       const [edit, setEdit] = useState(null);
       const [form, setForm] = useState({ name:'', cat:'', img:'', price:'', stock:'', hasVars:false });
       const [vars, setVars] = useState([]);

       const open = (p) => {
          if(p) { setEdit(p); setForm({name:p.name, cat:p.category, img:p.image||'', price:p.price, stock:p.stock, hasVars:!!p.variants?.length}); setVars(p.variants||[]); } 
          else { setEdit(null); setForm({name:'', cat:'', img:'', price:'', stock:'', hasVars:false}); setVars([]); }
          setModal(true);
       };

       const save = async (e) => {
          e.preventDefault();
          const d = { name:form.name, category:form.cat, image:form.img, price:form.hasVars?0:Number(form.price), stock:form.hasVars?0:Number(form.stock), variants:form.hasVars?vars.map(v=>({name:v.name, price:Number(v.price), stock:Number(v.stock)})):[] };
          if(edit) await getCollectionRef('products').doc(edit.id).update(d); else await getCollectionRef('products').add(d);
          setModal(false); Swal.fire({toast:true, title:"Guardado", icon:"success", timer:1500, position:'top-end', showConfirmButton:false});
       };

       return (
          <div className="flex flex-col h-full bg-gray-50 relative">
             <div className="p-4 bg-white border-b flex justify-between shrink-0"><h2 className="text-xl font-bold">Inventario</h2><button onClick={() => open()} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold">+ Nuevo</button></div>
             <div className="scroll-container p-4 space-y-2 pb-24">
                {products.map(p => (
                   <div key={p.id} onClick={() => open(p)} className="bg-white p-3 rounded-xl border shadow-sm flex justify-between items-center cursor-pointer">
                      <div className="flex gap-3 items-center"><div className="w-10 h-10 bg-gray-100 rounded overflow-hidden">{p.image?<img src={p.image} className="w-full h-full object-cover"/>:<Icon name="box" className="text-gray-400 m-2"/>}</div><div><p className="font-bold text-sm">{p.name}</p><p className="text-xs text-gray-500">{p.variants?.length>0?p.variants.length+' Var.':'Simple'} | Stock: {p.variants?.length?p.variants.reduce((a,b)=>a+Number(b.stock),0):p.stock}</p></div></div><Icon name="edit-3" size={16} className="text-gray-300"/>
                   </div>
                ))}
             </div>
             {modal && (
                <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                   <div className="bg-white w-full max-w-lg rounded-xl flex flex-col max-h-[90vh] overflow-hidden">
                      <div className="p-4 border-b flex justify-between"><h3 className="font-bold">{edit?'Editar':'Nuevo'}</h3><button onClick={() => setModal(false)}><Icon name="x"/></button></div>
                      <form onSubmit={save} className="scroll-container p-5 space-y-3 bg-gray-50">
                         <input className="input-field" placeholder="Nombre" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required/>
                         <div className="grid grid-cols-2 gap-3"><input className="input-field" placeholder="CategorÃ­a" list="cats" value={form.cat} onChange={e=>setForm({...form,cat:e.target.value})}/><datalist id="cats"><option value="Ropa"/><option value="TecnologÃ­a"/></datalist><input className="input-field" placeholder="URL Imagen" value={form.img} onChange={e=>setForm({...form,img:e.target.value})}/></div>
                         <div className="bg-indigo-50 p-3 rounded border border-indigo-100 flex gap-2 items-center"><input type="checkbox" className="w-5 h-5 accent-indigo-600" checked={form.hasVars} onChange={e=>setForm({...form,hasVars:e.target.checked})}/><label className="font-bold text-indigo-900 text-sm">Variantes</label></div>
                         {!form.hasVars ? <div className="grid grid-cols-2 gap-3"><div><label className="text-xs font-bold text-gray-400">Precio</label><input type="number" step="0.01" className="input-field font-bold" value={form.price} onChange={e=>setForm({...form,price:e.target.value})}/></div><div><label className="text-xs font-bold text-gray-400">Stock</label><input type="number" className="input-field font-bold" value={form.stock} onChange={e=>setForm({...form,stock:e.target.value})}/></div></div> 
                         : <div className="space-y-2">{vars.map((v,i)=><div key={i} className="flex gap-2"><input className="input-field py-2 text-xs" placeholder="Nom" value={v.name} onChange={e=>{const n=[...vars];n[i].name=e.target.value;setVars(n)}}/><input type="number" className="input-field py-2 text-xs w-20" placeholder="$" value={v.price} onChange={e=>{const n=[...vars];n[i].price=e.target.value;setVars(n)}}/><input type="number" className="input-field py-2 text-xs w-16" placeholder="#" value={v.stock} onChange={e=>{const n=[...vars];n[i].stock=e.target.value;setVars(n)}}/><button type="button" onClick={()=>setVars(vars.filter((_,x)=>x!==i))} className="text-red-400"><Icon name="trash-2" size={16}/></button></div>)}<button type="button" onClick={()=>setVars([...vars,{name:'',price:'',stock:''}])} className="w-full py-2 border-2 border-dashed border-indigo-300 text-indigo-600 rounded text-xs font-bold">+ Variante</button></div>}
                         <button className="btn-action w-full mt-4">Guardar</button>
                      </form>
                   </div>
                </div>
             )}
          </div>
       );
    };

    // ==========================================
    // 9. MÃ“DULO ADMIN (CAJA + REPORTES)
    // ==========================================
    const AdminModule = ({ user, shift, updateShift }) => {
      const [tab, setTab] = useState('shift'); // 'shift' | 'reports'
      const [startAmount, setStartAmount] = useState("");
      
      // Estados para Reportes
      const [rStart, setRStart] = useState(new Date().toISOString().slice(0, 10));
      const [rEnd, setREnd] = useState(new Date().toISOString().slice(0, 10));

      const handleOpenShift = async () => {
        if (!startAmount) return;
        await getCollectionRef('shifts').add({ userId: user.uid, startAmount: parseFloat(startAmount), openedAt: firebase.firestore.FieldValue.serverTimestamp(), status: 'open' });
        updateShift();
      };

      const handleCloseShift = async () => {
         if((await Swal.fire({title:'Â¿Cerrar?', showCancelButton:true})).isConfirmed) {
            await getCollectionRef('shifts').doc(shift.id).update({ status: 'closed', closedAt: firebase.firestore.FieldValue.serverTimestamp() });
            updateShift();
         }
      };

      // FunciÃ³n de ExportaciÃ³n de Reportes
      const generateReport = async (type) => {
         const d1 = new Date(rStart); const d2 = new Date(rEnd); d2.setHours(23,59,59);
         const snap = await getCollectionRef('orders').where('createdAt', '>=', d1.toISOString()).where('createdAt', '<=', d2.toISOString()).get();
         const data = snap.docs.map(d => { const x=d.data(); return [x.displayId, new Date(x.createdAt).toLocaleDateString(), x.client, x.method, x.total.toFixed(2)]; });
         
         if(data.length === 0) return Swal.fire("Sin datos", "No hay ventas en este rango", "info");

         if(type === 'pdf') {
            const doc = new window.jspdf.jsPDF();
            doc.text(`Reporte de Ventas: ${rStart} a ${rEnd}`, 14, 20);
            doc.autoTable({ head: [['ID', 'Fecha', 'Cliente', 'MÃ©todo', 'Total']], body: data, startY: 30 });
            doc.save('reporte_ventas.pdf');
         } else {
            const ws = XLSX.utils.aoa_to_sheet([['ID', 'Fecha', 'Cliente', 'MÃ©todo', 'Total'], ...data]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Ventas");
            XLSX.writeFile(wb, "reporte_ventas.xlsx");
         }
      };

      return (
        <div className="flex flex-col h-full bg-gray-50 relative">
          <div className="p-4 bg-white border-b flex justify-between shrink-0">
             <div className="flex space-x-2 bg-gray-100 p-1 rounded-lg">
               <button onClick={()=>setTab('shift')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${tab==='shift'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>Caja</button>
               <button onClick={()=>setTab('reports')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${tab==='reports'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>Reportes</button>
             </div>
          </div>

          <div className="scroll-container p-6 flex flex-col items-center">
             {tab === 'shift' ? (
                <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center border border-gray-100">
                  <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 ${shift ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}`}><Icon name={shift ? 'unlock' : 'lock'} size={32} /></div>
                  <h2 className="text-xl font-bold mb-4">{shift ? 'Turno Abierto' : 'Caja Cerrada'}</h2>
                  {shift ? (
                    <div className="space-y-4">
                       <p className="text-gray-500">Fondo: <b>C${shift.startAmount}</b></p>
                       <button onClick={handleCloseShift} className="w-full bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-red-200">Cerrar Turno</button>
                    </div>
                  ) : (
                    <div className="space-y-4">
                       <input type="number" className="input-field text-center text-xl font-bold" placeholder="Monto Inicial" value={startAmount} onChange={e => setStartAmount(e.target.value)} />
                       <button onClick={handleOpenShift} disabled={!startAmount} className="btn-action">Abrir Turno</button>
                    </div>
                  )}
                </div>
             ) : (
                <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm border border-gray-100 space-y-4">
                   <h3 className="font-bold text-gray-800 flex gap-2 items-center"><Icon name="file-text" size={20}/> Exportar Ventas</h3>
                   <div><label className="text-xs font-bold text-gray-400">Desde</label><input type="date" className="input-field" value={rStart} onChange={e=>setRStart(e.target.value)}/></div>
                   <div><label className="text-xs font-bold text-gray-400">Hasta</label><input type="date" className="input-field" value={rEnd} onChange={e=>setREnd(e.target.value)}/></div>
                   <div className="flex gap-2 pt-2">
                      <button onClick={()=>generateReport('pdf')} className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold flex justify-center gap-2"><Icon name="file"/> PDF</button>
                      <button onClick={()=>generateReport('excel')} className="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold flex justify-center gap-2"><Icon name="sheet"/> Excel</button>
                   </div>
                </div>
             )}
          </div>
        </div>
      );
    };

    // ==========================================
    // 10. APP PRINCIPAL
    // ==========================================
    const App = () => {
      const [user, setUser] = useState(null);
      const [view, setView] = useState('pos');
      const [products, setProducts] = useState([]);
      const [shift, setShift] = useState(null);
      const [loading, setLoading] = useState(true);
      
      const trackId = new URLSearchParams(window.location.search).get('track');

      useEffect(() => {
        auth.onAuthStateChanged(async u => {
           if (trackId && !u) await auth.signInAnonymously();
           setUser(u);
           if (u && !trackId) {
              getCollectionRef('products').onSnapshot(s => setProducts(s.docs.map(d => ({ id: d.id, ...d.data() }))));
              checkShift(u.uid);
           }
           setLoading(false);
        });
      }, []);

      const checkShift = async (uid) => {
         const s = await getCollectionRef('shifts').where('status', '==', 'open').where('userId', '==', uid).limit(1).get();
         setShift(s.empty ? null : { id: s.docs[0].id, ...s.docs[0].data() });
      };

      if (loading) return <div className="h-full flex items-center justify-center bg-gray-100"><div className="w-12 h-12 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div></div>;
      if (trackId) return <div className="fixed inset-0 bg-white"><TrackingView trackId={trackId} /></div>;
      if (!user || (user.isAnonymous && !trackId)) return <LoginScreen />;

      return (
        <div className="flex flex-col md:flex-row h-full w-full bg-gray-100 overflow-hidden">
          {/* Sidebar PC */}
          <aside className="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 h-full">
            <div className="p-6 border-b border-gray-100"><h1 className="text-xl font-black text-indigo-600 flex items-center gap-2"><Icon name="store" /> Homemart</h1><p className="text-xs text-gray-400 mt-1 truncate">{user.email}</p></div>
            <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
              {[
                { id: 'pos', label: 'Punto de Venta', icon: 'shopping-cart' },
                { id: 'orders', label: 'Historial', icon: 'list' },
                { id: 'inv', label: 'Inventario', icon: 'package' },
                { id: 'admin', label: 'Admin', icon: 'settings' }
              ].map(i => (
                <button key={i.id} onClick={() => setView(i.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all ${view === i.id ? 'bg-indigo-50 text-indigo-600' : 'text-gray-500 hover:bg-gray-50'}`}>
                  <Icon name={i.icon} size={20} /> {i.label}
                </button>
              ))}
            </nav>
            <div className="p-4 border-t border-gray-100"><button onClick={() => auth.signOut()} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-red-500 hover:bg-red-50"><Icon name="log-out" size={20} /> Salir</button></div>
          </aside>

          {/* Header MÃ³vil */}
          <div className="md:hidden flex items-center justify-between p-4 bg-white border-b border-gray-200 shrink-0">
             <span className="font-black text-indigo-600 flex items-center gap-2"><Icon name="store" size={20}/> Homemart</span>
             <button onClick={() => auth.signOut()} className="text-gray-400"><Icon name="log-out" size={20}/></button>
          </div>

          <main className="flex-1 relative bg-gray-100 h-full overflow-hidden flex flex-col">
            <div className="flex-1 relative overflow-hidden">
              {view === 'pos' && <POSModule products={products} user={user} shift={shift} />}
              {view === 'orders' && <OrdersModule user={user} />}
              {view === 'inv' && <InventoryModule products={products} />}
              {view === 'admin' && <AdminModule user={user} shift={shift} updateShift={() => checkShift(user.uid)} />}
            </div>
          </main>

          {/* Nav MÃ³vil */}
          <nav className="md:hidden bg-white border-t border-gray-200 flex justify-around py-2 pb-safe shrink-0 z-50">
            {[{ id: 'pos', label: 'Venta', icon: 'shopping-cart' }, { id: 'orders', label: 'Orden', icon: 'list' }, { id: 'inv', label: 'Inv', icon: 'package' }, { id: 'admin', label: 'Admin', icon: 'settings' }].map(i => (
              <button key={i.id} onClick={() => setView(i.id)} className={`flex flex-col items-center p-2 rounded-lg ${view === i.id ? 'text-indigo-600' : 'text-gray-400'}`}><Icon name={i.icon} size={24} className="mb-0.5" /><span className="text-[10px] font-bold">{i.label}</span></button>
            ))}
          </nav>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>


