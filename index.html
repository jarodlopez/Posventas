<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Sistema de Ventas (Nicaragua)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

        @media print {
            body > *:not(#invoice-view) { display: none !important; }
            #invoice-view {
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: white; display: block !important; overflow: visible;
                padding: 0; margin: 0; z-index: 9999;
            }
            #printable-area { box-shadow: none; max-width: 100%; width: 100%; margin: 0; padding: 20px; }
            .print\:hidden { display: none !important; }
        }

        /* Animación de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans overflow-hidden">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2"></div>

    <!-- 0. PANTALLA DE CARGA / ERROR DE CONFIGURACIÓN -->
    <div id="loading-screen" class="fixed inset-0 z-[60] bg-gray-100 flex flex-col items-center justify-center p-4 text-center">
        <div id="loader-spinner" class="loader mb-4"></div>
        <h2 id="loading-title" class="text-xl font-semibold text-gray-700">Iniciando Sistema...</h2>
        <div id="config-error-area" class="hidden max-w-lg w-full bg-white p-6 rounded-xl shadow-xl mt-4">
            <div class="text-red-500 mb-4 flex flex-col items-center">
                <i data-lucide="alert-triangle" class="w-12 h-12 mb-2"></i>
                <h3 class="text-lg font-bold">Falta Configuración de Firebase</h3>
            </div>
            <p class="text-gray-600 text-sm mb-4">
                El sistema no detectó las llaves de Firebase. Por favor, pega tu configuración JSON aquí para continuar:
            </p>
            <textarea id="manual-config-input" class="w-full h-32 border p-2 rounded text-xs font-mono bg-gray-50 mb-4" placeholder='{ "apiKey": "...", "authDomain": "...", ... }'></textarea>
            <button onclick="saveManualConfig()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700">
                Guardar y Conectar
            </button>
        </div>
    </div>

    <!-- 1. PANTALLA DE LOGIN -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center mb-2 text-indigo-600">POS Login</h2>
            <p class="text-center text-gray-500 mb-6 text-sm">Sistema de Ventas (Nicaragua)</p>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500" placeholder="usuario@negocio.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="login-pass" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500" placeholder="******" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-lg">Ingresar</button>
            </form>

            <form id="register-form" class="space-y-4 hidden">
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200 text-xs text-yellow-800 mb-2">
                    ¡Crea una cuenta para guardar tus productos permanentemente!
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="reg-email" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Contraseña (Mín. 6)</label>
                    <input type="password" id="reg-pass" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-150">Crear Cuenta</button>
                <button type="button" id="cancel-reg-btn" class="w-full mt-2 text-sm text-gray-500 hover:text-gray-700">Cancelar</button>
            </form>

            <div class="mt-6 flex flex-col items-center space-y-3">
                <button id="show-register-btn" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150 font-medium">¿No tienes cuenta? Regístrate aquí</button>
            </div>
            
            <div id="auth-error-msg" class="mt-4 text-center bg-red-100 text-red-600 p-2 rounded text-sm hidden"></div>
        </div>
    </div>

    <!-- 2. APLICACIÓN PRINCIPAL -->
    <div id="app-screen" class="h-screen flex flex-col hidden">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
            <h1 class="text-2xl font-bold text-indigo-700 flex items-center gap-2">
                <i data-lucide="monitor-check" class="w-6 h-6"></i> POS Simple <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full ml-2">NI</span>
            </h1>
            <div class="flex items-center space-x-2 md:space-x-4">
                <button onclick="toggleTab('products-view')" class="p-2 rounded-full text-gray-600 hover:bg-gray-100 transition duration-150" title="Productos">
                    <i data-lucide="layout-grid" class="w-6 h-6"></i>
                </button>
                <button onclick="toggleTab('inventory-view')" class="p-2 rounded-full text-gray-600 hover:bg-gray-100 transition duration-150" title="Inventario">
                    <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                </button>
                <button onclick="toggleTab('orders-view')" class="p-2 rounded-full text-gray-600 hover:bg-gray-100 transition duration-150" title="Órdenes">
                    <i data-lucide="history" class="w-6 h-6"></i>
                </button>
                <div class="h-6 w-px bg-gray-300 mx-2"></div>
                <span id="user-info" class="text-sm text-gray-600 hidden md:inline-block"></span>
                <button id="logout-btn" class="flex items-center space-x-1 bg-red-50 text-red-600 px-3 py-1 rounded-lg hover:bg-red-100 transition duration-150">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Salir</span>
                </button>
            </div>
        </header>

        <!-- Contenido principal -->
        <main class="flex-1 flex overflow-hidden relative">
            
            <!-- Columna 1: Productos -->
            <div id="products-view" class="flex-1 flex flex-col p-4 overflow-y-auto bg-white">
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                        <input id="search-input" type="text" placeholder="Buscar productos..." class="w-full border pl-9 p-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <select id="category-filter" class="border p-2 rounded-lg bg-white">
                        <option value="">Todas las categorías</option>
                    </select>
                    <button onclick="openProductModal()" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center space-x-1 whitespace-nowrap">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span class="hidden sm:inline">Nuevo</span>
                    </button>
                </div>
                
                <div id="product-grid" class="flex-1 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto pb-4 content-start">
                    <p class="text-center text-gray-500 col-span-full mt-10">Cargando productos...</p>
                </div>
            </div>

            <!-- Columna 2: Inventario -->
            <div id="inventory-view" class="flex-1 p-4 overflow-y-auto hidden bg-white">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Inventario y Precios</h2>
                <div class="bg-white shadow border rounded-xl overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio (C$)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Columna 3: Historial -->
            <div id="orders-view" class="flex-1 p-4 overflow-y-auto hidden bg-white">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Historial de Órdenes</h2>
                <div class="bg-white shadow border rounded-xl overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID / Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ver</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Columna Lateral: Carrito -->
            <div class="w-full md:w-80 lg:w-96 bg-gray-50 border-l flex flex-col absolute md:relative z-20 h-full transform transition-transform duration-300 translate-x-full md:translate-x-0" id="cart-sidebar">
                <div class="p-4 border-b bg-white shadow-sm flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="shopping-cart" class="w-5 h-5 text-indigo-600"></i> Carrito
                    </h2>
                    <span id="cart-count" class="bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                    <button class="md:hidden" onclick="toggleCartMobile()">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div id="cart-items" class="flex-1 overflow-y-auto p-3 space-y-3">
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 space-y-2">
                        <i data-lucide="shopping-basket" class="w-12 h-12 opacity-50"></i>
                        <p class="text-sm">Carrito vacío</p>
                    </div>
                </div>

                <div class="p-4 bg-white border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] space-y-3">
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between text-gray-600">
                            <span>Subtotal:</span>
                            <span id="cart-subtotal" class="font-medium">C$0.00</span>
                        </div>
                        <div class="flex justify-between text-gray-600">
                            <span>Impuestos (15%):</span>
                            <span id="cart-tax" class="font-medium">C$0.00</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-end border-t pt-2">
                        <span class="text-gray-800 font-bold">Total:</span>
                        <span id="cart-total" class="text-2xl font-extrabold text-indigo-700">C$0.00</span>
                    </div>

                    <div class="flex gap-2 pt-1">
                        <button onclick="clearCart()" class="p-3 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 transition" title="Vaciar">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                        <button id="checkout-btn" onclick="toggleModal('modal-checkout')" disabled class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-300 disabled:cursor-not-allowed shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
                            <span>Cobrar</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <button onclick="toggleCartMobile()" class="md:hidden fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-2xl z-30 hover:bg-indigo-700">
                <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                <span id="mobile-cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
            </button>
        </main>
    </div>

    <!-- 3. MODAL: Agregar/Editar Producto -->
    <div id="modal-product" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md m-4 transform transition-all">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 id="product-modal-title" class="text-xl font-bold text-gray-800">Producto</h2>
                <button onclick="toggleModal('modal-product')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <form id="product-form" class="space-y-3">
                <input type="hidden" id="product-id">
                
                <div>
                    <label class="text-xs font-semibold text-gray-500">Nombre</label>
                    <input required name="name" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-semibold text-gray-500">Precio Venta (C$)</label>
                        <input required type="number" step="0.01" name="price" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-gray-500">Costo (C$)</label>
                        <input required type="number" step="0.01" name="cost" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-semibold text-gray-500">Stock</label>
                        <input required type="number" name="stock" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-gray-500">Categoría</label>
                        <input required name="category" list="category-list" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <datalist id="category-list"></datalist>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-500">URL Imagen</label>
                    <input name="imageUrl" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
                
                <div class="flex gap-2 mt-6 pt-2">
                    <button type="submit" id="submit-product-btn" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100">Guardar</button>
                    <button type="button" id="delete-product-btn" onclick="deleteProduct()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-semibold hover:bg-red-100 hidden">
                        <i data-lucide="trash" class="w-5 h-5"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 4. MODAL: Checkout -->
    <div id="modal-checkout" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg m-4">
            <h2 class="text-2xl font-bold mb-4 text-indigo-700 border-b pb-2">Finalizar Venta</h2>
            
            <form id="checkout-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded-lg">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Descuento %</label>
                        <input type="number" id="checkout-discount-percent" value="0" min="0" max="100" class="w-full bg-white border p-2 rounded focus:ring-1 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Envío (C$)</label>
                        <input type="number" step="0.01" id="checkout-delivery" value="0.00" min="0" class="w-full bg-white border p-2 rounded focus:ring-1 focus:ring-indigo-500 outline-none">
                    </div>
                </div>

                <div class="flex justify-between items-center py-2">
                    <span class="text-gray-600 font-medium">Total a Pagar:</span>
                    <span id="checkout-total-display" class="text-2xl font-bold text-gray-800">C$0.00</span>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-indigo-700 mb-1">Efectivo Recibido (C$)</label>
                    <input type="number" step="0.01" id="checkout-paid" required class="w-full border-2 border-indigo-100 p-3 text-2xl font-bold rounded-lg text-indigo-700 focus:border-indigo-500 focus:outline-none">
                </div>

                <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                    <span class="font-bold text-gray-600">Cambio:</span>
                    <span id="checkout-change-display" class="text-xl font-bold text-gray-400">C$0.00</span>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="toggleModal('modal-checkout')" class="flex-1 bg-white border border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-50">Cancelar</button>
                    <button type="submit" id="confirm-checkout-btn" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg shadow-green-100 flex justify-center items-center gap-2">
                        <i data-lucide="check-circle" class="w-5 h-5"></i> Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 5. VISTA DE FACTURA -->
    <div id="invoice-view" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 hidden overflow-y-auto p-4">
        <div id="printable-area" class="bg-white shadow-2xl w-full max-w-md mx-auto my-8 p-8 relative print:shadow-none print:w-full">
            <div class="text-center border-b-2 border-dashed border-gray-200 pb-6 mb-6">
                <h3 class="text-2xl font-black text-gray-800 uppercase tracking-widest">Factura</h3>
                <p class="text-sm text-gray-500 mt-2 font-mono">ID: <span id="inv-order-id"></span></p>
                <p class="text-xs text-gray-400 mt-1" id="inv-date"></p>
            </div>

            <table class="w-full text-sm mb-6">
                <thead>
                    <tr class="text-gray-500 border-b border-gray-100">
                        <th class="py-2 text-left font-normal">Item</th>
                        <th class="py-2 text-center font-normal">Cant.</th>
                        <th class="py-2 text-right font-normal">Total</th>
                    </tr>
                </thead>
                <tbody id="inv-items-body" class="font-medium text-gray-700"></tbody>
            </table>

            <div class="space-y-2 text-right text-sm border-t-2 border-dashed border-gray-200 pt-4">
                <div class="flex justify-between text-gray-500">
                    <span>Subtotal:</span>
                    <span id="inv-subtotal">C$0.00</span>
                </div>
                <div class="flex justify-between text-gray-500">
                    <span>IVA (15%):</span>
                    <span id="inv-tax">C$0.00</span>
                </div>
                <div class="flex justify-between text-red-500 hidden" id="inv-row-disc">
                    <span>Descuento:</span>
                    <span id="inv-disc">-C$0.00</span>
                </div>
                 <div class="flex justify-between text-indigo-500 hidden" id="inv-row-del">
                    <span>Envío:</span>
                    <span id="inv-del">+C$0.00</span>
                </div>
                <div class="flex justify-between text-xl font-bold text-gray-900 mt-4 pt-2 border-t border-gray-100">
                    <span>TOTAL:</span>
                    <span id="inv-total">C$0.00</span>
                </div>
                <div class="flex justify-between text-gray-500 text-xs mt-1">
                    <span>Pago:</span>
                    <span id="inv-paid">C$0.00</span>
                </div>
                <div class="flex justify-between text-gray-500 text-xs">
                    <span>Cambio:</span>
                    <span id="inv-change">C$0.00</span>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <p class="text-xs text-gray-400">Atendido por: <span id="inv-user"></span></p>
                <p class="text-xs text-gray-400 mt-1">¡Gracias por su preferencia!</p>
            </div>
        </div>

        <!-- Botones de Acción Factura -->
        <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 print:hidden flex gap-4 bg-white p-2 rounded-full shadow-xl border border-gray-100">
            <button onclick="window.print()" class="p-3 bg-gray-100 rounded-full hover:bg-gray-200 text-gray-700 transition" title="Imprimir">
                <i data-lucide="printer" class="w-6 h-6"></i>
            </button>
            <button onclick="copyInvoiceLink()" class="p-3 bg-indigo-100 rounded-full hover:bg-indigo-200 text-indigo-700 transition" title="Copiar Enlace">
                <i data-lucide="link" class="w-6 h-6"></i>
            </button>
            <button onclick="closeInvoice()" class="p-3 bg-gray-800 rounded-full hover:bg-black text-white transition" title="Cerrar">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- 6. Scripts Unificados (Módulos ES6) -->
    <script type="module">
        // --------------------------------------------------------------------------------
        // 1. ZONA DE CONFIGURACIÓN MANUAL
        // --------------------------------------------------------------------------------
        // SI TIENES TUS LLAVES, PEGALAS AQUÍ DENTRO DE LAS COMILLAS
        const manualConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        // --------------------------------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove, get, query as dbQuery, limitToLast, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            signOut,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let app, db, auth;
        let userId = null;
        let userEmail = 'Anónimo';
        let appInitialized = false;
        
        // --- LÓGICA DE INICIALIZACIÓN ROBUSTA ---
        // Intenta cargar la config de 3 lugares:
        // 1. Variable del entorno (automático)
        // 2. Variable manualConfig (escrita en código)
        // 3. Input del usuario (interfaz gráfica)
        
        async function initFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pos-app';
            let config = null;

            // 1. Intentar variable de entorno
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    config = JSON.parse(__firebase_config);
                } catch(e) {}
            }

            // 2. Intentar configuración manual en código
            if ((!config || !config.apiKey) && manualConfig.apiKey) {
                config = manualConfig;
            }

            // 3. Si no hay config, mostrar pantalla de error/input
            if (!config || !config.apiKey) {
                document.getElementById('loader-spinner').classList.add('hidden');
                document.getElementById('loading-title').classList.add('hidden');
                document.getElementById('config-error-area').classList.remove('hidden');
                
                // Exponer función para guardar desde la UI
                window.saveManualConfig = () => {
                    const val = document.getElementById('manual-config-input').value;
                    try {
                        const parsed = JSON.parse(val);
                        if(parsed.apiKey) {
                            config = parsed;
                            startApp(config, appId);
                        } else {
                            window.alertMessage("Configuración inválida (Falta apiKey)", 'error');
                        }
                    } catch(e) {
                        window.alertMessage("Error de formato JSON: " + e.message, 'error');
                    }
                };
                return; // Detener hasta que el usuario ingrese datos
            }

            // Si tenemos config, arrancar
            startApp(config, appId);
        }

        function startApp(config, appId) {
            try {
                document.getElementById('config-error-area').classList.add('hidden');
                document.getElementById('loader-spinner').classList.remove('hidden');
                document.getElementById('loading-title').classList.remove('hidden');
                document.getElementById('loading-title').innerText = "Conectando...";

                app = initializeApp(config);
                db = getDatabase(app);
                auth = getAuth(app);
                
                setupAuthListeners(appId);
                
            } catch (e) {
                console.error("Firebase init error:", e);
                window.alertMessage("Error al conectar Firebase: " + e.message, 'error');
            }
        }

        // --- ESTADO GLOBAL ---
        let products = [];
        let cart = [];
        let orders = [];
        let currentOrder = null;
        const IVA_RATE = 0.15;
        const CURRENCY = "C$"; 

        // --- ELEMENTOS DOM ---
        const els = {
            loading: document.getElementById('loading-screen'),
            auth: document.getElementById('auth-screen'),
            app: document.getElementById('app-screen'),
            grid: document.getElementById('product-grid'),
            cartContainer: document.getElementById('cart-items'),
            cartSubtotal: document.getElementById('cart-subtotal'),
            cartTax: document.getElementById('cart-tax'),
            cartTotal: document.getElementById('cart-total'),
            cartCount: document.getElementById('cart-count'),
            checkoutBtn: document.getElementById('checkout-btn'),
            invTable: document.getElementById('inventory-table-body'),
            ordersTable: document.getElementById('orders-table-body'),
            search: document.getElementById('search-input'),
            catFilter: document.getElementById('category-filter'),
            mobileBadge: document.getElementById('mobile-cart-badge'),
            cartSidebar: document.getElementById('cart-sidebar'),
            authError: document.getElementById('auth-error-msg')
        };

        // --- SISTEMA DE NOTIFICACIONES ---
        window.alertMessage = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-100 border-green-400 text-green-800',
                error: 'bg-red-100 border-red-400 text-red-800',
                info: 'bg-blue-100 border-blue-400 text-blue-800'
            };
            toast.className = `flex items-center w-full max-w-xs p-4 rounded-lg shadow-lg border-l-4 transform transition-all duration-300 translate-x-full ${colors[type] || colors.info}`;
            toast.innerHTML = `
                <div class="flex-1 text-sm font-medium">${message}</div>
                <button onclick="this.parentElement.remove()" class="ml-2 opacity-50 hover:opacity-100"><i data-lucide="x" class="w-4 h-4"></i></button>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
            if(window.lucide) window.lucide.createIcons();
        };

        // --- HELPERS UI ---
        window.toggleModal = (id) => {
            const el = document.getElementById(id);
            if(!el) return;
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                setTimeout(() => el.firstElementChild.classList.remove('scale-95', 'opacity-0'), 10);
            } else {
                el.firstElementChild.classList.add('scale-95', 'opacity-0');
                setTimeout(() => el.classList.add('hidden'), 200);
            }
        };

        window.toggleTab = (tabId) => {
            ['products-view', 'inventory-view', 'orders-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
        };

        window.toggleCartMobile = () => {
            els.cartSidebar.classList.toggle('translate-x-full');
        };

        window.openProductModal = () => {
            window.resetProductForm();
            window.toggleModal('modal-product');
        }

        // --- LÓGICA DE DATOS ---
        function startDataListeners(uid, appId) {
            if (!db) return;
            const userRef = `artifacts/${appId}/users/${uid}`;
            
            // Productos
            onValue(ref(db, `${userRef}/products`), (snap) => {
                const data = snap.val();
                products = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                renderProductGrid();
                renderInventoryTable();
                updateCategoryFilter();
            });

            // Órdenes
            const ordersQuery = dbQuery(ref(db, `${userRef}/orders`), limitToLast(50));
            onValue(ordersQuery, (snap) => {
                const data = snap.val();
                orders = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse() : [];
                renderOrdersTable();
            });
        }

        // --- AUTH FLOW ---
        function setupAuthListeners(appId) {
            // Intento de login automático si hay token del sistema
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 signInWithCustomToken(auth, __initial_auth_token).catch(console.error);
            }

            onAuthStateChanged(auth, (user) => {
                els.loading.classList.add('hidden'); // App lista

                if (user) {
                    userId = user.uid;
                    userEmail = user.email || 'Invitado';
                    document.getElementById('user-info').innerText = userEmail;
                    
                    els.auth.classList.add('hidden');
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('orderId')) {
                        loadInvoiceData(urlParams.get('orderId'), appId);
                    } else {
                        els.app.classList.remove('hidden');
                    }

                    if (!appInitialized) {
                        startDataListeners(userId, appId);
                        appInitialized = true;
                    }
                } else {
                    els.auth.classList.remove('hidden');
                    els.app.classList.add('hidden');
                    products = [];
                    cart = [];
                    orders = [];
                    appInitialized = false;
                }
            });
        }

        // --- MANEJO FORMULARIOS LOGIN/REGISTRO ---
        const loginForm = document.getElementById('login-form');
        const regForm = document.getElementById('register-form');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            els.authError.classList.add('hidden');
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                els.authError.innerText = "Error: Credenciales inválidas";
                els.authError.classList.remove('hidden');
            }
        });

        regForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            els.authError.classList.add('hidden');
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
                window.alertMessage("¡Cuenta creada!", 'success');
                regForm.reset();
            } catch (error) {
                els.authError.innerText = error.message;
                els.authError.classList.remove('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            if(confirm("¿Seguro que desea salir?")) signOut(auth);
        });

        document.getElementById('show-register-btn').addEventListener('click', () => {
            loginForm.classList.add('hidden');
            regForm.classList.remove('hidden');
        });
        document.getElementById('cancel-reg-btn').addEventListener('click', () => {
            regForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        // --- FUNCIONES APP (PRODUCTOS, CART, ETC) ---
        function renderProductGrid() {
            let list = products;
            const term = els.search.value.toLowerCase();
            const cat = els.catFilter.value;
            if (term) list = list.filter(p => p.name.toLowerCase().includes(term));
            if (cat) list = list.filter(p => p.category === cat);

            if (list.length === 0) {
                els.grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center text-gray-400 mt-10"><i data-lucide="package-open" class="w-12 h-12 mb-2"></i><p>No se encontraron productos</p></div>`;
            } else {
                els.grid.innerHTML = list.map(p => `
                    <div onclick="addToCart('${p.id}')" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer hover:shadow-md hover:border-indigo-200 transition-all group relative">
                        ${p.stock <= 5 ? `<span class="absolute top-2 left-2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full z-10">Bajo Stock</span>` : ''}
                        <div class="h-32 bg-gray-50 flex items-center justify-center overflow-hidden">
                            ${p.imageUrl ? `<img src="${p.imageUrl}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/150?text=IMG'">` : `<i data-lucide="package" class="w-10 h-10 text-gray-300"></i>`}
                        </div>
                        <div class="p-3">
                            <h3 class="font-semibold text-gray-800 text-sm truncate" title="${p.name}">${p.name}</h3>
                            <div class="flex justify-between items-end mt-1">
                                <span class="text-lg font-bold text-indigo-600">${CURRENCY}${p.price.toFixed(2)}</span>
                                <span class="text-xs text-gray-400">Stock: ${p.stock}</span>
                            </div>
                        </div>
                    </div>`).join('');
            }
            if(window.lucide) window.lucide.createIcons();
        }

        function updateCategoryFilter() {
            const current = els.catFilter.value;
            const categories = [...new Set(products.map(p => p.category))].sort();
            const listHtml = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            els.catFilter.innerHTML = '<option value="">Todas</option>' + listHtml;
            document.getElementById('category-list').innerHTML = listHtml;
            els.catFilter.value = current;
        }

        els.search.addEventListener('input', renderProductGrid);
        els.catFilter.addEventListener('change', renderProductGrid);

        window.addToCart = (id) => {
            const prod = products.find(p => p.id === id);
            if (!prod) return;
            const existing = cart.find(i => i.id === id);
            const currentQty = existing ? existing.quantity : 0;
            if (currentQty + 1 > prod.stock) { window.alertMessage(`¡Solo quedan ${prod.stock}!`, 'error'); return; }
            if (existing) existing.quantity++;
            else cart.push({ ...prod, quantity: 1 });
            renderCart();
        };

        window.updateCartQty = (id, delta) => {
            const item = cart.find(i => i.id === id);
            if (!item) return;
            const prod = products.find(p => p.id === id);
            if (delta > 0 && item.quantity + 1 > prod.stock) { window.alertMessage("Stock insuficiente", 'error'); return; }
            item.quantity += delta;
            if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
            renderCart();
        };

        function renderCart() {
            let subtotal = 0, count = 0;
            if (cart.length === 0) {
                els.cartContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-48 text-gray-400"><i data-lucide="shopping-basket" class="w-10 h-10 mb-2 opacity-50"></i><p class="text-sm">Carrito vacío</p></div>`;
                els.checkoutBtn.disabled = true;
            } else {
                els.checkoutBtn.disabled = false;
                els.cartContainer.innerHTML = cart.map(item => {
                    subtotal += item.price * item.quantity;
                    count += item.quantity;
                    return `<div class="flex items-center justify-between p-2 bg-white border border-gray-100 rounded-lg shadow-sm">
                            <div class="flex-1 min-w-0 pr-2"><p class="font-medium text-gray-800 text-sm truncate">${item.name}</p><p class="text-xs text-indigo-600 font-semibold">${CURRENCY}${item.price.toFixed(2)}</p></div>
                            <div class="flex items-center bg-gray-50 rounded-lg p-1">
                                <button onclick="updateCartQty('${item.id}', -1)" class="p-1 hover:bg-white text-gray-600"><i data-lucide="minus" class="w-3 h-3"></i></button>
                                <span class="text-sm font-bold w-6 text-center">${item.quantity}</span>
                                <button onclick="updateCartQty('${item.id}', 1)" class="p-1 hover:bg-white text-gray-600"><i data-lucide="plus" class="w-3 h-3"></i></button>
                            </div>
                            <div class="text-right w-16"><span class="font-bold text-sm text-gray-700">${CURRENCY}${(item.price * item.quantity).toFixed(2)}</span></div>
                        </div>`;
                }).join('');
            }
            const tax = subtotal * IVA_RATE;
            els.cartSubtotal.innerText = `${CURRENCY}${subtotal.toFixed(2)}`;
            els.cartTax.innerText = `${CURRENCY}${tax.toFixed(2)}`;
            els.cartTotal.innerText = `${CURRENCY}${(subtotal + tax).toFixed(2)}`;
            els.cartCount.innerText = count;
            els.mobileBadge.innerText = count;
            els.mobileBadge.classList.toggle('hidden', count === 0);
            
            document.getElementById('checkout-total-display').innerText = `${CURRENCY}${(subtotal + tax).toFixed(2)}`;
            document.getElementById('checkout-paid').value = (subtotal + tax).toFixed(2);
            calculateChange();
            if(window.lucide) window.lucide.createIcons();
        }

        window.clearCart = () => { if(cart.length > 0 && confirm("¿Vaciar carrito?")) { cart = []; renderCart(); }};
        
        // --- CRUD ---
        window.resetProductForm = () => { document.getElementById('product-form').reset(); document.getElementById('product-id').value = ''; document.getElementById('delete-product-btn').classList.add('hidden'); document.getElementById('product-modal-title').innerText = 'Nuevo Producto'; };
        window.editProduct = (id) => { const p = products.find(x => x.id === id); if(!p) return; document.getElementById('product-id').value = p.id; const f = document.getElementById('product-form'); f.name.value = p.name; f.price.value = p.price; f.cost.value = p.cost; f.stock.value = p.stock; f.category.value = p.category; f.imageUrl.value = p.imageUrl || ''; document.getElementById('delete-product-btn').classList.remove('hidden'); document.getElementById('product-modal-title').innerText = 'Editar Producto'; window.toggleModal('modal-product'); };
        
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const f = e.target;
            const id = document.getElementById('product-id').value;
            const path = `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-pos-app'}/users/${userId}/products/${id || push(ref(db)).key}`;
            await set(ref(db, path), { name: f.name.value, price: parseFloat(f.price.value), cost: parseFloat(f.cost.value), stock: parseInt(f.stock.value), category: f.category.value, imageUrl: f.imageUrl.value });
            window.toggleModal('modal-product');
            window.alertMessage(id ? "Actualizado" : "Creado", 'success');
        });

        window.deleteProduct = async () => { const id = document.getElementById('product-id').value; if(id && confirm("¿Eliminar?")) { await remove(ref(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-pos-app'}/users/${userId}/products/${id}`)); window.toggleModal('modal-product'); }};
        
        function renderInventoryTable() { els.invTable.innerHTML = products.map(p => `<tr class="hover:bg-gray-50 border-b"><td class="px-6 py-4 text-sm font-medium text-gray-900">${p.name}</td><td class="px-6 py-4 text-sm text-gray-500">${CURRENCY}${p.price.toFixed(2)}</td><td class="px-6 py-4 text-sm ${p.stock<5?'text-red-600 font-bold':'text-gray-500'}">${p.stock}</td><td class="px-6 py-4 text-right"><button onclick="editProduct('${p.id}')" class="text-indigo-600 font-semibold">Editar</button></td></tr>`).join(''); }

        // --- CHECKOUT ---
        const checkoutPaidInput = document.getElementById('checkout-paid');
        const checkoutDiscInput = document.getElementById('checkout-discount-percent');
        const checkoutDelInput = document.getElementById('checkout-delivery');

        function calculateChange() {
            const total = parseFloat(document.getElementById('checkout-total-display').innerText.replace(CURRENCY,'')) || 0;
            const paid = parseFloat(checkoutPaidInput.value) || 0;
            const change = paid - total;
            const elChange = document.getElementById('checkout-change-display');
            elChange.innerText = `${CURRENCY}${change.toFixed(2)}`;
            elChange.className = `text-xl font-bold ${change < 0 ? 'text-red-500' : 'text-green-600'}`;
            document.getElementById('confirm-checkout-btn').disabled = change < 0;
        }

        function updateCheckoutTotals() {
            const subRaw = parseFloat(els.cartSubtotal.innerText.replace(CURRENCY,'')) || 0;
            const discPct = parseFloat(checkoutDiscInput.value) || 0;
            const delivery = parseFloat(checkoutDelInput.value) || 0;
            const subAfterDisc = subRaw - (subRaw * (discPct / 100));
            const final = subAfterDisc + (subAfterDisc * IVA_RATE) + delivery;
            document.getElementById('checkout-total-display').innerText = `${CURRENCY}${final.toFixed(2)}`;
            checkoutPaidInput.value = final.toFixed(2);
            calculateChange();
        }

        [checkoutDiscInput, checkoutDelInput].forEach(el => el.addEventListener('input', updateCheckoutTotals));
        checkoutPaidInput.addEventListener('input', calculateChange);

        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('confirm-checkout-btn');
            btn.disabled = true; btn.innerHTML = 'Procesando...';
            
            const subRaw = parseFloat(els.cartSubtotal.innerText.replace(CURRENCY,''));
            const discPct = parseFloat(checkoutDiscInput.value) || 0;
            const delivery = parseFloat(checkoutDelInput.value) || 0;
            const discAmt = subRaw * (discPct / 100);
            const tax = (subRaw - discAmt) * IVA_RATE;
            const total = (subRaw - discAmt) + tax + delivery;
            const paid = parseFloat(checkoutPaidInput.value);

            let error = null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pos-app';
            
            for (const item of cart) {
                try {
                    await runTransaction(ref(db, `artifacts/${appId}/users/${userId}/products/${item.id}`), (p) => {
                        if (p) {
                            if (p.stock < item.quantity) throw new Error();
                            p.stock -= item.quantity;
                        }
                        return p;
                    });
                } catch(err) { error = `Error stock: ${item.name}`; break; }
            }

            if (!error) {
                const order = { date: new Date().toISOString(), cart, subtotal: subRaw, tax, discount: discAmt, delivery, total, paid, change: paid - total, userName: userEmail };
                const newRef = push(ref(db, `artifacts/${appId}/users/${userId}/orders`));
                await set(newRef, order);
                cart = []; renderCart(); window.toggleModal('modal-checkout'); showInvoice({ id: newRef.key, ...order });
            } else { window.alertMessage(error, 'error'); }
            
            btn.disabled = false; btn.innerHTML = 'Confirmar';
        });

        // --- INVOICES ---
        function renderOrdersTable() { els.ordersTable.innerHTML = orders.map(o => `<tr class="hover:bg-gray-50 border-b"><td class="px-4 py-3 text-sm font-mono"><div class="font-bold">${o.id.slice(-6)}</div><div class="text-xs text-gray-400">${new Date(o.date).toLocaleDateString()}</div></td><td class="px-4 py-3 text-sm font-bold">${CURRENCY}${o.total.toFixed(2)}</td><td class="px-4 py-3"><button onclick="showOrderInvoice('${o.id}')" class="text-indigo-600"><i data-lucide="receipt" class="w-5 h-5"></i></button></td></tr>`).join(''); if(window.lucide) window.lucide.createIcons(); }
        window.showOrderInvoice = (id) => { const o = orders.find(x => x.id === id); if(o) showInvoice(o); };
        async function loadInvoiceData(id, appId) { 
            const snap = await get(ref(db, `artifacts/${appId}/users/${userId}/orders/${id}`));
            if(snap.exists()) { showInvoice({ id, ...snap.val() }); els.app.classList.add('hidden'); els.loading.classList.add('hidden'); }
            else els.loading.innerHTML = '<p class="text-red-500">Factura no encontrada</p>';
        }

        function showInvoice(o) {
            currentOrder = o;
            document.getElementById('inv-order-id').innerText = o.id.slice(-8).toUpperCase();
            document.getElementById('inv-date').innerText = new Date(o.date).toLocaleString();
            document.getElementById('inv-user').innerText = o.userName;
            document.getElementById('inv-items-body').innerHTML = o.cart.map(i => `<tr class="border-b border-gray-100"><td class="py-2 text-left">${i.name}</td><td class="py-2 text-center text-gray-500">${i.quantity}</td><td class="py-2 text-right">${CURRENCY}${(i.price * i.quantity).toFixed(2)}</td></tr>`).join('');
            document.getElementById('inv-subtotal').innerText = `${CURRENCY}${o.subtotal.toFixed(2)}`;
            document.getElementById('inv-tax').innerText = `${CURRENCY}${o.tax.toFixed(2)}`;
            document.getElementById('inv-total').innerText = `${CURRENCY}${o.total.toFixed(2)}`;
            document.getElementById('inv-paid').innerText = `${CURRENCY}${o.paid.toFixed(2)}`;
            document.getElementById('inv-change').innerText = `${CURRENCY}${o.change.toFixed(2)}`;
            document.getElementById('invoice-view').classList.remove('hidden');
        }

        window.closeInvoice = () => { document.getElementById('invoice-view').classList.add('hidden'); if(new URLSearchParams(window.location.search).get('orderId')) window.location.href = window.location.pathname; else els.app.classList.remove('hidden'); };
        window.copyInvoiceLink = () => { if(!currentOrder) return; const t = document.createElement('input'); t.value = `${window.location.origin}${window.location.pathname}?orderId=${currentOrder.id}`; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); window.alertMessage("Enlace copiado", 'success'); };

        window.addEventListener('load', () => { if(window.lucide) window.lucide.createIcons(); initFirebase(); });
    </script>
</body>
</html>


