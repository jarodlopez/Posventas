<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Sistema de Ventas (Unificado)</title>
    <!-- Tailwind CSS (Diseño rápido) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Estilos Propios de style.css */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body { font-family: 'Inter', sans-serif; }

        /* Estilos de Scrollbar más bonitos */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

        /* REGLAS CRÍTICAS PARA IMPRESIÓN */
        @media print {
            /* Ocultar todo lo que no sea la factura */
            body > *:not(#invoice-view) {
                display: none !important;
            }

            #invoice-view {
                position: absolute;
                top: 0; left: 0;
                width: 100%;
                height: 100%;
                background: white;
                display: block !important;
                overflow: visible;
                padding: 0;
                margin: 0;
                z-index: 9999;
            }

            #printable-area {
                box-shadow: none;
                max-width: 100%;
                width: 100%;
                margin: 0;
                padding: 20px;
            }

            /* Ocultar botones dentro de la vista de factura */
            .print\:hidden {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans overflow-hidden">

    <!-- Toast Container para mensajes -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2"></div>

    <!-- 1. PANTALLA DE LOGIN (Se muestra si no hay usuario) -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center mb-6 text-indigo-600">POS Login</h2>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="login-pass" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">Ingresar</button>
            </form>

            <form id="register-form" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="reg-email" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Contraseña (Mín. 6)</label>
                    <input type="password" id="reg-pass" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-150">Registrar Cuenta</button>
                <button type="button" id="cancel-reg-btn" class="w-full mt-2 text-sm text-gray-500 hover:text-gray-700">Cancelar</button>
            </form>

            <div class="mt-6 text-center">
                <button id="show-register-btn" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150">¿No tienes cuenta? Regístrate</button>
            </div>
        </div>
    </div>


    <!-- 2. APLICACIÓN PRINCIPAL (Se muestra si hay usuario) -->
    <div id="app-screen" class="h-screen flex flex-col hidden">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
            <h1 class="text-2xl font-bold text-indigo-700">POS Simple</h1>
            <div class="flex items-center space-x-4">
                <button onclick="toggleTab('products-view')" class="p-2 rounded-full text-gray-600 hover:bg-gray-100 transition duration-150" title="Productos">
                    <i data-lucide="layout-grid" class="w-6 h-6"></i>
                </button>
                <button onclick="toggleTab('inventory-view')" class="p-2 rounded-full text-gray-600 hover:bg-gray-100 transition duration-150" title="Inventario">
                    <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                </button>
                <button onclick="toggleTab('orders-view')" class="p-2 rounded-full text-gray-600 hover:bg-gray-100 transition duration-150" title="Órdenes">
                    <i data-lucide="history" class="w-6 h-6"></i>
                </button>
                <span id="user-info" class="text-sm text-gray-600"></span>
                <button id="logout-btn" class="flex items-center space-x-1 bg-red-100 text-red-600 px-3 py-1 rounded-full hover:bg-red-200 transition duration-150">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Salir</span>
                </button>
            </div>
        </header>

        <!-- Contenido principal: 3 columnas -->
        <main class="flex-1 flex overflow-hidden">
            
            <!-- Columna 1: Productos (Vista de Venta) -->
            <div id="products-view" class="flex-1 flex flex-col p-4 overflow-y-auto bg-white">
                <div class="flex space-x-2 mb-4">
                    <input id="search-input" type="text" placeholder="Buscar productos..." class="flex-1 border p-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <select id="category-filter" class="border p-2 rounded-lg">
                        <option value="">Todas las categorías</option>
                    </select>
                    <button onclick="toggleModal('modal-product'); resetProductForm();" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center space-x-1">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span>Añadir Producto</span>
                    </button>
                </div>
                
                <!-- Grid de Productos -->
                <div id="product-grid" class="flex-1 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto pb-4">
                    <!-- Los productos se inyectan aquí -->
                    <p class="text-center text-gray-500 col-span-full">Cargando productos...</p>
                </div>
            </div>

            <!-- Columna 2: Inventario (Vista de Gestión) -->
            <div id="inventory-view" class="flex-1 p-4 overflow-y-auto hidden">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Inventario y Precios</h2>
                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Venta</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Filas de inventario se inyectan aquí -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Columna 3: Historial de Órdenes -->
            <div id="orders-view" class="flex-1 p-4 overflow-y-auto hidden">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Historial de Órdenes de Venta</h2>
                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendió</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Filas de órdenes se inyectan aquí -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Columna 3 (Original): Carrito de Compras -->
            <div class="w-full md:w-96 bg-gray-50 border-l flex flex-col">
                <div class="p-4 border-b">
                    <h2 class="text-xl font-bold flex justify-between items-center">
                        Carrito <span id="cart-count" class="bg-indigo-600 text-white text-xs font-medium px-2 py-0.5 rounded-full">0</span>
                    </h2>
                </div>
                
                <!-- Items en el Carrito -->
                <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <p class="text-gray-500 text-sm text-center">Añada productos para comenzar una venta.</p>
                </div>

                <!-- Totales y Botón de Checkout -->
                <div class="p-4 bg-white border-t space-y-2">
                    <div class="flex justify-between font-medium text-sm">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal">$0.00</span>
                    </div>
                    <div class="flex justify-between font-medium text-sm">
                        <span>Impuestos (IVA 15%):</span>
                        <span id="cart-tax">$0.00</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg text-indigo-700">
                        <span>TOTAL:</span>
                        <span id="cart-total">$0.00</span>
                    </div>

                    <div class="flex space-x-2 pt-2">
                        <button onclick="clearCart()" class="flex-1 py-3 px-4 rounded-lg border text-red-600 font-semibold hover:bg-red-50 transition duration-150">
                            <i data-lucide="trash-2" class="w-5 h-5 inline mr-1"></i>
                        </button>
                        <!-- Botón Cobrar y Facturar (CRÍTICO) -->
                        <button id="checkout-btn" onclick="toggleModal('modal-checkout')" disabled class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-300">
                            Cobrar y Facturar
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- 3. MODAL: Agregar/Editar Producto -->
    <div id="modal-product" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="product-modal-title" class="text-2xl font-bold mb-4">Añadir Nuevo Producto</h2>
            <form id="product-form" class="space-y-3">
                <input type="hidden" id="product-id">
                
                <input required name="name" placeholder="Nombre del Producto" class="w-full border p-2 rounded-lg">
                
                <div class="grid grid-cols-2 gap-2">
                    <input required type="number" step="0.01" name="price" placeholder="Precio de Venta" class="w-full border p-2 rounded-lg">
                    <input required type="number" step="0.01" name="cost" placeholder="Costo Unitario" class="w-full border p-2 rounded-lg">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input required type="number" name="stock" placeholder="Stock Inicial" class="w-full border p-2 rounded-lg">
                    <input required name="category" placeholder="Categoría" class="w-full border p-2 rounded-lg">
                </div>
                <input name="imageUrl" placeholder="URL Imagen (Opcional)" class="w-full border p-2 rounded-lg">
                
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="toggleModal('modal-product')" class="flex-1 bg-gray-200 py-2 rounded-lg font-semibold hover:bg-gray-300">Cancelar</button>
                    <button type="submit" id="submit-product-btn" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">Guardar Producto</button>
                    <button type="button" id="delete-product-btn" onclick="deleteProduct()" class="bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 hidden">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 4. MODAL: Checkout/Cobro -->
    <div id="modal-checkout" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6 text-indigo-700">Detalles de Cobro</h2>
            
            <form id="checkout-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Descuento (%)</label>
                        <input type="number" id="checkout-discount-percent" value="0" min="0" max="100" class="w-full border p-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Costo de Envío</label>
                        <input type="number" step="0.01" id="checkout-delivery" value="0.00" min="0" class="w-full border p-2 rounded-lg">
                    </div>
                </div>

                <div class="flex justify-between font-semibold text-lg border-t pt-4">
                    <span>Total a Pagar:</span>
                    <span id="checkout-total-display" class="text-green-600">$0.00</span>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Monto Recibido ($)</label>
                    <input type="number" step="0.01" id="checkout-paid" value="0.00" min="0" required class="w-full border p-2 text-2xl font-bold rounded-lg text-indigo-700">
                </div>

                <div class="flex justify-between font-bold text-xl text-red-600">
                    <span>Cambio:</span>
                    <span id="checkout-change-display">$0.00</span>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button type="button" onclick="toggleModal('modal-checkout')" class="flex-1 bg-gray-200 py-3 rounded-lg font-semibold hover:bg-gray-300">Cancelar</button>
                    <button type="submit" id="confirm-checkout-btn" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition duration-150">
                        <i data-lucide="check" class="w-5 h-5 inline mr-1"></i> Confirmar Cobro
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 5. VISTA DE FACTURA (Oculta por defecto) -->
    <div id="invoice-view" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 hidden overflow-y-auto p-4">
        <div id="printable-area" class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto my-8 p-8">
            <div class="text-center mb-6">
                <h3 class="text-3xl font-extrabold text-indigo-700">Factura de Venta</h3>
                <p class="text-sm text-gray-500 mt-1">ID Orden: <span id="inv-order-id" class="font-mono"></span></p>
                <p class="text-xs text-gray-500 mt-1">Fecha: <span id="inv-date"></span></p>
            </div>

            <h4 class="text-lg font-semibold border-b pb-2 mb-2">Productos Vendidos</h4>
            <table class="w-full text-sm mb-4">
                <thead>
                    <tr class="font-bold text-left">
                        <th class="py-1">Producto</th>
                        <th class="py-1 text-right">Cant.</th>
                        <th class="py-1 text-right">Precio</th>
                        <th class="py-1 text-right">Total</th>
                    </tr>
                </thead>
                <tbody id="inv-items-body">
                    <!-- Items de factura inyectados aquí -->
                </tbody>
            </table>

            <div class="space-y-1 text-right border-t pt-2">
                <div class="flex justify-between" id="inv-row-subtotal">
                    <span class="font-medium">Subtotal:</span>
                    <span id="inv-subtotal" class="font-medium">$0.00</span>
                </div>
                <div class="flex justify-between" id="inv-row-tax">
                    <span class="font-medium">Impuestos (15%):</span>
                    <span id="inv-tax">$0.00</span>
                </div>
                <div class="flex justify-between hidden" id="inv-row-disc">
                    <span class="font-medium text-red-600">Descuento:</span>
                    <span id="inv-disc" class="font-medium text-red-600">-$0.00</span>
                </div>
                 <div class="flex justify-between hidden" id="inv-row-del">
                    <span class="font-medium text-indigo-600">Costo Envío:</span>
                    <span id="inv-del" class="font-medium text-indigo-600">+$0.00</span>
                </div>
                <div class="flex justify-between border-t mt-2 pt-2 text-xl font-bold text-green-700">
                    <span>TOTAL:</span>
                    <span id="inv-total">$0.00</span>
                </div>
            </div>
            
            <p class="text-center text-xs text-gray-400 mt-6">¡Gracias por su compra!</p>
            <p class="text-center text-xs text-gray-400">Atendido por: <span id="inv-user"></span></p>
        </div>

        <div class="fixed bottom-4 right-4 print:hidden flex space-x-3">
            <button onclick="window.print()" class="bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 transition duration-150 flex items-center space-x-2">
                <i data-lucide="printer" class="w-6 h-6"></i>
            </button>
            <button onclick="copyInvoiceLink()" class="bg-green-500 text-white p-3 rounded-full shadow-lg hover:bg-green-600 transition duration-150 flex items-center space-x-2">
                <i data-lucide="share-2" class="w-6 h-6"></i>
            </button>
            <button onclick="closeInvoice()" class="bg-gray-700 text-white p-3 rounded-full shadow-lg hover:bg-gray-800 transition duration-150 flex items-center space-x-2">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>


    <!-- 6. Scripts Unificados -->
    <script type="module">
        // --- 6.1. FIREBASE SETUP (UNIFICADO) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove, get, child, runTransaction, query as dbQuery, limitToLast } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // CONFIGURACIÓN DE FIREBASE Y VARIABLES GLOBALES
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pos-app';
        let auth;
        let db;
        let userId = null;
        let userEmail = 'Anónimo'; // Variable para mostrar en la factura
        let appInitialized = false;

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            // Esto es crucial para la seguridad
            window.setLogLevel('debug'); 
        } else {
            console.error("ERROR: Firebase configuration is missing.");
        }

        // --- 6.2. ESTADO GLOBAL y DOM ---
        let products = [];
        let cart = [];
        let orders = [];
        let currentOrder = null;
        const IVA_RATE = 0.15; // 15% de IVA

        const grid = document.getElementById('product-grid');
        const cartContainer = document.getElementById('cart-items');
        const cartSubtotalEl = document.getElementById('cart-subtotal');
        const cartTaxEl = document.getElementById('cart-tax');
        const cartTotalEl = document.getElementById('cart-total');
        const cartCountEl = document.getElementById('cart-count');
        const checkoutBtn = document.getElementById('checkout-btn');
        const productForm = document.getElementById('product-form');
        const invTableBody = document.getElementById('inventory-table-body');
        const ordersTableBody = document.getElementById('orders-table-body');
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutBtn = document.getElementById('logout-btn');
        const checkoutForm = document.getElementById('checkout-form');
        const checkoutTotalDisplay = document.getElementById('checkout-total-display');
        const checkoutPaidInput = document.getElementById('checkout-paid');
        const checkoutChangeDisplay = document.getElementById('checkout-change-display');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        
        // --- 6.3. UTILIDADES ---
        // Utilidad para crear mensajes Toast (sustituye a alert())
        window.alertMessage = (message, type = 'info', duration = 3000) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const baseClasses = "flex items-center w-full max-w-xs p-4 mb-4 rounded-lg shadow-md transition-opacity duration-300";
            let typeClasses = "";

            switch (type) {
                case 'success':
                    typeClasses = "bg-green-100 text-green-700 border-green-400 border";
                    break;
                case 'error':
                    typeClasses = "bg-red-100 text-red-700 border-red-400 border";
                    break;
                case 'info':
                default:
                    typeClasses = "bg-blue-100 text-blue-700 border-blue-400 border";
                    break;
            }

            toast.className = `${baseClasses} ${typeClasses} opacity-0`;
            toast.innerHTML = `
                <div class="text-sm font-semibold flex-1">${message}</div>
                <button type="button" class="ml-auto text-gray-500 hover:text-gray-700" onclick="this.closest('div').remove()">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            container.appendChild(toast);
            
            // Animación de entrada
            setTimeout(() => toast.classList.remove('opacity-0'), 10);

            // Auto-cierre
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, duration);
            
            // Re-renderizar iconos de Lucide
            if(window.lucide) window.lucide.createIcons();
        };
        window.nonBlockingAlert = window.alertMessage; // Alias

        // Funciones UI Globales (accesibles desde HTML)
        window.toggleModal = (id) => {
            const el = document.getElementById(id);
            if(el) el.classList.toggle('hidden');
            // Asegurar que el focus esté en el primer input al abrir el modal de producto
            if (id === 'modal-product' && !el.classList.contains('hidden')) {
                document.querySelector('#product-form [name="name"]').focus();
            }
        };

        window.toggleTab = (tabId) => {
            const views = ['products-view', 'inventory-view', 'orders-view'];
            views.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
        };

        // --- 6.4. MANEJO DE AUTENTICACIÓN Y LISTENERS (CORRECCIÓN CRÍTICA) ---
        
        // Función para inicializar los listeners de la base de datos (se llama SOLO después de login)
        function startDataListeners(uid) {
            if (!db) return; // Si la base de datos no está inicializada, salir

            // Rutas de datos (colecciones privadas por usuario, como lo exigen las reglas)
            const productsRef = ref(db, `artifacts/${appId}/users/${uid}/products`);
            const ordersRef = ref(db, `artifacts/${appId}/users/${uid}/orders`);
            
            // 1. Escuchar Productos en Tiempo Real
            onValue(productsRef, (snapshot) => {
                const data = snapshot.val();
                products = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                renderProductGrid();
                renderInventoryTable();
                updateCategoryFilter();
            }, (error) => {
                window.alertMessage("Error al cargar productos: " + error.message, 'error');
                console.error("Firebase Read Error (Products):", error);
            });

            // 2. Escuchar Órdenes en Tiempo Real (usando limitToLast para eficiencia)
            // Se usa dbQuery para poder usar la función limitToLast
            const recentOrdersQuery = dbQuery(ordersRef, limitToLast(50));
            onValue(recentOrdersQuery, (snapshot) => {
                const data = snapshot.val();
                orders = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse() : [];
                renderOrdersTable();
            }, (error) => {
                window.alertMessage("Error al cargar órdenes: " + error.message, 'error');
                console.error("Firebase Read Error (Orders):", error);
            });
        }

        // 3. Inicialización y manejo de estado de Auth
        async function initializeAuth() {
            if (!auth || appInitialized) return;
            
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Inicio de sesión con token personalizado exitoso.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Inicio de sesión anónimo exitoso.");
                }
            } catch (error) {
                console.error("Error en la autenticación inicial. Se necesita login manual.", error.message);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario logueado: INICIAR APP
                userId = user.uid;
                userEmail = user.email || 'Usuario Anónimo';
                document.getElementById('user-info').innerText = userEmail;

                authScreen.classList.add('hidden');
                
                // CRÍTICO: Iniciar listeners de datos solo cuando el usuario está autenticado
                if (!appInitialized) {
                    startDataListeners(userId);
                    appInitialized = true;
                }

                // Revisar si estamos viendo una factura pública por URL
                const urlParams = new URLSearchParams(window.location.search);
                if(!urlParams.get('orderId')) {
                    appScreen.classList.remove('hidden');
                } else {
                     // Si hay orderId, ocultar la app principal y esperar a que se cargue la factura
                }

            } else {
                // Usuario no logueado: Mostrar LOGIN
                authScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                
                // Si estamos en modo factura, esto no debería ocurrir, pero lo forzamos a cargar la app si es necesario
            }
            // Después de resolver la autenticación, verificar URL para facturas
            checkUrlForInvoice(); 
        });

        // 4. Handlers de formularios de Auth
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            
            signInWithEmailAndPassword(auth, email, pass)
                .catch((error) => window.alertMessage("Error de inicio de sesión: " + error.message, 'error'));
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;

            createUserWithEmailAndPassword(auth, email, pass)
                .then(() => {
                    window.alertMessage("Usuario creado. Ingresando...", 'success');
                    registerForm.reset();
                })
                .catch((error) => window.alertMessage("Error de registro: " + error.message, 'error'));
        });

        logoutBtn.addEventListener('click', () => {
             // Reemplazo simple de confirm() con una alerta informativa
            window.alertMessage("Cerrando sesión. Por favor, espere.", 'info');
            signOut(auth).catch((error) => window.alertMessage("Error al cerrar sesión: " + error.message, 'error'));
        });

        // UI Alternar registro
        document.getElementById('show-register-btn').addEventListener('click', () => {
            document.getElementById('login-form').classList.add('hidden');
            registerForm.classList.remove('hidden');
        });
        document.getElementById('cancel-reg-btn').addEventListener('click', () => {
            registerForm.classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        });

        // Llamar a la función de inicialización de la autenticación
        initializeAuth();
        
        // --- 6.5. LÓGICA DEL TPV (PRODUCTOS Y CARRITO) ---

        // Función para renderizar la cuadrícula de productos (vista de venta)
        function renderProductGrid() {
            let filteredProducts = products;
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;

            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.category.toLowerCase().includes(searchTerm)
                );
            }

            if (selectedCategory) {
                filteredProducts = filteredProducts.filter(p => p.category === selectedCategory);
            }

            if (filteredProducts.length === 0) {
                grid.innerHTML = `<p class="text-center text-gray-500 col-span-full">${products.length === 0 ? 'Aún no hay productos.' : 'No se encontraron productos.'}</p>`;
                return;
            }

            grid.innerHTML = filteredProducts.map(p => `
                <div onclick="addToCart('${p.id}')" 
                     class="bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition duration-200 transform hover:-translate-y-0.5 relative group">
                    
                    ${p.stock <= 5 ? `<span class="absolute top-2 left-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full z-10">Stock Bajo! (${p.stock})</span>` : ''}

                    <div class="h-32 bg-gray-200 flex items-center justify-center p-2" 
                         style="background-image: url('${p.imageUrl || 'https://placehold.co/150x150/E5E7EB/6B7280?text=SIN+IMG'}'); background-size: cover; background-position: center;">
                    </div>
                    
                    <div class="p-3">
                        <h3 class="font-semibold text-gray-800 truncate">${p.name}</h3>
                        <p class="text-xl font-bold text-indigo-600 mt-1">$${p.price.toFixed(2)}</p>
                    </div>
                </div>
            `).join('');
            
            // Re-renderizar iconos de Lucide (si se usaran en el grid)
            if(window.lucide) window.lucide.createIcons();
        }
        
        // Función para actualizar el filtro de categorías
        function updateCategoryFilter() {
            const categories = [...new Set(products.map(p => p.category))].sort();
            categoryFilter.innerHTML = '<option value="">Todas las categorías</option>';
            categoryFilter.innerHTML += categories.map(c => 
                `<option value="${c}">${c}</option>`
            ).join('');
        }

        // Listeners para búsqueda y filtro
        searchInput.addEventListener('input', renderProductGrid);
        categoryFilter.addEventListener('change', renderProductGrid);

        // Función para añadir producto al carrito
        window.addToCart = (productId) => {
            const product = products.find(p => p.id === productId);
            if (!product) {
                window.alertMessage("Error: Producto no encontrado.", 'error');
                return;
            }

            const cartItem = cart.find(item => item.id === productId);

            if (cartItem) {
                if (cartItem.quantity < product.stock) {
                    cartItem.quantity++;
                } else {
                    window.alertMessage("Stock insuficiente para añadir más.", 'error');
                }
            } else {
                if (product.stock > 0) {
                    cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        cost: product.cost,
                        quantity: 1,
                    });
                } else {
                    window.alertMessage("Producto agotado.", 'error');
                }
            }
            renderCart();
        };

        // Función para actualizar la cantidad del producto en el carrito
        window.updateCartQuantity = (productId, change) => {
            const cartItem = cart.find(item => item.id === productId);
            if (!cartItem) return;

            const product = products.find(p => p.id === productId);

            if (change === 'add') {
                if (cartItem.quantity < product.stock) {
                    cartItem.quantity++;
                } else {
                    window.alertMessage("Stock insuficiente.", 'error');
                }
            } else if (change === 'subtract') {
                cartItem.quantity--;
            }

            if (cartItem.quantity <= 0) {
                cart = cart.filter(item => item.id !== productId);
            }
            renderCart();
        };

        // Función para renderizar el carrito
        function renderCart() {
            if (cart.length === 0) {
                cartContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">Añada productos para comenzar una venta.</p>';
                cartSubtotalEl.innerText = '$0.00';
                cartTaxEl.innerText = '$0.00';
                cartTotalEl.innerText = '$0.00';
                cartCountEl.innerText = '0';
                checkoutBtn.disabled = true; // Deshabilitar el botón de cobro
                return;
            }

            checkoutBtn.disabled = false; // Habilitar el botón de cobro

            let subtotal = 0;
            let totalItems = 0;

            cartContainer.innerHTML = cart.map(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                totalItems += item.quantity;

                return `
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg shadow-sm">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-800 truncate">${item.name}</p>
                            <p class="text-sm text-indigo-600 font-semibold">$${item.price.toFixed(2)} c/u</p>
                        </div>
                        <div class="flex items-center space-x-1 ml-2">
                            <button onclick="updateCartQuantity('${item.id}', 'subtract')" class="p-1 text-gray-600 hover:bg-gray-100 rounded-full" title="Menos">
                                <i data-lucide="minus" class="w-4 h-4"></i>
                            </button>
                            <span class="font-bold w-6 text-center">${item.quantity}</span>
                            <button onclick="updateCartQuantity('${item.id}', 'add')" class="p-1 text-gray-600 hover:bg-gray-100 rounded-full" title="Más">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <span class="font-bold ml-4 w-16 text-right">$${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            }).join('');

            // Recalcular Totales
            const tax = subtotal * IVA_RATE;
            const total = subtotal + tax;

            cartSubtotalEl.innerText = `$${subtotal.toFixed(2)}`;
            cartTaxEl.innerText = `$${tax.toFixed(2)}`;
            cartTotalEl.innerText = `$${total.toFixed(2)}`;
            cartCountEl.innerText = totalItems.toString();
            
            // Actualizar modal de checkout
            document.getElementById('checkout-total-display').innerText = `$${total.toFixed(2)}`;
            document.getElementById('checkout-paid').value = total.toFixed(2);
            calculateChange();

            if(window.lucide) window.lucide.createIcons();
        }

        // Función para vaciar el carrito
        window.clearCart = () => {
            if (cart.length > 0) {
                 if (window.confirm("¿Estás seguro de que quieres vaciar el carrito?")) { // Usamos confirm para acción destructiva
                    cart = [];
                    renderCart();
                    window.alertMessage("Carrito vaciado.", 'info');
                 }
            }
        };

        // --- 6.6. GESTIÓN DE PRODUCTOS (CRUD) ---

        // Abrir modal de edición
        window.editProduct = (productId) => {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('product-modal-title').innerText = 'Editar Producto';
            document.getElementById('product-id').value = product.id;
            document.querySelector('#product-form [name="name"]').value = product.name;
            document.querySelector('#product-form [name="price"]').value = product.price;
            document.querySelector('#product-form [name="cost"]').value = product.cost;
            document.querySelector('#product-form [name="stock"]').value = product.stock;
            document.querySelector('#product-form [name="category"]').value = product.category;
            document.querySelector('#product-form [name="imageUrl"]').value = product.imageUrl || '';
            
            document.getElementById('delete-product-btn').classList.remove('hidden');
            document.getElementById('submit-product-btn').innerText = 'Actualizar';
            window.toggleModal('modal-product');
        };

        // Resetear formulario (para añadir nuevo producto)
        window.resetProductForm = () => {
            document.getElementById('product-modal-title').innerText = 'Añadir Nuevo Producto';
            productForm.reset();
            document.getElementById('product-id').value = '';
            document.getElementById('delete-product-btn').classList.add('hidden');
            document.getElementById('submit-product-btn').innerText = 'Guardar Producto';
        };

        // Guardar/Actualizar producto
        productForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!userId) {
                window.alertMessage("Debe iniciar sesión para gestionar productos.", 'error');
                return;
            }
            
            const form = e.target;
            const productId = document.getElementById('product-id').value;
            
            const data = {
                name: form.elements['name'].value,
                price: parseFloat(form.elements['price'].value),
                cost: parseFloat(form.elements['cost'].value),
                stock: parseInt(form.elements['stock'].value),
                category: form.elements['category'].value,
                imageUrl: form.elements['imageUrl'].value || null,
            };

            const productPath = `artifacts/${appId}/users/${userId}/products/${productId || push(ref(db)).key}`;
            
            set(ref(db, productPath), data)
                .then(() => {
                    window.alertMessage(productId ? "Producto actualizado con éxito." : "Producto añadido con éxito.", 'success');
                    window.toggleModal('modal-product');
                    resetProductForm();
                })
                .catch((error) => {
                    window.alertMessage("Error al guardar producto: " + error.message, 'error');
                    console.error("Error al guardar producto:", error);
                });
        });

        // Eliminar producto
        window.deleteProduct = () => {
            const productId = document.getElementById('product-id').value;
            if (!productId) return;
            
            if (window.confirm("¿Seguro que desea eliminar este producto?")) {
                const productPath = `artifacts/${appId}/users/${userId}/products/${productId}`;
                
                remove(ref(db, productPath))
                    .then(() => {
                        window.alertMessage("Producto eliminado con éxito.", 'success');
                        window.toggleModal('modal-product');
                        resetProductForm();
                    })
                    .catch((error) => {
                        window.alertMessage("Error al eliminar producto: " + error.message, 'error');
                        console.error("Error al eliminar producto:", error);
                    });
            }
        };

        // Renderizar tabla de inventario (vista de gestión)
        function renderInventoryTable() {
            invTableBody.innerHTML = products.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">$${p.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${p.stock <= 5 ? 'text-red-600 font-bold' : 'text-gray-500'}">${p.stock}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editProduct('${p.id}')" class="text-indigo-600 hover:text-indigo-900 transition duration-150" title="Editar">
                            <i data-lucide="pencil" class="w-5 h-5 inline"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            if(window.lucide) window.lucide.createIcons();
        }

        // --- 6.7. LÓGICA DE CHECKOUT Y TRANSACCIONES ---

        // Función para calcular el cambio en el modal de checkout
        function calculateChange() {
            const totalText = cartTotalEl.innerText.replace('$', '');
            const total = parseFloat(totalText) || 0;
            const paid = parseFloat(checkoutPaidInput.value) || 0;
            const change = paid - total;

            checkoutTotalDisplay.innerText = `$${total.toFixed(2)}`;
            checkoutChangeDisplay.innerText = `$${change.toFixed(2)}`;
            checkoutChangeDisplay.classList.toggle('text-red-600', change < 0);
            checkoutChangeDisplay.classList.toggle('text-green-600', change >= 0);
            document.getElementById('confirm-checkout-btn').disabled = change < 0;
        }

        // Escuchar cambios en los inputs del modal de checkout
        document.getElementById('checkout-discount-percent').addEventListener('input', updateCheckoutCalculations);
        document.getElementById('checkout-delivery').addEventListener('input', updateCheckoutCalculations);
        checkoutPaidInput.addEventListener('input', calculateChange);

        function updateCheckoutCalculations() {
            const subtotalText = cartSubtotalEl.innerText.replace('$', '');
            let subtotal = parseFloat(subtotalText) || 0;
            
            const discountPercent = parseFloat(document.getElementById('checkout-discount-percent').value) || 0;
            const delivery = parseFloat(document.getElementById('checkout-delivery').value) || 0;

            const discountAmount = subtotal * (discountPercent / 100);
            
            // Subtotal después de descuento
            const subtotalAfterDiscount = subtotal - discountAmount;
            
            // Impuestos (IVA 15% sobre el subtotal después de descuento)
            const tax = subtotalAfterDiscount * IVA_RATE;
            
            // Total final
            const total = subtotalAfterDiscount + tax + delivery;

            // Actualizar Totales del Carrito (solo visual en el modal, no en la barra lateral)
            checkoutTotalDisplay.innerText = `$${total.toFixed(2)}`;
            checkoutPaidInput.value = total.toFixed(2); // Ajustar el monto pagado por defecto
            
            calculateChange();
        }


        // Finalizar Checkout (Transacción CRÍTICA)
        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId || cart.length === 0) return;

            const confirmBtn = document.getElementById('confirm-checkout-btn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 inline mr-1 animate-spin"></i> Procesando...';
            if(window.lucide) window.lucide.createIcons();

            // 1. Recalcular totales con descuentos/delivery
            const subtotal = parseFloat(cartSubtotalEl.innerText.replace('$', ''));
            const tax = parseFloat(cartTaxEl.innerText.replace('$', ''));
            const discountPercent = parseFloat(document.getElementById('checkout-discount-percent').value) || 0;
            const delivery = parseFloat(document.getElementById('checkout-delivery').value) || 0;
            
            const discountAmount = subtotal * (discountPercent / 100);
            const total = subtotal + tax - discountAmount + delivery;
            const paid = parseFloat(checkoutPaidInput.value) || 0;
            const change = paid - total;

            const orderId = push(ref(db, `artifacts/${appId}/users/${userId}/orders`)).key;
            const updates = {};
            let transactionError = false;

            // 2. Ejecutar Transacciones de Stock para CADA artículo del carrito
            for (const item of cart) {
                const productRef = ref(db, `artifacts/${appId}/users/${userId}/products/${item.id}`);

                await runTransaction(productRef, (currentProduct) => {
                    if (currentProduct) {
                        const newStock = currentProduct.stock - item.quantity;
                        if (newStock < 0) {
                            // Falla la transacción
                            transactionError = `Stock insuficiente para ${item.name}. Disponible: ${currentProduct.stock}`;
                            return; // Aborta la transacción
                        }
                        // Actualiza el stock
                        currentProduct.stock = newStock;
                        return currentProduct;
                    } else {
                        // Falla la transacción
                        transactionError = `Producto ${item.name} no existe en inventario.`;
                        return; // Aborta la transacción
                    }
                }, {
                    maxRetries: 3
                }).catch(error => {
                    console.error("Error de Transacción (Stock):", error);
                    transactionError = `Error de red al actualizar stock de ${item.name}. Intente de nuevo.`;
                });

                if (transactionError) break; // Si falla una transacción, salimos del loop
            }

            // 3. Si las transacciones de stock fueron exitosas, guardar la orden
            if (!transactionError) {
                const newOrder = {
                    date: new Date().toISOString(),
                    cart: cart.map(item => ({ 
                        id: item.id, 
                        name: item.name, 
                        price: item.price, 
                        quantity: item.quantity,
                        cost: item.cost // Guardar el costo para reportes futuros
                    })),
                    subtotal: subtotal,
                    tax: tax,
                    discount: discountAmount,
                    delivery: delivery,
                    total: total,
                    paid: paid,
                    change: change,
                    userId: userId,
                    userName: userEmail,
                };
                
                updates[`artifacts/${appId}/users/${userId}/orders/${orderId}`] = newOrder;

                try {
                    await update(ref(db), updates);
                    window.alertMessage("¡Venta finalizada con éxito!", 'success');
                    
                    // Mostrar factura
                    currentOrder = { id: orderId, ...newOrder };
                    showInvoice(currentOrder);

                    // Limpiar
                    cart = [];
                    renderCart();
                    window.toggleModal('modal-checkout');
                } catch (error) {
                    window.alertMessage("Error al guardar la orden: " + error.message, 'error');
                    console.error("Error al guardar la orden:", error);
                }
            } else {
                // Si hubo error, notificar y mantener el carrito intacto
                window.alertMessage(transactionError, 'error', 5000);
            }

            // Resetear el botón
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i data-lucide="check" class="w-5 h-5 inline mr-1"></i> Confirmar Cobro';
            if(window.lucide) window.lucide.createIcons();
        });

        // --- 6.8. GESTIÓN DE ÓRDENES Y FACTURAS ---

        // Renderizar tabla de historial de órdenes
        function renderOrdersTable() {
            ordersTableBody.innerHTML = orders.map(o => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono">${o.id.substring(0, 8)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(o.date).toLocaleDateString('es-ES')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-700">$${o.total.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${o.userName || o.userId.substring(0, 8)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="showOrderInvoice('${o.id}')" class="text-indigo-600 hover:text-indigo-900 transition duration-150" title="Ver Factura">
                            <i data-lucide="receipt" class="w-5 h-5 inline"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            if(window.lucide) window.lucide.createIcons();
        }

        // Cargar datos de la factura (para historial o URL)
        window.showOrderInvoice = (orderId) => {
             const order = orders.find(o => o.id === orderId);
             if (order) {
                 currentOrder = order;
                 showInvoice(order);
             } else {
                 // Si no está en el estado local, intentar cargar por ID (e.g. desde URL)
                 loadInvoiceData(orderId);
             }
        };


        async function loadInvoiceData(orderId) {
            if (!db || !userId) {
                // Esto ocurrirá si se accede por URL antes de que se complete la autenticación.
                // El onAuthStateChanged se encargará de reintentar la llamada.
                return; 
            }
            
            const orderRef = ref(db, `artifacts/${appId}/users/${userId}/orders/${orderId}`);
            try {
                const snapshot = await get(orderRef);
                if (snapshot.exists()) {
                    const orderData = { id: orderId, ...snapshot.val() };
                    currentOrder = orderData;
                    showInvoice(orderData);
                    document.getElementById('app-screen').classList.add('hidden'); // Asegura que solo se ve la factura
                } else {
                    window.alertMessage("Error: Factura no encontrada.", 'error');
                }
            } catch (error) {
                window.alertMessage("Error al cargar la factura: " + error.message, 'error');
                console.error("Error al cargar factura:", error);
            }
        }
        
        // Verifica si hay un orderId en la URL al cargar la página
        function checkUrlForInvoice() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            
            if (orderId && userId) { // Solo si hay ID y ya se tiene un userId
                loadInvoiceData(orderId);
            }
        }


        // Mostrar la factura en el modal/vista
        function showInvoice(order) {
            document.getElementById('inv-order-id').innerText = order.id;
            document.getElementById('inv-date').innerText = new Date(order.date).toLocaleString('es-ES');
            document.getElementById('inv-user').innerText = order.userName || 'Desconocido';
            document.getElementById('inv-tax').innerText = `$${order.tax.toFixed(2)}`;

            document.getElementById('inv-items-body').innerHTML = order.cart.map(item => `
                <tr>
                    <td class="py-1">${item.name}</td>
                    <td class="py-1 text-right">${item.quantity}</td>
                    <td class="py-1 text-right">$${item.price.toFixed(2)}</td>
                    <td class="py-1 text-right">$${(item.price * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('');

            document.getElementById('inv-subtotal').innerText = `$${order.subtotal.toFixed(2)}`;
            document.getElementById('inv-total').innerText = `$${order.total.toFixed(2)}`;

            // Manejar visualización de descuento/delivery si existen
            const discRow = document.getElementById('inv-row-disc');
            if(order.discount > 0) {
                discRow.classList.remove('hidden');
                document.getElementById('inv-disc').innerText = `-$${order.discount.toFixed(2)}`;
            } else {
                discRow.classList.add('hidden');
            }

            const delRow = document.getElementById('inv-row-del');
            if(order.delivery > 0) {
                delRow.classList.remove('hidden');
                document.getElementById('inv-del').innerText = `+$${order.delivery.toFixed(2)}`;
            } else {
                delRow.classList.add('hidden');
            }

            document.getElementById('invoice-view').classList.remove('hidden');
            if(window.lucide) window.lucide.createIcons();
        }

        // Cerrar la vista de factura
        window.closeInvoice = () => {
            document.getElementById('invoice-view').classList.add('hidden');
            // Si vinimos por URL, redirigir al inicio limpio
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('orderId')) {
                window.location.href = window.location.pathname;
            } else {
                // Volver a mostrar la app principal si estaba oculta
                document.getElementById('app-screen').classList.remove('hidden'); 
            }
        };

        // Copiar enlace de factura (para compartir)
        window.copyInvoiceLink = () => {
            if(!currentOrder) return;
            // IMPORTANTE: El link debe ser la URL actual con el orderId en los parámetros
            const url = `${window.location.origin}${window.location.pathname}?orderId=${currentOrder.id}`;
            
            // Usar execCommand('copy') como fallback para entornos sandboxed
            const tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            tempInput.value = url;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            window.alertMessage("Enlace de factura copiado al portapapeles.", 'success');
        };

        // Inicialización final de iconos
        window.addEventListener('load', () => {
            if(window.lucide) window.lucide.createIcons();
            // checkUrlForInvoice() se llama después de onAuthStateChanged
        });
        
    </script>
</body>
</html>

